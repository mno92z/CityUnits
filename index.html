<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004d40">

    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --white: #ffffff; --sold-bg: #e0f2f1; --sold-border: #00bfa5; --danger: #d32f2f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select, textarea { font-size: 16px; outline: none; font-family: inherit; }
        .container { max-width: 100%; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; transition: opacity 0.5s; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙƒØ¨Ø± Ù…Ø¹ Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ */
        #imageViewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        #fullImage { max-width: 95%; max-height: 80vh; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.1); object-fit: contain; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø±Ø¶ */
        .viewer-btn { position: absolute; top: 20px; color: white; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10001; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); transition: 0.2s; }
        .viewer-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
        .close-viewer { right: 20px; }
        .download-btn { left: 20px; }

        /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 30px; background: linear-gradient(135deg, var(--primary), #00251a); color: white; text-align: center; min-height: 100vh; }
        .login-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.9); color: #333; font-weight: bold; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: var(--primary); font-weight: 900; border: none; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminDashboard { display: none; padding: 20px; }
        .top-bar { position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 10px 0; display: flex; gap: 10px; flex-direction: column; }
        .search-input { width: 100%; padding: 15px; border-radius: 50px; border: 1px solid #ddd; font-size: 16px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .super-admin-btn { background: #333; color: var(--accent); border: 1px solid var(--accent); padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; display: none; }
        
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding-bottom: 80px; margin-top: 10px; }
        .unit-card { background: white; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; position: relative; }
        .unit-card.sold { border-color: var(--sold-border); background: var(--sold-bg); }
        .unit-card h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .unit-card small { color: #888; font-size: 11px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notify-dot { position: absolute; top: -5px; right: -5px; width: 15px; height: 15px; background: red; border-radius: 50%; border: 2px solid white; display: none; }
        .has-request .notify-dot { display: block; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆØ­Ø¯Ø© */
        #unitInterface { display: none; background: white; min-height: 100vh; padding-bottom: 80px; }
        .unit-header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        .stats-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 0 20px 20px; scrollbar-width: none; }
        .stat-card { min-width: 150px; padding: 15px; border-radius: 15px; color: white; flex-shrink: 0; }
        .bg-1 { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .bg-2 { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .bg-3 { background: linear-gradient(45deg, #4CAF50, #388E3C); }

        .tabs-nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; scrollbar-width: none; }
        .tab-btn { padding: 10px 15px; background: none; border: none; white-space: nowrap; color: #666; font-weight: bold; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--accent); }
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s; }
        
        .table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; }

        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .st-pending { background: #fff3cd; color: #856404; }
        .st-approved { background: #d4edda; color: #155724; }
        .st-rejected { background: #f8d7da; color: #721c24; }
        .visit-action-btn { border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin: 0 2px; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }

        .media-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .media-item { 
            background: #fff; border-radius: 10px; height: 160px; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden; border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .media-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: 0.3s; }
        .media-item img:active { transform: scale(0.95); }
        
        .fab-add { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none; align-items: center; justify-content: center; }
        
        label { font-size: 13px; color: #666; font-weight: bold; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-sheet { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { flex: 2; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; }
        .btn-cancel { flex: 1; padding: 12px; background: #eee; color: #333; border: none; border-radius: 10px; font-weight: bold; }

        /* Manage Admins Modal */
        #adminsModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:150; padding:20px; overflow-y:auto; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .admin-badge { background: #333; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        
        /* ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¸Ù‡ÙˆØ± */
        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
        /* Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ØªÙÙŠØ¯ØŒ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙƒÙˆÙ† Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ø´ÙƒÙ„ÙŠØ§Ù‹ */
        .unit-interface:not(.show-admin) .editable { pointer-events: none; background: #eee; }
    
        /* ===== V12 Sidebar ===== */
        .header-row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
        .menu-btn{width:46px; height:46px; border-radius:14px; border:1px solid #ddd; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05); cursor:pointer; font-size:22px;}
        .section-pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid #ddd; font-weight:800; color:var(--primary);}
        #sideOverlay{position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:300; display:none;}
        #sideDrawer{position:absolute; top:0; right:0; height:100%; width:min(86vw, 360px); background:#fff; border-radius:0 0 0 22px; box-shadow:-10px 0 30px rgba(0,0,0,0.12); padding:18px; transform:translateX(0);}
        .side-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px;}
        .side-title{font-weight:900; color:var(--primary); font-size:16px;}
        .side-close{background:#f2f2f2; border:1px solid #ddd; width:42px; height:42px; border-radius:14px; cursor:pointer; font-size:18px;}
        .side-list{display:flex; flex-direction:column; gap:8px;}
        .side-item{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 12px; border-radius:16px; border:1px solid #eee; background:#fff; cursor:pointer; font-weight:800;}
        .side-item:active{transform:scale(0.99)}
        .side-item .ico{font-size:18px}
        .side-item.active{border-color:var(--accent); background:#e0f2f1}
        .side-sub{font-size:12px; opacity:0.75; font-weight:700;}
        .badge{min-width:26px; height:22px; padding:0 8px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; background:#f1f1f1; font-size:12px; font-weight:900;}
        .badge.blue{background:#e3f2fd; color:#1565c0}
        .badge.orange{background:#fff3e0; color:#ef6c00}
        .badge.red{background:#ffebee; color:#c62828}
        .panel{display:none;}
        .panel.active{display:block;}
        .list-card{background:#fff; border:1px solid #eee; border-radius:16px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,0.04); margin:10px 0;}
        .mini{font-size:12px; opacity:.8}
    
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="loader"></div>
    <p style="margin-top:20px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
</div>

<div id="imageViewer">
    <div class="viewer-btn close-viewer" onclick="document.getElementById('imageViewer').style.display='none'">Ã—</div>
    <div class="viewer-btn download-btn" onclick="downloadCurrentImage()">â¬‡</div>
    <img id="fullImage" src="">
</div>

<div id="loginScreen" style="display:none;">
    <div style="margin-bottom: 30px;">
        <h1 style="margin:0;">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h1>
        <p style="opacity:0.8;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
    </div>
    <div class="login-box">
        <input type="text" id="loginUser" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©) Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
        <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminDashboard">
    <div class="top-bar">
        <div class="header-row">
            <button class="menu-btn" id="btnMenu" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
            <div class="section-pill" id="currentSectionPill">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <button class="super-admin-btn" id="btnManageAdmins" onclick="openAdminsManager()">âš™ï¸</button>
        </div>
        <input id="searchBox" type="text" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..." onkeyup="filterUnits(this.value)">
        <button class="back-btn" style="background:var(--danger); width:100%;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="dashPanels">
        <div id="panelUnits" class="panel active">
            <div class="units-grid" id="unitsGrid"></div>
        </div>
        <div id="panelArchive" class="panel">
            <div class="list-card">
                <b>ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</b>
                <div class="mini">ÙŠØ¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© (Ø¥Ø°Ø§ data.settings.archived = true).</div>
                <div id="archiveList"></div>
            </div>
        </div>
        <div id="panelLogs" class="panel">
            <div class="list-card">
                <b>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</b>
                <div class="mini">Ø¢Ø®Ø± 50 Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ø¬Ø¯ÙˆÙ„ audit_logs (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯).</div>
                <div id="logsStatus" class="mini"></div>
                <div id="logsList" style="direction:ltr; text-align:left; font-size:12px; white-space:pre-wrap; word-break:break-word;"></div>
            </div>
        </div>
    </div>


<div id="sideOverlay">
  <div id="sideDrawer" onclick="event.stopPropagation()">
    <div class="side-header">
      <div>
        <div class="side-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
        <div class="side-sub" id="sideUserLine">...</div>
      </div>
      <button class="side-close" id="btnCloseMenu">âœ–</button>
    </div>

    <div class="side-list" id="sideList">
      <div class="side-item active" data-section="home">
        <div><span class="ico">ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©<br><span class="side-sub">ÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª + Ø§Ù„Ø¨Ø­Ø«</span></div>
        <span class="badge" id="badgeHome">0</span>
      </div>
      <div class="side-item" data-section="late">
        <div><span class="ico">ğŸ”µ</span> Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†<br><span class="side-sub">Ø£ÙƒØ«Ø± Ù…Ù† 60 ÙŠÙˆÙ…</span></div>
        <span class="badge blue" id="badgeLate">0</span>
      </div>
      <div class="side-item" data-section="warning">
        <div><span class="ico">ğŸŸ </span> Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª<br><span class="side-sub">Ù…Ù† 70 Ø¥Ù„Ù‰ 80 ÙŠÙˆÙ…</span></div>
        <span class="badge orange" id="badgeWarn">0</span>
      </div>
      <div class="side-item" data-section="cancel">
        <div><span class="ico">ğŸ”´</span> Ø§Ù„ÙØ³Ø®<br><span class="side-sub">90 ÙŠÙˆÙ… ÙˆÙÙˆÙƒ</span></div>
        <span class="badge red" id="badgeCancel">0</span>
      </div>
      <div class="side-item" data-section="admin">
        <div><span class="ico">âš™ï¸</span> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©<br><span class="side-sub">Ø§Ù„Ø£Ø¯Ù…Ù†ÙŠØ© + Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯Ø§Øª</span></div>
        <span class="badge" id="badgeAdmin"> </span>
      </div>
      <div class="side-item" data-section="archive">
        <div><span class="ico">ğŸ—„ï¸</span> Ø§Ù„Ø£Ø±Ø´ÙŠÙ<br><span class="side-sub">ÙˆØ­Ø¯Ø§Øª Ù…Ø¤Ø±Ø´ÙØ©</span></div>
        <span class="badge" id="badgeArchive">0</span>
      </div>
      <div class="side-item" data-section="logs">
        <div><span class="ico">ğŸ“‹</span> Ø§Ù„Ø³Ø¬Ù„<br><span class="side-sub">Ù…Ù†Ùˆ Ø§Ø´ØªØºÙ„ Ø´Ù†Ùˆ</span></div>
        <span class="badge" id="badgeLogs"> </span>
      </div>
    </div>
  </div>
</div>

</div>

<div id="adminsModal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</h2>
        <button onclick="closeAdminsManager()" style="background:none; border:none; font-size:20px;">âœ–</button>
    </div>
    <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;">
        <h4 style="margin-top:0;">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„</h4>
        <input type="text" id="newAdminUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)">
        <input type="text" id="newAdminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="login-btn" onclick="saveAdminUser()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
    </div>
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</h3>
    <div id="adminsListContainer"></div>
</div>

<div id="unitInterface" class="unit-interface">
    <div class="unit-header">
        <div>
            <h2 style="margin:0;" id="headerUnitTitle">...</h2>
            <small style="opacity:0.9;" id="headerOwner">...</small>
        </div>
        <button class="back-btn" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-scroll">
        <div class="stat-card bg-1"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><h3 style="margin:5px 0" id="dispPaid">0</h3></div>
        <div class="stat-card bg-2"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><h3 style="margin:5px 0" id="dispRemain">0</h3></div>
        <div class="stat-card bg-3"><small>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 style="margin:5px 0" id="dispProg">0%</h3></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('info')">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('payments')">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="tab-btn" onclick="showTab('docs')">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button> 
        <button class="tab-btn" onclick="showTab('works')">Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„</button>
        <button class="tab-btn" onclick="showTab('visits')">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('history')">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©</button>
        <button class="tab-btn" onclick="showTab('notifs')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
        <button class="tab-btn" onclick="showTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
        <button class="tab-btn admin-only" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="info" class="tab-content" style="display:block;">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="ownerName" class="editable">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="ownerPhone" class="editable">
        <div class="admin-only" style="margin-top:20px; background:#e0f7fa; padding:15px; border-radius:10px;">
            <label style="color:#006064;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" id="totalPrice" onchange="saveData()">
        </div>
        <button class="login-btn admin-only" style="margin-top:20px;" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>

    <div id="payments" class="tab-content">
        <div class="table-wrapper"><table id="payTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="docs" class="tab-content">
        <div class="table-wrapper"><table id="docsTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ù…Ù„Ù</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="works" class="tab-content">
        <div class="table-wrapper"><table id="workTable"><thead><tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>%</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="visits" class="tab-content">
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:20px;">
            <h3 style="margin-top:0; color:var(--primary);">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©</h3>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="reqVisitDate">
            <label>Ø§Ù„Ø³Ø¨Ø¨</label><input type="text" id="reqVisitReason" placeholder="...">
            <button class="login-btn" style="margin-top:10px;" onclick="submitVisitRequest()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
        <h3 style="margin-bottom:10px;">Ø§Ù„Ø³Ø¬Ù„</h3>
        <div class="table-wrapper"><table id="visitTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="history" class="tab-content"><div class="table-wrapper"><table id="histTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div><div style="height:60px;"></div></div>
    <div id="notifs" class="tab-content"><div class="table-wrapper"><table id="notifTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØ¨Ù„ÙŠØº</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div><div style="height:60px;"></div></div>
    <div id="media" class="tab-content"><div class="media-grid" id="mediaGrid"></div><div style="height:60px;"></div></div>

    <div id="settings" class="tab-content">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)</label><input type="text" id="uUser"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)</label><input type="text" id="uPass">
        <button class="login-btn" onclick="saveData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>

    <button id="fabAdd" class="fab-add admin-only" onclick="openModal()">+</button>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
        <div id="modalInputs"></div> 
        <div class="modal-btn-group"><button class="btn-confirm" onclick="confirmModal()">Ø­ÙØ¸</button><button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ğŸ”´ğŸ”´ğŸ”´ Ø¨ÙŠØ§Ù†Ø§Øª Supabase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ğŸ”´ğŸ”´ğŸ”´
    const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let db = {}; 
    let adminsDb = {};
    let currentUnit = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let currentTab = 'info';
    let currentSection = 'home';


    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    function switchScreen(screenId) {
        const screens = ['loadingScreen', 'loginScreen', 'adminDashboard', 'unitInterface', 'adminsModal'];
        screens.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.cssText = "display: none !important;"; 
        });
        const target = document.getElementById(screenId);
        if(target) {
            target.style.cssText = "display: block !important;";
            if(screenId === 'adminDashboard') target.style.display = 'block'; 
        }
        window.scrollTo(0, 0);
    }

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    async function init() {
        console.log("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...");
        
        // Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        const { data: u, error: uErr } = await supabase.from('units').select('*');
        if(u) u.forEach(r => db[r.id] = r.data);
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†ÙŠØ©
        const { data: a, error: aErr } = await supabase.from('admins').select('*');
        if(a) a.forEach(r => adminsDb[r.username] = r);

        document.getElementById('loadingScreen').style.display = 'none';
        try{ computeBadges(); }catch(e){}
        
        if (!localStorage.getItem('loggedInUser')) {
             switchScreen('loginScreen');
        }
    }
    init();

    
    

    // ===== V12 (Sidebar + Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±) =====
    let currentSection = 'home';

    // Menu hooks
    const _ov = document.getElementById('sideOverlay');
    if (_ov) _ov.addEventListener('click', closeMenu);
    const _bm = document.getElementById('btnMenu');
    if (_bm) _bm.addEventListener('click', openMenu);
    const _bc = document.getElementById('btnCloseMenu');
    if (_bc) _bc.addEventListener('click', closeMenu);
    document.querySelectorAll('#sideList .side-item').forEach(it => {
        it.addEventListener('click', () => setSection(it.getAttribute('data-section')));
    });

    function openMenu(){
        const ov = document.getElementById('sideOverlay');
        if (ov) ov.style.display = 'block';
        const userLine = document.getElementById('sideUserLine');
        if (userLine){
            userLine.innerText = isSuperAdmin ? 'Super Admin' : (isAdmin ? 'Admin' : 'User');
        }
        try{ computeBadges(); }catch(e){}
    }
    function closeMenu(){
        const ov = document.getElementById('sideOverlay');
        if (ov) ov.style.display = 'none';
    }

    function updateSectionPill(){
        const pill = document.getElementById('currentSectionPill');
        if(!pill) return;
        const map = {
            home: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
            late: 'ğŸ”µ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†',
            warning: 'ğŸŸ  Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª',
            cancel: 'ğŸ”´ Ø§Ù„ÙØ³Ø®',
            admin: 'âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
            archive: 'ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ',
            logs: 'ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„'
        };
        pill.innerText = map[currentSection] || 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
    }

    // ===== Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø¯ÙØ¹Ø© =====
    function parseAnyDate(s){
        if(!s) return null;
        s = String(s).trim();
        let m;
        if ((m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/))) {
            return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
        }
        if ((m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/))) {
            return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        }
        if ((m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/))) {
            return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        }
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
    }

    function getLastPaymentDate(unitData){
        const pays = (unitData && unitData.payments) ? unitData.payments : [];
        if (!Array.isArray(pays) || pays.length === 0) return null;
        let best = null;
        for (const row of pays){
            const ds = Array.isArray(row) ? row[0] : null;
            const d = parseAnyDate(ds);
            if (!d) continue;
            if (!best || d.getTime() > best.getTime()) best = d;
        }
        return best;
    }

    function getOverdueDays(unitData){
        const last = getLastPaymentDate(unitData);
        if (!last) return null;
        const now = new Date();
        const a = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const b = new Date(last.getFullYear(), last.getMonth(), last.getDate()).getTime();
        return Math.floor((a - b) / 86400000);
    }

    function isSold(unitData){
        return !!(unitData && unitData.info && unitData.info.name && String(unitData.info.name).trim().length > 0);
    }

    function computeBadges(){
        // Ù†Ø¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù„Ù„Ø¯Ù‚Ø§Øª
        let soldCount = 0;
        let late = 0;
        let warn = 0;
        let cancel = 0;
        let arch = 0;

        for (const id of Object.keys(db)){
            const d = db[id];
            if (!d) continue;
            if (d?.settings?.archived === true) arch += 1;
            if (!isSold(d)) continue;
            soldCount += 1;
            const ov = getOverdueDays(d);
            if (ov == null) continue;
            if (ov > 60) late += 1;
            if (ov >= 70 && ov <= 80) warn += 1;
            if (ov >= 90) cancel += 1;
        }

        const set = (id, v) => {
            const el = document.getElementById(id);
            if (el) el.textContent = String(v);
        };
        set('badgeHome', soldCount);
        set('badgeLate', late);
        set('badgeWarn', warn);
        set('badgeCancel', cancel);
        set('badgeArchive', arch);
    }

    async function loadAuditLogs(){
        const st = document.getElementById('logsStatus');
        const box = document.getElementById('logsList');
        if(st) st.innerText = 'Ø¬Ø§Ø±ÙŠ...';
        if(box) box.innerText = '';
        try{
            const { data, error } = await supabase
                .from('audit_logs')
                .select('*')
                .order('id',{ascending:false})
                .limit(50);
            if (error) throw error;
            if (!data || data.length === 0){
                if(st) st.innerText = 'Ù…Ø§ÙƒÙˆ Ø¨ÙŠØ§Ù†Ø§Øª.';
                return;
            }
            if(st) st.innerText = `ØªÙ… âœ… (${data.length})`;
            const lines = data.map(r => {
                const t = r.created_at ? new Date(r.created_at).toLocaleString() : '';
                return `${t} | ${r.action || ''} | ${r.table_name || ''} | ${r.record_id || ''}\nactor: ${r.actor_role || ''} ${r.actor_id || ''}\n${JSON.stringify(r.changes || {}, null, 2)}\n------------------------------`;
            });
            if(box) box.innerText = lines.join('\n');
        }catch(e){
            if(st) st.innerText = 'Ø®Ø·Ø£ Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„: ' + (e?.message || e);
        }
    }

    function renderArchive(){
        const cont = document.getElementById('archiveList');
        if(!cont) return;
        cont.innerHTML = '';
        const ids = Object.keys(db).filter(id => db[id]?.settings?.archived === true);
        if(ids.length === 0){
            cont.innerHTML = '<div class="mini">Ù…Ø§ÙƒÙˆ ÙˆØ­Ø¯Ø§Øª Ù…Ø¤Ø±Ø´ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
            return;
        }
        ids.sort((a,b)=>a.localeCompare(b, 'en', {numeric:true}));
        ids.forEach(id => {
            const d = db[id];
            const div = document.createElement('div');
            div.className = 'unit-card sold';
            div.onclick = () => openUnit(id);
            div.innerHTML = `<h3>${id}</h3><small>${d?.info?.name || '---'}</small>`;
            cont.appendChild(div);
        });
    }

    function setSection(sec){
        currentSection = sec || 'home';
        updateSectionPill();

        // active item highlight
        document.querySelectorAll('#sideList .side-item').forEach(it => {
            it.classList.toggle('active', it.getAttribute('data-section') === currentSection);
        });

        // Panels
        const panelUnits = document.getElementById('panelUnits');
        const panelArchive = document.getElementById('panelArchive');
        const panelLogs = document.getElementById('panelLogs');
        [panelUnits, panelArchive, panelLogs].forEach(p => p && p.classList.remove('active'));

        // search visibility
        const search = document.getElementById('searchBox');
        const wantsSearch = ['home','late','warning','cancel'].includes(currentSection);
        if(search){
            search.style.display = wantsSearch ? 'block' : 'none';
            if(!wantsSearch) search.value = '';
        }

        if (currentSection === 'admin'){
            closeMenu();
            openAdminsManager();
            return;
        }

        if (currentSection === 'archive'){
            panelArchive && panelArchive.classList.add('active');
            renderArchive();
            closeMenu();
            return;
        }

        if (currentSection === 'logs'){
            panelLogs && panelLogs.classList.add('active');
            loadAuditLogs();
            closeMenu();
            return;
        }

        panelUnits && panelUnits.classList.add('active');
        renderUnitsGrid(document.getElementById('searchBox')?.value || '');
        closeMenu();
    }

    function initAdminDashboard() {
        currentUnit = null;
        switchScreen('adminDashboard');
        currentSection = 'home';
        updateSectionPill();
        computeBadges();
        renderUnitsGrid('');
    }

    // Grid render Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
    window.renderUnitsGrid = function(filter) {
        if(currentUnit !== null) return;
        const grid = document.getElementById('unitsGrid');
        if(!grid) return;
        grid.innerHTML = '';

        const wanted = currentSection;

        const addUnitCard = (id, d) => {
            const sold = isSold(d);
            const hasPending = d && d.visits && d.visits.some(v => v.status === 'pending');
            const overdue = getOverdueDays(d);
            const overdueText = (overdue == null) ? '' : ` | ${overdue} ÙŠÙˆÙ…`;

            const div = document.createElement('div');
            div.className = `unit-card ${sold ? 'sold' : ''} ${hasPending ? 'has-request' : ''}`;
            div.onclick = () => openUnit(id);
            const name = sold ? (d?.info?.name || 'Ù…Ø¨Ø§Ø¹') : 'Ù…ØªØ§Ø­';
            div.innerHTML = `<div class="notify-dot"></div><h3>${id}</h3><small>${name}${overdueText}</small>`;
            grid.appendChild(div);
        };

        // Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ØªØ§Ø­ØŒ Ù†ÙƒÙ…Ù„ Ø¹Ù„Ù‰ A/B/C
        ['A','B','C'].forEach(cat => {
            for(let i=1;i<=50;i++){
                const id = cat + i;
                if (filter && !id.toLowerCase().includes(String(filter).toLowerCase())) continue;

                const d = db[id];
                // Ø¨Ø§Ù„Ø±ÙŠÙ”ÙŠØ³ÙŠØ© Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ (Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ÙƒÙˆ data)
                if (wanted === 'home'){
                    if (d) addUnitCard(id, d);
                    else {
                        // ÙˆØ­Ø¯Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
                        const div = document.createElement('div');
                        div.className = 'unit-card';
                        div.onclick = () => openUnit(id);
                        div.innerHTML = `<h3>${id}</h3><small>Ù…ØªØ§Ø­</small>`;
                        grid.appendChild(div);
                    }
                    continue;
                }

                // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ÙÙ‚Ø· Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ø§ last payment
                if (!d || !isSold(d)) continue;
                const ov = getOverdueDays(d);
                if (ov == null) continue;

                if (wanted === 'late' && ov > 60) addUnitCard(id, d);
                if (wanted === 'warning' && ov >= 70 && ov <= 80) addUnitCard(id, d);
                if (wanted === 'cancel' && ov >= 90) addUnitCard(id, d);
            }
        });

        computeBadges();
    }

    window.filterUnits = (val) => window.renderUnitsGrid(val);

window.openUnit = function(id) {
        switchScreen('unitInterface'); 
        currentUnit = id;
        
        if (!db[id]) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ ÙØ§Ø±Øº Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
            db[id] = { info: {name:"",phone:""}, settings: {user:id, pass:"123"}, totalPrice:0, payments:[], works:[], history:[], notifs:[], media:[], visits:[], docs:[] };
        }
        // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª
        ['docs', 'media', 'history', 'notifs', 'visits', 'payments', 'works'].forEach(k => { if(!db[id][k]) db[id][k] = []; });
        
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ù„Ø¥Ø¸Ù‡Ø§Ø±
        const ui = document.getElementById('unitInterface');
        if(isAdmin) ui.classList.add('show-admin');
        else ui.classList.remove('show-admin');
        
        loadUnitData();
        showTab('info');
    }

    window.loadUnitData = function() {
        if(!db[currentUnit]) return;
        const d = db[currentUnit];
        document.getElementById('headerUnitTitle').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø© " + currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = formatNumber(d.totalPrice);
        document.getElementById('uUser').value = d.settings.user;
        document.getElementById('uPass').value = d.settings.pass;
        
        // Ù‚ÙÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£Ø¯Ù…Ù†
        document.getElementById('ownerName').readOnly = !isAdmin;
        document.getElementById('ownerPhone').readOnly = !isAdmin;
        
        renderTable('payTable', d.payments);
        renderTable('workTable', d.works);
        renderTable('histTable', d.history);
        renderTable('notifTable', d.notifs);
        renderVisitsTable(d.visits);
        renderMediaGrid(d.media);
        renderDocsTable(d.docs);
        calcStats();
    }

    function renderTable(id, rows) {
        if(!rows) rows = [];
        const tb = document.getElementById(id).querySelector('tbody'); tb.innerHTML = "";
        rows.forEach((r, i) => {
            let tr = tb.insertRow();
            r.forEach(c => tr.insertCell().innerText = c);
            if(isAdmin) tr.insertCell().innerHTML = `<button onclick="delRow('${id}',${i})" style="color:red;border:none;background:none;font-size:18px">&times;</button>`;
        });
    }

    function renderDocsTable(docs) {
        const tb = document.getElementById('docsTable').querySelector('tbody'); tb.innerHTML = "";
        if(!docs) docs = [];
        docs.forEach((d, i) => {
            let link = `<button onclick="viewImage('${d.url}')" style="background:none;border:none;color:blue;text-decoration:underline;cursor:pointer;font-weight:bold;">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</button>`;
            tb.innerHTML += `<tr><td>${d.date}</td><td>${d.type}</td><td>${d.note}</td><td>${link}</td>${isAdmin ? `<td><button onclick="delRow('docsTable',${i})" style="color:red;border:none;background:none">Ã—</button></td>` : ''}</tr>`;
        });
    }

    function renderVisitsTable(visits) {
        if(!visits) visits = [];
        const tb = document.getElementById('visitTable').querySelector('tbody'); tb.innerHTML = "";
        visits.forEach((v, i) => {
            let tr = tb.insertRow();
            tr.insertCell().innerText = v.date;
            tr.insertCell().innerText = v.reason;
            let status = v.status;
            let statusText = status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : (status === 'approved' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ù…Ø±ÙÙˆØ¶');
            let statusClass = status === 'pending' ? 'st-pending' : (status === 'approved' ? 'st-approved' : 'st-rejected');
            tr.insertCell().innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
            let actionTd = tr.insertCell();
            if(isAdmin) {
                if(status === 'pending') {
                    actionTd.innerHTML = `<button class="visit-action-btn btn-approve" onclick="setVisitStatus(${i}, 'approved')">âœ”</button><button class="visit-action-btn btn-reject" onclick="setVisitStatus(${i}, 'rejected')">âœ–</button>`;
                } else actionTd.innerHTML = `<button onclick="delRow('visitTable',${i})" style="color:red;border:none;background:none;">Ø­Ø°Ù</button>`;
            } else actionTd.innerText = "-";
        });
    }

    window.submitVisitRequest = function() {
        const date = document.getElementById('reqVisitDate').value;
        const reason = document.getElementById('reqVisitReason').value;
        if(!date || !reason) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        if(!db[currentUnit].visits) db[currentUnit].visits = [];
        db[currentUnit].visits.push({ date: date, reason: reason, status: 'pending' });
        saveData();
        document.getElementById('reqVisitDate').value = "";
        document.getElementById('reqVisitReason').value = "";
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    }

    window.setVisitStatus = function(index, status) {
        db[currentUnit].visits[index].status = status;
        saveData();
    }

    function renderMediaGrid(media) {
        const g = document.getElementById('mediaGrid'); g.innerHTML = "";
        if(!media) media = [];
        media.forEach((m, i) => {
            let content = '';
            if (m.type === 'video') {
                content = `<a href="${m.url}" target="_blank" style="font-size:40px;text-decoration:none;">ğŸ¬</a>`;
            } else {
                content = `<img src="${m.url}" onclick="viewImage('${m.url}')">`;
            }
            
            g.innerHTML += `
            <div class="media-item">
                ${content}
                ${isAdmin ? `<button onclick="delRow('mediaGrid',${i})" style="position:absolute;top:5px;left:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;">Ã—</button>` : ''}
            </div>`;
        });
    }

    window.viewImage = function(url) {
        if(!url) return;
        document.getElementById('fullImage').src = url;
        document.getElementById('imageViewer').style.display = 'flex';
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    window.downloadCurrentImage = async function() {
        const img = document.getElementById('fullImage');
        const url = img.src;
        if(!url) return;
        
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "image_" + Date.now() + ".jpg";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (e) {
            console.error(e);
            window.open(url, '_blank');
        }
    }

    function calcStats() {
        const d = db[currentUnit];
        let total = parseFloat(String(d.totalPrice).replace(/,/g,'')) || 0;
        let payments = d.payments || [];
        let paid = payments.reduce((a,c) => a + (parseFloat(String(c[2]).replace(/,/g,''))||0), 0);
        document.getElementById('dispPaid').innerText = formatNumber(paid);
        document.getElementById('dispRemain').innerText = formatNumber(total - paid);
        let works = d.works || [];
        document.getElementById('dispProg').innerText = works.length > 0 ? works[works.length-1][2] : "0%";
    }

    window.showTab = function(t) {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        
        const map = {'info':0, 'payments':1, 'docs':2, 'works':3, 'visits':4, 'history':5, 'notifs':6, 'media':7, 'settings':8};
        if(document.querySelectorAll('.tab-btn')[map[t]]) document.querySelectorAll('.tab-btn')[map[t]].classList.add('active');

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
        const fab = document.getElementById('fabAdd');
        fab.style.display = (isAdmin && ['payments','docs','works','history','notifs','media'].includes(t)) ? 'flex' : 'none';
    }

    window.openModal = function() {
        const content = document.getElementById('modalInputs');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('actionModal').style.display = 'flex';
        
        if(currentTab === 'media') {
            content.innerHTML = `<label>ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ</label><input type="file" id="mFile"><input type="text" id="mDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><input type="date" id="mDate" value="${today}"><p id="uploadStat" style="color:blue"></p>`;
        } else if(currentTab === 'docs') { 
            content.innerHTML = `<label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label><select id="mType"><option>Ø¥Ù†Ø°Ø§Ø±</option><option>ØªØ£Ø¬ÙŠÙ„</option><option>ØªØ¹Ù‡Ø¯</option><option>Ø£Ø®Ø±Ù‰</option></select><input type="text" id="mNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"><label>ØµÙˆØ±Ø© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label><input type="file" id="mFile"><input type="date" id="mDate" value="${today}"><p id="uploadStat" style="color:blue"></p>`;
        } else if(currentTab === 'payments') {
            content.innerHTML = `<input type="text" id="mRcpt" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„"><input type="number" id="mAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><input type="text" id="mNote" placeholder="ØªÙØ§ØµÙŠÙ„"><input type="date" id="mDate" value="${today}">`;
        } else if(currentTab === 'works') {
             // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
             let options = "";
             for(let i=5; i<=100; i+=5) {
                 options += `<option value="${i}">${i}%</option>`;
             }
             content.innerHTML = `<label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="mStage" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ù…Ø«Ù„Ø§Ù‹: ØµØ¨ Ø§Ù„Ø³Ù‚Ù)"><label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</label><select id="mPerc" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px">${options}</select><input type="date" id="mDate" value="${today}">`;
        } else if(currentTab === 'notifs') {
             content.innerHTML = `<input type="text" id="mMsg" placeholder="Ù†Øµ Ø§Ù„ØªØ¨Ù„ÙŠØº"><input type="date" id="mDate" value="${today}">`;
        } else if (currentTab === 'history') {
             content.innerHTML = `<label>Ø§Ù„Ø­Ø¯Ø«</label><select id="mEvent" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px"><option>ØªÙ†Ø§Ø²Ù„</option><option>Ø¨ÙŠØ¹</option><option>Ø§Ù†Ø³Ø­Ø§Ø¨</option></select><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="mNote"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        }
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø­ÙØ¸ ---
    window.confirmModal = async function() {
        const date = document.getElementById('mDate').value;
        const d = db[currentUnit];
        
        if (currentTab === 'media' || currentTab === 'docs') {
            const fileInput = document.getElementById('mFile');
            const file = fileInput.files[0];
            const statusText = document.getElementById('uploadStat');

            if (!file) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹");

            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
            
            const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, ''); 
            const { data, error } = await supabase.storage.from('media').upload(fileName, file);

            if (error) {
                console.error(error);
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + error.message);
                statusText.innerText = "";
            } else {
                const { data: publicUrlData } = supabase.storage.from('media').getPublicUrl(fileName);
                const publicURL = publicUrlData.publicUrl;

                if (currentTab === 'media') {
                     const desc = document.getElementById('mDesc').value;
                     const type = file.type.startsWith('video') ? 'video' : 'image';
                     d.media.push({type: type, desc: desc, date: date, url: publicURL});
                } else {
                     const type = document.getElementById('mType').value;
                     const note = document.getElementById('mNote').value;
                     d.docs.push({type: type, note: note, date: date, url: publicURL});
                }
                saveData();
                closeModal();
            }
            return;
        }

        if (currentTab === 'payments') {
            const r = document.getElementById('mRcpt').value;
            const a = document.getElementById('mAmt').value;
            const n = document.getElementById('mNote').value;
            if(!a) return; d.payments.push([date, r||"-", formatNumber(a), n]);
        } else if (currentTab === 'works') {
            const s = document.getElementById('mStage').value;
            const p = document.getElementById('mPerc').value;
            if(!s) return; d.works.push([s, date, p+"%"]);
        } else if (currentTab === 'history') {
             d.history.push([date, document.getElementById('mEvent').value, document.getElementById('mNote').value]);
        } else if (currentTab === 'notifs') {
             d.notifs.push([date, document.getElementById('mMsg').value]);
        }
        saveData();
        closeModal();
    }

    window.closeModal = () => document.getElementById('actionModal').style.display = 'none';
    
    window.delRow = function(id, i) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        if(id==='visitTable') db[currentUnit].visits.splice(i,1);
        else { const map={'payTable':'payments','workTable':'works','histTable':'history','notifTable':'notifs', 'docsTable':'docs', 'mediaGrid':'media'}; db[currentUnit][map[id]].splice(i,1); }
        saveData();
    }
    
    window.goBack = function() { 
        if(isAdmin) {
             initAdminDashboard(); 
        } else {
             location.reload(); 
        }
    }
    
    function formatNumber(n) { return n ? Number(String(n).replace(/,/g,'')).toLocaleString('en-US') : "0"; }
    document.addEventListener("keyup", function(event) { if (event.key === "Enter" && document.getElementById('loginScreen').style.display !== 'none') handleLogin(); });
</script>
</body>
</html>