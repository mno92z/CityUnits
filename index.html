<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة الوحدات السكنية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .tab-active { background-color: #2563eb; color: white; }
        .tab-inactive { background-color: white; color: #4b5563; }
        /* إخفاء شريط التمرير للجمالية */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="pb-20">

    <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">إدارة المجمع السكني</h1>
            <div id="user-status" class="text-sm text-gray-500">جاري التحقق...</div>
        </div>
        
        <div class="mt-4 flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <button onclick="loadUnits('A')" id="btn-A" class="tab-btn px-6 py-2 rounded-full font-bold shadow-sm transition">فئة A</button>
            <button onclick="loadUnits('B')" id="btn-B" class="tab-btn px-6 py-2 rounded-full font-bold shadow-sm transition">فئة B</button>
            <button onclick="loadUnits('C')" id="btn-C" class="tab-btn px-6 py-2 rounded-full font-bold shadow-sm transition">فئة C</button>
            <button onclick="loadUnits('D')" id="btn-D" class="tab-btn px-6 py-2 rounded-full font-bold shadow-sm transition">فئة D</button>
        </div>
    </header>

    <main class="p-4">
        <div id="units-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-10 text-gray-400">جاري تحميل الوحدات...</div>
        </div>
    </main>

    <div id="login-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-center">تسجيل الدخول</h2>
            <input type="email" id="email" placeholder="البريد الإلكتروني" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
            <input type="password" id="password" placeholder="كلمة المرور" class="w-full p-3 border rounded-lg mb-4 bg-gray-50">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">دخول</button>
            <p id="login-error" class="text-red-500 text-center mt-2 text-sm"></p>
        </div>
    </div>

    <script>
        // 1. إعداد الاتصال بقاعدة البيانات
        // استبدل المفاتيح أدناه بمفاتيحك الحقيقية من Supabase
        const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ'; // Anon Key
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;

        // 2. التحقق من المستخدم عند التشغيل
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('user-status').innerText = 'مرحباً';
                document.getElementById('login-modal').classList.add('hidden');
                loadUnits('A'); // تحميل الافتراضي
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        // 3. دالة تسجيل الدخول
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            errorMsg.innerText = 'جاري الاتصال...';

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                errorMsg.innerText = 'خطأ في المعلومات: ' + error.message;
            } else {
                location.reload(); // إعادة تحميل الصفحة للدخول
            }
        }

        // 4. جلب الوحدات وعرضها
        async function loadUnits(category) {
            // تحديث أزرار التبويب
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`btn-${category}`).classList.add('tab-active');
            document.getElementById(`btn-${category}`).classList.remove('tab-inactive');

            const grid = document.getElementById('units-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10">جاري التحميل...</div>';

            // طلب البيانات من Supabase
            const { data: units, error } = await supabase
                .from('units')
                .select('*')
                .eq('category', category)
                .order('id', { ascending: true });

            if (error) {
                grid.innerHTML = `<div class="text-red-500">خطأ: ${error.message}</div>`;
                return;
            }

            if (!units || units.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500">لا توجد وحدات في هذه الفئة</div>';
                return;
            }

            // بناء العناصر (Render)
            grid.innerHTML = units.map(unit => {
                const info = unit.data?.info || {};
                const isSold = !!info.name;
                
                // حساب الحالة (منطق مبسط للعرض)
                let statusColor = 'bg-green-500';
                let statusText = 'طبيعي';
                
                if (!isSold) {
                    statusColor = 'bg-gray-200 text-gray-500';
                    statusText = 'متاح';
                } else {
                    // هنا تضع منطق حساب الأيام الحقيقي
                    // للتجربة سنفترض الكل طبيعي
                }

                return `
                <div onclick="openUnit('${unit.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition cursor-pointer relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-lg text-gray-800">${unit.id}</span>
                        <span class="text-xs px-2 py-1 rounded-full ${statusColor} text-white font-bold">
                            ${statusText}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 truncate">
                        ${isSold ? info.name : 'غير محجوز'}
                    </div>
                    ${isSold ? `<div class="mt-2 text-xs text-gray-400">آخر دفعة: --</div>` : ''}
                </div>
                `;
            }).join('');
        }

        function openUnit(id) {
            alert('سيتم فتح تفاصيل الوحدة: ' + id + '\n(يمكنك برمجة الانتقال لصفحة التفاصيل هنا)');
        }

        // تشغيل التحقق عند البدء
        checkSession();

    </script>
</body>
</html>