<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004d40">

    <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©) --- */
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --white: #ffffff; --danger: #d32f2f; --warning: #ff9800; --info: #2196f3; --menu-bg: #263238; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select, textarea { font-size: 16px; outline: none; font-family: inherit; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(255,255,255,.98);z-index:9999}
        .spinner{width:44px;height:44px;border:4px solid #e5e7eb;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .app-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: white; }
        
        .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: var(--menu-bg); color: white; z-index: 200; transition: 0.3s; padding-top: 60px; box-shadow: -2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .sidebar.open { right: 0; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; display: none; }
        .sidebar.open + .sidebar-overlay { display: block; }
        
        .menu-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item.active { background: var(--accent); color: var(--primary); font-weight: bold; }
        .close-menu { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; color: white; }

        /* Login */
        #login { min-height: 100vh; display: none; flex-direction: column; justify-content: center; padding: 30px; background: linear-gradient(135deg, var(--primary), #00251a); color: white; text-align: center; }
        .login-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.9); font-weight: bold; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border:none; font-weight:bold; cursor:pointer; margin-top:5px; }
        .btn.primary { background: var(--accent); color: var(--primary); }
        .btn.danger { background: var(--danger); color: white; }
        .btn.gray { background: #eee; color: #333; }

        /* Dashboard Views */
        #app { display: none; }
        .view-section { display: none; padding: 20px; padding-bottom: 80px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        .search-input { width: 100%; padding: 15px; border-radius: 50px; border: 1px solid #ddd; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .admin-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .adm-stat { background: white; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .adm-stat h3 { margin: 5px 0; font-size: 14px; color: var(--primary); }
        .adm-stat small { font-size: 10px; color: #666; }

        .category-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .cat-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: white; border-radius: 8px; text-align: center; font-size: 13px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .cat-btn small { display: block; font-size: 9px; opacity: 0.8; font-weight: normal; }

        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .unit-card { background: white; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .unit-card.sold { border-color: var(--accent); background: #e0f2f1; }
        .unit-card h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .unit-card small { color: #888; font-size: 11px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Unit Interface (Classic Layout) */
        #unitView { display: none; padding-bottom: 80px; background: white; min-height: 100vh; }
        .unit-header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
        
        .stats-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 0 20px 20px; scrollbar-width: none; }
        .stat-card { flex: 1; min-width: 140px; padding: 15px; border-radius: 10px; color: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 5px 0; font-size: 20px; }
        .stat-card small { font-size: 12px; opacity: 0.9; }
        .bg-orange { background: linear-gradient(45deg, #FF9800, #F57C00); } /* Ù…Ø¯ÙÙˆØ¹ */
        .bg-blue { background: linear-gradient(45deg, #2196F3, #1976D2); } /* Ù…ØªØ¨Ù‚ÙŠ */
        .bg-green { background: linear-gradient(45deg, #4CAF50, #388E3C); } /* Ø¥Ù†Ø¬Ø§Ø² */
        .bg-gray { background: linear-gradient(45deg, #607D8B, #455A64); } /* Ø§Ø³ØªØ­Ù‚Ø§Ù‚ */

        .tabs-nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .tab-btn { padding: 10px 15px; background: none; border: none; white-space: nowrap; color: #666; font-weight: bold; border-bottom: 3px solid transparent; font-size: 14px; cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--accent); }
        
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Tables & Inputs */
        .table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; }
        
        label { font-size: 13px; color: #666; font-weight: bold; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }
        
        /* Lists Styles */
        .list-card { background: white; border-right: 5px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .list-card.type-late { border-right-color: #2196F3; }
        .list-card.type-warn { border-right-color: #FF9800; background: #fff3e0; }
        .list-card.type-term { border-right-color: #d32f2f; background: #ffebee; }

        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
        
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <div class="muted" style="margin-top:12px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
  <div id="loadErr" style="color:red;font-size:12px;margin-top:5px"></div>
</div>

<div id="login">
  <div class="loginBox">
    <h2 style="margin:0 0 6px 0">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h2>
    <p style="opacity:0.8">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø§Ù…Ù„</p>
    <input id="loginEmail" type="email" placeholder="Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„" />
    <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button class="btn primary" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMsg" style="margin-top:10px;color:#ffccbc"></div>
  </div>
</div>

<div id="app">
  <div class="app-header">
    <span style="font-weight:bold;font-size:18px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹</span>
    <button class="menu-btn" id="btnMenu">â˜°</button>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="close-menu" id="btnCloseMenu">Ã—</div>
    <div class="menu-item active" onclick="goSection('home')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="menu-item" onclick="goSection('late')">ğŸ”µ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† (60+)</div>
    <div class="menu-item" onclick="goSection('warning')">ğŸŸ  Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª (70+)</div>
    <div class="menu-item" onclick="goSection('cancel')">ğŸ”´ Ø§Ù„ÙØ³Ø® (90+)</div>
    <div class="menu-item" onclick="goSection('archive')">ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
    <div class="menu-item" onclick="goSection('logs')">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
    <div class="menu-item" onclick="goSection('admin')">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div style="margin-top:auto;border-top:1px solid rgba(255,255,255,0.1)"></div>
    <div class="menu-item" id="btnLogout" style="color:#ff8a80">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
  </div>
  <div class="sidebar-overlay" id="overlay"></div>

  <div id="panelHome" class="view-section active">
    <div class="admin-stats-grid">
        <div class="adm-stat"><small>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</small><h3 id="statTotalMoney">0</h3></div>
        <div class="adm-stat"><small>Ø§Ù„ÙŠÙˆÙ…</small><h3 id="statTodayMoney">0</h3></div>
        <div class="adm-stat"><small>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</small><h3 id="statTodaySales">0</h3></div>
    </div>

    <div class="category-tabs">
        <button class="cat-btn active" data-cat="ALL">Ø§Ù„ÙƒÙ„</button>
        <button class="cat-btn" data-cat="A" id="btnCatA">A</button>
        <button class="cat-btn" data-cat="B" id="btnCatB">B</button>
        <button class="cat-btn" data-cat="C" id="btnCatC">C</button>
        <button class="cat-btn" data-cat="D" id="btnCatD">D</button>
    </div>

    <input id="search" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..." />
    <div class="units-grid" id="unitsGrid"></div>
  </div>

  <div id="panelLists" class="view-section">
    <h3 id="listTitle">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
    <div id="listContainer"></div>
  </div>

  <div id="panelArchive" class="view-section">
    <h3>ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
    <div class="units-grid" id="archiveGrid"></div>
  </div>

  <div id="panelLogs" class="view-section">
    <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
    <div class="table-wrapper">
        <table id="logsTable"><thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="panelAdmin" class="view-section">
    <h3>âš™ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª</h3>
    <div style="background:white;padding:15px;border-radius:10px;margin-bottom:20px">
        <label>Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„</label><input id="newEmail" />
        <label>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</label><input id="newPass" />
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="newRole"><option value="user">Ù…Ø³ØªÙÙŠØ¯</option><option value="admin">Ø£Ø¯Ù…Ù†</option></select>
        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)</label><input id="newUnit" placeholder="Ù…Ø«Ù„Ø§Ù‹ A1" />
        <button class="btn primary" id="btnCreateUser">Ø¥Ù†Ø´Ø§Ø¡</button>
        <div id="createMsg" style="margin-top:10px"></div>
    </div>
  </div>

  <div id="unitView">
    <div class="unit-header">
        <div><h2 style="margin:0;" id="unitTitle">...</h2><small id="unitSub">...</small></div>
        <button class="back-btn" id="btnBack">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-scroll">
        <div class="stat-card bg-orange"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><h3 id="uPaid">0</h3></div>
        <div class="stat-card bg-blue"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><h3 id="uRemain">0</h3></div>
        <div class="stat-card bg-green"><small>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 id="uProg">0%</h3></div>
        <div class="stat-card bg-gray"><small>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</small><h3 id="uDue">-</h3></div>
    </div>

    <div class="tabs-nav" id="unitTabs"></div>

    <div id="tab_info" class="tab-content"></div>
    <div id="tab_finance" class="tab-content"></div>
    <div id="tab_documents" class="tab-content"></div>
    <div id="tab_alerts" class="tab-content"></div>
    <div id="tab_progress" class="tab-content"></div>
    <div id="tab_notes" class="tab-content"></div>
    <div id="tab_media" class="tab-content"></div>
  </div>

</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
  const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
  const FUNCTION_NAME = 'admin-create-user';

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  let me = null;
  let isAdmin = false;
  let isSuper = false;
  let allUnits = [];
  let myUnit = null;
  let currentCategory = 'ALL';
  const unitConfig = { 'A': 472, 'B': 56, 'C': 284, 'D': 142 };

  // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
  const $ = (id) => document.getElementById(id);
  
  function formatNumber(n) { return n ? Number(String(n).replace(/,/g,'')).toLocaleString('en-US') : "0"; }
  function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  // --- Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ ---
  async function initApp() {
    try {
        const { data: { session } } = await supabase.auth.getSession();
        me = session?.user || null;
        
        if (!me) {
            $('loading').style.display = 'none';
            $('login').style.display = 'flex';
            $('app').style.display = 'none';
            return;
        }

        // Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        const { data: profile } = await supabase.from('profiles').select('role').eq('id', me.id).single();
        const role = profile?.role || 'user';
        isAdmin = (role === 'admin' || role === 'super');
        isSuper = (role === 'super');

        $('loading').style.display = 'none';
        $('login').style.display = 'none';
        $('app').style.display = 'block';

        if (isAdmin) {
            await fetchAllUnits();
            renderHome();
        } else {
            await fetchMyUnit();
            if (myUnit) openUnitView(myUnit);
        }
    } catch (e) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
    }
  }

  // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
  async function fetchAllUnits() {
      const { data } = await supabase.from('units').select('*');
      allUnits = data || [];
      // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª
      ['A','B','C','D'].forEach(cat => {
          const count = allUnits.filter(u => u.id.startsWith(cat) && u.data?.info?.name).length;
          $(`btnCat${cat}`).innerHTML = `${cat}<br><small>Ù…Ø¨Ø§Ø¹: ${count}</small>`;
      });
      calcGlobalStats();
  }

  async function fetchMyUnit() {
      const { data } = await supabase.from('units').select('*').eq('user_id', me.id).single();
      myUnit = data;
  }

  // --- Ø§Ù„Ù…Ù†Ø·Ù‚ ---
  function calcGlobalStats() {
      let total = 0, todayPaid = 0, todaySold = 0;
      const today = new Date().toISOString().split('T')[0];
      
      allUnits.forEach(u => {
          const d = u.data || {};
          if(d.finance?.payments) {
              d.finance.payments.forEach(p => {
                  let amt = parseFloat(String(p.amount).replace(/,/g,'')) || 0;
                  total += amt;
                  if(p.date === today) todayPaid += amt;
              });
          }
          if(d.info?.contract_date === today) todaySold++;
      });
      
      $('statTotalMoney').innerText = total.toLocaleString();
      $('statTodayMoney').innerText = todayPaid.toLocaleString();
      $('statTodaySales').innerText = todaySold;
  }

  // --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª ---
  function renderHome(filterType = null) {
      const grid = $('unitsGrid');
      grid.innerHTML = '';
      
      let list = allUnits;
      if (currentCategory !== 'ALL') list = list.filter(u => u.id.startsWith(currentCategory));
      
      const searchVal = $('search').value.toUpperCase();
      if(searchVal) list = list.filter(u => u.id.includes(searchVal));

      list.sort((a,b) => a.id.localeCompare(b.id, 'en', {numeric: true}));

      list.forEach(u => {
          const d = u.data || {};
          const isSold = !!d.info?.name;
          
          const div = document.createElement('div');
          div.className = `unit-card ${isSold ? 'sold' : ''}`;
          div.onclick = () => openUnitView(u);
          div.innerHTML = `<h3>${u.id}</h3><small>${isSold ? d.info.name : 'Ù…ØªØ§Ø­'}</small>`;
          grid.appendChild(div);
      });
  }

  function goSection(sec) {
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„
      document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
      $('unitView').style.display = 'none';
      $('sidebar').classList.remove('open');
      $('overlay').style.display = 'none';

      if(sec === 'home') { $('panelHome').classList.add('active'); renderHome(); }
      else if (sec === 'archive') { $('panelArchive').classList.add('active'); renderArchive(); }
      else if (sec === 'logs') { $('panelLogs').classList.add('active'); loadLogs(); }
      else if (sec === 'admin') { $('panelAdmin').classList.add('active'); }
      else { $('panelLists').classList.add('active'); renderSpecialList(sec); }
  }

  // --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø®Ø§ØµØ© ---
  function renderSpecialList(type) {
      const c = $('listContainer');
      const title = $('listTitle');
      c.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
      
      let list = [];
      const today = new Date();

      allUnits.forEach(u => {
          const d = u.data || {};
          if(d.info?.name && d.finance?.payments?.length > 0) {
              const lastPay = new Date(d.finance.payments[d.finance.payments.length-1].date);
              const diffDays = Math.floor((today - lastPay) / (1000 * 60 * 60 * 24));
              
              if(type === 'late' && diffDays >= 60 && diffDays < 70) list.push({u, days: diffDays});
              if(type === 'warning' && diffDays >= 70 && diffDays < 90) list.push({u, days: diffDays});
              if(type === 'cancel' && diffDays >= 90) list.push({u, days: diffDays});
          }
      });

      title.innerText = type === 'late' ? 'ğŸ”µ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† (60+)' : (type === 'warning' ? 'ğŸŸ  Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª (70+)' : 'ğŸ”´ Ø§Ù„ÙØ³Ø® (90+)');
      
      c.innerHTML = '';
      if(list.length === 0) c.innerHTML = '<p style="text-align:center;color:#888">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
      
      list.forEach(item => {
          c.innerHTML += `
          <div class="list-card type-${type === 'cancel' ? 'term' : (type === 'warning' ? 'warn' : 'late')}" onclick="openUnitFromId('${item.u.id}')">
             <div><strong>${item.u.id}</strong> - ${item.u.data.info.name}</div>
             <small>ØªØ£Ø®ÙŠØ±: ${item.days} ÙŠÙˆÙ…</small>
          </div>`;
      });
  }

  // --- Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø© (Unit View) ---
  window.openUnitFromId = (id) => {
      const u = allUnits.find(x => x.id === id);
      if(u) openUnitView(u);
  }

  function openUnitView(u) {
      document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
      $('unitView').style.display = 'block';
      
      const d = u.data || {};
      $('unitTitle').innerText = `Ø§Ù„ÙˆØ­Ø¯Ø© ${u.id}`;
      $('unitSub').innerText = d.info?.name || "ØºÙŠØ± Ù…Ø¨Ø§Ø¹";

      // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
      let total = parseFloat((d.info?.sale_price || "0").replace(/,/g,'')) || 0;
      let paid = 0;
      (d.finance?.payments || []).forEach(p => paid += parseFloat(String(p.amount).replace(/,/g,'')) || 0);
      
      $('uPaid').innerText = formatNumber(paid);
      $('uRemain').innerText = formatNumber(total - paid);
      $('uProg').innerText = (d.progress?.percent || 0) + "%";
      
      // Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
      let nextDue = "-";
      if(d.finance?.payments?.length > 0) {
          const last = new Date(d.finance.payments[d.finance.payments.length-1].date);
          last.setDate(last.getDate() + 60);
          nextDue = last.toLocaleDateString('en-GB');
      }
      $('uDue').innerText = nextDue;

      // Ø§Ù„ØªØ§Ø¨Ø§Øª
      const tabs = [
          {id:'info', name:'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª'},
          {id:'finance', name:'Ø§Ù„Ù…Ø§Ù„ÙŠØ©'},
          {id:'progress', name:'Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„'},
          {id:'media', name:'Ø§Ù„ÙˆØ³Ø§Ø¦Ø·'},
          {id:'visits', name:'Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª'}
      ];
      if(isAdmin) {
          tabs.push({id:'documents', name:'Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚'});
          tabs.push({id:'alerts', name:'Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª'});
          tabs.push({id:'notes', name:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'});
      }

      const nav = $('unitTabs');
      nav.innerHTML = '';
      tabs.forEach(t => {
          const b = document.createElement('button');
          b.className = 'tab-btn';
          b.innerText = t.name;
          b.onclick = () => {
              document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(x => x.style.display = 'none');
              b.classList.add('active');
              $(`tab_${t.id}`).style.display = 'block';
          };
          nav.appendChild(b);
      });

      // Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      renderUnitContent(u, isAdmin);
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø£ÙˆÙ„
      nav.children[0].click();
  }

  function renderUnitContent(u, isAdmin) {
      const d = u.data || {};
      const ro = !isAdmin;

      // 1. Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      $('tab_info').innerHTML = `
          <label>Ø§Ù„Ø§Ø³Ù…</label><input id="inf_name" value="${escapeHtml(d.info?.name)}" ${ro?'disabled':''}>
          <label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="inf_phone" value="${escapeHtml(d.info?.phone)}" ${ro?'disabled':''}>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</label><input id="inf_cno" value="${escapeHtml(d.info?.contract_number)}" ${ro?'disabled':''}>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯</label><input type="date" id="inf_cdate" value="${d.info?.contract_date || ''}" ${ro?'disabled':''}>
          ${isAdmin ? `<label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input id="inf_price" value="${escapeHtml(d.info?.sale_price)}" >
          <button class="btn primary" id="btnSaveInfo">Ø­ÙØ¸</button>` : ''}
      `;
      if(isAdmin) $('btnSaveInfo').onclick = () => saveUnitData(u.id, 'info');

      // 2. Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      let payRows = (d.finance?.payments || []).map((p, i) => `
          <tr>
              <td>${i+1}</td>
              <td>${p.date}</td>
              <td>${p.receipt_no}</td>
              <td>${formatNumber(p.amount)}</td>
              <td>${p.installment || '-'}</td>
              <td>${p.note || '-'}</td>
              ${isAdmin ? `<td><span style="cursor:pointer;color:red" onclick="deletePay('${u.id}',${i})">âœ–</span></td>` : ''}
          </tr>
      `).join('');
      
      $('tab_finance').innerHTML = `
          ${isAdmin ? `<button class="btn gray" onclick="addPaymentUI('${u.id}')">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>` : ''}
          <div class="table-wrapper"><table><thead><tr><th>Øª</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¯ÙØ¹Ø©</th><th>ØªÙØ§ØµÙŠÙ„</th>${isAdmin?'<th></th>':''}</tr></thead><tbody>${payRows}</tbody></table></div>
      `;

      // 3. Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ§Ø¨Ø§Øª (Ù…Ø®ØªØµØ±Ø© Ù„Ù„ØªØ±ÙƒÙŠØ²)
      // ... (Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©)
  }

  // --- Ø§Ù„Ø­ÙØ¸ ---
  async function saveUnitData(id, section) {
      const u = allUnits.find(x => x.id === id);
      let d = u.data || {};
      
      if(section === 'info') {
          d.info = {
              name: $('inf_name').value,
              phone: $('inf_phone').value,
              contract_number: $('inf_cno').value,
              contract_date: $('inf_cdate').value,
              sale_price: $('inf_price').value
          };
      }

      const { error } = await supabase.from('units').update({ data: d }).eq('id', id);
      if(!error) {
          alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
          fetchAllUnits(); // ØªØ­Ø¯ÙŠØ«
      } else {
          alert(error.message);
      }
  }

  // --- Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
  $('btnMenu').onclick = () => $('sidebar').classList.add('open');
  $('overlay').onclick = () => $('sidebar').classList.remove('open');
  $('btnCloseMenu').onclick = () => $('sidebar').classList.remove('open');
  
  $('btnBack').onclick = () => {
      $('unitView').style.display = 'none';
      if(isAdmin) $('panelHome').classList.add('active');
  };

  $('btnLogin').onclick = async () => {
      const email = $('loginEmail').value;
      const pass = $('loginPass').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error) $('loginMsg').innerText = error.message;
  };

  $('btnLogout').onclick = async () => {
      await supabase.auth.signOut();
      window.location.reload();
  };

  // --- Ø§Ù„ÙÙ„ØªØ±Ø© ---
  document.querySelectorAll('.cat-btn').forEach(b => {
      b.onclick = () => {
          document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          currentCategory = b.dataset.cat;
          renderHome();
      }
  });

  $('search').onkeyup = () => renderHome();

  // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
  initApp();

  // Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ (Global Scope) Ù„Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø§Ø¶Ø§ÙØ©
  window.deletePay = async (uid, idx) => {
      if(!confirm('Ø­Ø°ÙØŸ')) return;
      const u = allUnits.find(x => x.id === uid);
      u.data.finance.payments.splice(idx, 1);
      await supabase.from('units').update({ data: u.data }).eq('id', uid);
      openUnitView(u);
  };

  window.addPaymentUI = (uid) => {
      const date = prompt("Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
      if(!date) return;
      const rcpt = prompt("Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„:");
      const amt = prompt("Ø§Ù„Ù…Ø¨Ù„Øº:");
      const inst = prompt("Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰):");
      
      if(date && amt) {
          const u = allUnits.find(x => x.id === uid);
          if(!u.data.finance) u.data.finance = { payments: [] };
          u.data.finance.payments.push({
              date, receipt_no: rcpt, amount: amt, installment: inst
          });
          supabase.from('units').update({ data: u.data }).eq('id', uid).then(() => openUnitView(u));
      }
  };

</script>
</body>
</html>