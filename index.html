<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إدارة مدينة الأزهر</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); margin: 0; color: #333; }
        * { box-sizing: border-box; }
        
        /* شاشات النظام */
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .active-screen { display: block; }

        /* اللودر */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* تسجيل الدخول */
        #loginScreen { background: linear-gradient(135deg, var(--primary), #00251a); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .login-box { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; width: 100%; max-width: 350px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; outline: none; text-align: center; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:active { transform: scale(0.95); }

        /* الشبكة والوحدات */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative; }
        .card.sold { background: #e0f2f1; border: 1px solid var(--accent); }
        .notify { width: 10px; height: 10px; background: red; border-radius: 50%; position: absolute; top: 5px; right: 5px; display: none; }
        
        /* التبويبات */
        .tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 8px 15px; background: #eee; border-radius: 20px; border: none; cursor: pointer; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; }
        
        .tab-content { display: none; }
        .show-tab { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* الجداول */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: #eee; padding: 10px; text-align: center; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        /* زر الخروج */
        .logout-btn { background: #d32f2f; color: white; position: fixed; top: 10px; left: 10px; z-index: 100; padding: 8px 15px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight: bold;">جاري المعالجة...</p>
    </div>

    <div id="loginScreen" class="screen active-screen">
        <h1 style="margin-bottom: 5px;">مدينة الأزهر</h1>
        <p style="opacity: 0.8; margin-bottom: 30px;">نظام الإدارة</p>
        <div class="login-box">
            <input type="text" id="username" placeholder="رقم الوحدة أو اسم المشرف">
            <input type="password" id="password" placeholder="كلمة المرور">
            <button class="btn-primary" onclick="attemptLogin()">دخول</button>
        </div>
        <p id="loginError" style="color: #ff8a80; font-size: 14px; margin-top: 10px;"></p>
    </div>

    <div id="adminScreen" class="screen">
        <button class="logout-btn" onclick="logout()">خروج</button>
        <div style="display:flex; gap:10px; align-items:center;">
            <h2>لوحة الإدارة</h2>
            <input type="text" placeholder="بحث..." onkeyup="filterGrid(this.value)" style="width:150px; padding:8px;">
        </div>
        <div id="unitsGrid" class="grid"></div>
    </div>

    <div id="unitScreen" class="screen">
        <button class="logout-btn" onclick="logout()">خروج</button>
        <button onclick="goBack()" style="background:#ddd; border:none; padding:8px 15px; border-radius:8px; margin-bottom:10px;">رجوع</button>
        
        <h2 id="uTitle">الوحدة ...</h2>
        <p id="uOwner" style="color:#666; margin-top:-15px;">...</p>

        <div class="tabs">
            <button class="tab active" onclick="setTab('info')">المعلومات</button>
            <button class="tab" onclick="setTab('payments')">المالية</button>
            <button class="tab" onclick="setTab('works')">الإنجاز</button>
            <button class="tab admin-only" onclick="setTab('settings')">إعدادات</button>
        </div>

        <div id="tab-info" class="tab-content show-tab">
            <label>اسم المالك</label><input type="text" id="inpName" readonly>
            <label>السعر الكلي</label><input type="text" id="inpPrice" readonly>
            <button id="btnSaveInfo" class="btn-primary admin-only" onclick="saveUnitInfo()" style="display:none; margin-top:10px;">حفظ التعديلات</button>
        </div>

        <div id="tab-payments" class="tab-content">
            <div class="admin-only" style="display:none; background:#e0f2f1; padding:10px; border-radius:8px; margin-bottom:10px;">
                <input type="text" id="newPayAmount" placeholder="المبلغ">
                <button class="btn-primary" onclick="addPayment()">إضافة دفعة</button>
            </div>
            <table><thead><tr><th>التاريخ</th><th>المبلغ</th></tr></thead><tbody id="tblPayments"></tbody></table>
            <h3 style="text-align:center; margin-top:10px;">الواصل: <span id="totalPaid">0</span></h3>
        </div>

        <div id="tab-works" class="tab-content">
             <div class="admin-only" style="display:none; background:#e0f2f1; padding:10px; border-radius:8px; margin-bottom:10px;">
                <input type="text" id="newWorkStage" placeholder="المرحلة">
                <input type="text" id="newWorkPerc" placeholder="النسبة %">
                <button class="btn-primary" onclick="addWork()">تحديث</button>
            </div>
            <table><thead><tr><th>المرحلة</th><th>%</th></tr></thead><tbody id="tblWorks"></tbody></table>
        </div>

        <div id="tab-settings" class="tab-content">
            <label>باسوورد الوحدة</label><input type="text" id="inpPass">
            <button class="btn-primary" onclick="saveUnitPass()">تحديث</button>
        </div>
    </div>

    <script>
        // إعداد Supabase
        const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // متغيرات النظام
        let currentUser = null; // 'admin' or unitID
        let isAdmin = false;
        let currentUnitData = null;
        let allUnits = [];

        // --- دوال التنقل ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // --- تسجيل الدخول (المنطق الجديد) ---
        async function attemptLogin() {
            const u = document.getElementById('username').value.trim().toLowerCase(); // Admin is lowercase
            const p = document.getElementById('password').value.trim();
            const err = document.getElementById('loginError');
            
            if(!u || !p) return err.innerText = "أدخل البيانات كاملة";
            
            toggleLoader(true);
            err.innerText = "";

            try {
                // 1. محاولة الدخول كأدمن
                let { data: admins, error: adminErr } = await supabase
                    .from('admins')
                    .select('*')
                    .eq('username', u)
                    .eq('password', p);

                if (admins && admins.length > 0) {
                    isAdmin = true;
                    currentUser = admins[0];
                    await loadAdminDashboard();
                    return; // تم الدخول
                }

                // 2. محاولة الدخول كوحدة سكنية
                // نبحث عن الوحدة، ثم نتحقق من الباسورد المخزن داخل JSON
                // ملاحظة: لسرعة الاستجابة سنجلب الوحدة مباشرة
                const unitId = u.toUpperCase();
                let { data: units, error: unitErr } = await supabase
                    .from('units')
                    .select('*')
                    .eq('id', unitId);

                if (units && units.length > 0) {
                    const unit = units[0];
                    const settings = unit.data.settings || {};
                    // التحقق من الباسورد (الافتراضي 123456 اذا لم يوجد)
                    const savedPass = settings.pass || '123456';
                    
                    if (savedPass === p) {
                        isAdmin = false;
                        currentUser = unitId;
                        openUnitInterface(unit);
                        toggleLoader(false);
                        return;
                    }
                }

                throw new Error("بيانات الدخول غير صحيحة");

            } catch (e) {
                console.error(e);
                err.innerText = e.message || "خطأ في الاتصال";
                toggleLoader(false);
            }
        }

        // --- لوحة الأدمن ---
        async function loadAdminDashboard() {
            const { data, error } = await supabase.from('units').select('*');
            if(error) { alert("خطأ في جلب الوحدات"); toggleLoader(false); return; }
            
            allUnits = data;
            renderGrid(allUnits);
            showScreen('adminScreen');
            toggleLoader(false);
        }

        function renderGrid(units) {
            const grid = document.getElementById('unitsGrid');
            grid.innerHTML = "";
            
            // ترتيب الفئات A, B, C
            ['A', 'B', 'C'].forEach(cat => {
                for(let i=1; i<=50; i++) {
                    const id = cat + i;
                    const unit = units.find(u => u.id === id);
                    const isSold = unit && unit.data.info && unit.data.info.name;
                    
                    const div = document.createElement('div');
                    div.className = `card ${isSold ? 'sold' : ''}`;
                    div.innerHTML = `<h3>${id}</h3><small>${isSold ? unit.data.info.name : 'متاح'}</small>`;
                    div.onclick = () => fetchAndOpenUnit(id);
                    grid.appendChild(div);
                }
            });
        }

        function filterGrid(txt) {
            const items = document.querySelectorAll('.card');
            items.forEach(item => {
                if(item.innerText.toLowerCase().includes(txt.toLowerCase())) item.style.display = 'block';
                else item.style.display = 'none';
            });
        }

        // --- واجهة الوحدة ---
        async function fetchAndOpenUnit(id) {
            toggleLoader(true);
            // جلب أحدث بيانات للوحدة
            const { data } = await supabase.from('units').select('*').eq('id', id).single();
            
            if (!data && isAdmin) {
                // إذا لم تكن موجودة والداخل أدمن، ننشئ هيكل فارغ للعرض
                openUnitInterface({ id: id, data: { info:{}, finance:{payments:[]}, work:[], settings:{pass:'123456'} } });
            } else {
                openUnitInterface(data);
            }
            toggleLoader(false);
        }

        function openUnitInterface(unitRow) {
            currentUnitData = unitRow;
            const d = unitRow.data || {};
            
            // تعبئة البيانات
            document.getElementById('uTitle').innerText = "الوحدة " + unitRow.id;
            document.getElementById('uOwner').innerText = d.info?.name || "غير محجوز";
            
            document.getElementById('inpName').value = d.info?.name || "";
            document.getElementById('inpPrice').value = d.info?.price || "";
            document.getElementById('inpPass').value = d.settings?.pass || "123456";

            // الجداول
            renderTable('tblPayments', d.finance?.payments || []);
            renderTable('tblWorks', d.work || []);
            
            // حساب المجموع
            let total = (d.finance?.payments || []).reduce((acc, cur) => acc + Number(cur.amount || 0), 0);
            document.getElementById('totalPaid').innerText = total.toLocaleString();

            // صلاحيات الأدمن
            if (isAdmin) {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('inpName').readOnly = false;
                document.getElementById('inpPrice').readOnly = false;
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('inpName').readOnly = true;
                document.getElementById('inpPrice').readOnly = true;
            }

            showScreen('unitScreen');
        }

        function renderTable(id, data) {
            const body = document.getElementById(id);
            body.innerHTML = "";
            if(Array.isArray(data)) {
                data.forEach(row => {
                    // ندعم الصيغتين: الكائن (object) أو المصفوفة (array)
                    let c1 = row.date || row.stage || row[0];
                    let c2 = row.amount || row.percent || row[1];
                    body.innerHTML += `<tr><td>${c1}</td><td>${c2}</td></tr>`;
                });
            }
        }

        // --- عمليات الحفظ (للأدمن) ---
        async function saveToDB() {
            toggleLoader(true);
            const { error } = await supabase
                .from('units')
                .upsert({ id: currentUnitData.id, data: currentUnitData.data });
            
            toggleLoader(false);
            if(error) alert("فشل الحفظ: " + error.message);
            else {
                // تحديث البيانات المحلية للأدمن
                if(isAdmin && allUnits.length > 0) {
                     const idx = allUnits.findIndex(u => u.id === currentUnitData.id);
                     if(idx >= 0) allUnits[idx] = currentUnitData;
                     else allUnits.push(currentUnitData);
                     renderGrid(allUnits);
                }
            }
        }

        async function saveUnitInfo() {
            if(!currentUnitData.data.info) currentUnitData.data.info = {};
            currentUnitData.data.info.name = document.getElementById('inpName').value;
            currentUnitData.data.info.price = document.getElementById('inpPrice').value;
            await saveToDB();
            alert("تم حفظ المعلومات");
        }

        async function saveUnitPass() {
            if(!currentUnitData.data.settings) currentUnitData.data.settings = {};
            currentUnitData.data.settings.pass = document.getElementById('inpPass').value;
            await saveToDB();
            alert("تم تحديث الباسورد");
        }

        async function addPayment() {
            const amt = document.getElementById('newPayAmount').value;
            if(!amt) return;
            
            if(!currentUnitData.data.finance) currentUnitData.data.finance = { payments: [] };
            if(!currentUnitData.data.finance.payments) currentUnitData.data.finance.payments = [];
            
            const today = new Date().toISOString().split('T')[0];
            currentUnitData.data.finance.payments.push({ date: today, amount: amt });
            
            await saveToDB();
            openUnitInterface(currentUnitData); // إعادة تحميل للعرض
            document.getElementById('newPayAmount').value = "";
        }

        async function addWork() {
            const stg = document.getElementById('newWorkStage').value;
            const prc = document.getElementById('newWorkPerc').value;
            if(!stg) return;

            if(!currentUnitData.data.work) currentUnitData.data.work = [];
            currentUnitData.data.work.push({ stage: stg, percent: prc });

            await saveToDB();
            openUnitInterface(currentUnitData);
            document.getElementById('newWorkStage').value = "";
        }

        // --- أدوات ---
        function setTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('show-tab'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('show-tab');
        }

        function goBack() {
            if(isAdmin) showScreen('adminScreen');
            else logout();
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            document.getElementById('username').value = "";
            document.getElementById('password').value = "";
            showScreen('loginScreen');
        }
    </script>
</body>
</html>