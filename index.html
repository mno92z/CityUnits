<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>نظام مدينة الأزهر</title>
  <style>
    :root{--p:#004d40;--a:#00bfa5;--bg:#f5f7fa;--w:#fff;--d:#d32f2f;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; color:#222;}
    *{box-sizing:border-box}
    button,input,select{font-size:16px; font-family:inherit}
    .wrap{max-width:980px; margin:0 auto; padding:14px}
    .card{background:#fff; border:1px solid #eee; border-radius:14px; padding:14px; margin:10px 0; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:var(--p); color:#fff; border:none; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eee; color:#222}
    .btn.danger{background:var(--d)}
    .pill{display:inline-block; padding:3px 10px; border-radius:999px; background:#eef; font-size:12px}
    .top{position:sticky; top:0; background:var(--bg); padding:10px 0; z-index:10}
    .title{margin:0 0 6px 0}
    .muted{opacity:.8; font-size:13px; line-height:1.6}
    .tabs{display:flex; gap:8px; overflow:auto; padding:6px 0}
    .tab{padding:10px 12px; border-radius:999px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:700; white-space:nowrap}
    .tab.active{border-color:var(--a); color:var(--p)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px; border-bottom:1px solid #eee; text-align:center; vertical-align:top}
    th{background:#fafafa}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
    .unit{background:#fff; border:2px solid transparent; border-radius:14px; padding:12px; text-align:center; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .unit.sold{border-color:var(--a); background:#e0f2f1}
    .dot{width:10px;height:10px;border-radius:50%;background:#d00;display:inline-block;margin-inline-start:6px; vertical-align:middle}
    .hide{display:none !important}
    .ok{color:#0a7}
    .err{color:#d00}
    input,select{width:100%; padding:12px; border:1px solid #ddd; border-radius:10px}
    .sectionTitle{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#f3f3f3; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2 class="title">نظام مدينة الأزهر</h2>
      <div class="muted" id="whoami">...</div>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h3 class="title">تسجيل الدخول</h3>
      <div class="row">
        <input id="email" type="email" placeholder="الايميل" autocomplete="email" />
        <input id="pass" type="password" placeholder="كلمة المرور" autocomplete="current-password" />
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnLogin">دخول</button>
        <button class="btn gray" id="btnReset">نسيت كلمة المرور</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        * الدخول بالإيميل (Supabase Auth). الحسابات ينشئها السوبر من داخل النظام.
      </div>
      <div id="loginMsg" class="muted"></div>
    </div>

    <!-- APP -->
    <div id="app" class="hide">

      <div class="card">
        <div class="sectionTitle">
          <div>
            <b>لوحة التحكم</b>
            <span class="pill" id="rolePill">role: ...</span>
          </div>
          <button class="btn danger" id="btnLogout">تسجيل خروج</button>
        </div>

        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="unitsTab">الوحدات</button>
          <button class="tab" data-tab="myUnitTab" id="myUnitBtn">وحدتي</button>
          <button class="tab hide" data-tab="accountsTab" id="accountsBtn">الحسابات</button>
          <button class="tab hide" data-tab="logsTab" id="logsBtn">السجل</button>
        </div>
      </div>

      <!-- UNITS (admin/super) -->
      <div class="card hide" id="unitsTab">
        <div class="sectionTitle">
          <h3 class="title" style="margin:0">الوحدات</h3>
          <input id="unitSearch" placeholder="بحث A1 / B12 ..." style="max-width:280px" />
        </div>
        <div class="grid" id="unitsGrid"></div>
      </div>

      <!-- MY UNIT (user) -->
      <div class="card hide" id="myUnitTab">
        <h3 class="title">وحدتي</h3>
        <div id="myUnitBox" class="muted">...</div>
      </div>

      <!-- ACCOUNTS (super only) -->
      <div class="card hide" id="accountsTab">
        <h3 class="title">إنشاء حساب (سوبر فقط)</h3>

        <div class="card" style="background:#fbfbfb">
          <b>إنشاء مستفيد + ربط وحدة</b>
          <div class="row" style="margin-top:10px;">
            <input id="u_email" placeholder="Email المستفيد" />
            <input id="u_pass" placeholder="Password" />
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="u_unit" placeholder="Unit ID مثل A1" />
            <select id="u_role">
              <option value="user">user (مستفيد)</option>
              <option value="admin">admin (أدمن)</option>
            </select>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btnCreateUser">إنشاء الحساب</button>
            <button class="btn gray" id="btnQuickAdmin">إنشاء أدمن سريع</button>
          </div>
          <div id="createMsg" class="muted"></div>
          <div class="muted">
            * هذا ينادي Edge Function: <span class="kbd">admin-create-user</span><br/>
            * إذا role=admin ما يحتاج وحدة.
          </div>
        </div>
      </div>

      <!-- LOGS (admin/super) -->
      <div class="card hide" id="logsTab">
        <div class="sectionTitle">
          <h3 class="title" style="margin:0">سجل النشاط (audit_logs)</h3>
          <button class="btn gray" id="btnRefreshLogs">تحديث</button>
        </div>
        <div class="muted">يعرض آخر 50 سطر. (منو سوّى شنو وشنو تغيّر)</div>
        <div style="overflow:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>الوقت</th>
                <th>action</th>
                <th>table</th>
                <th>record</th>
                <th>actor</th>
                <th>changes</th>
              </tr>
            </thead>
            <tbody id="logsBody"></tbody>
          </table>
        </div>
        <div id="logsMsg" class="muted"></div>
      </div>

      <!-- UNIT EDIT (admin/super) -->
      <div class="card hide" id="unitEditCard">
        <div class="sectionTitle">
          <h3 class="title" style="margin:0">تفاصيل الوحدة: <span id="unitIdLabel"></span></h3>
          <button class="btn gray" id="btnBackUnits">رجوع</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="card" style="margin:0">
            <b>معلومات المستفيد</b>
            <label class="muted">الاسم</label>
            <input id="info_name" />
            <label class="muted">الهاتف</label>
            <input id="info_phone" />
            <label class="muted">السعر الكلي</label>
            <input id="info_total" type="number" />
            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnSaveUnit">حفظ</button>
              <button class="btn danger" id="btnClearUnit">تفريغ بيانات</button>
            </div>
            <div id="unitMsg" class="muted"></div>
          </div>

          <div class="card" style="margin:0">
            <b>ربط وحدة بالمستفيد</b>
            <div class="muted">هنا تربط user_id للوحدة (يدويًا) إذا تحتاج</div>
            <label class="muted">UUID للمستفيد</label>
            <input id="link_userid" placeholder="UUID from Auth Users" />
            <button class="btn" style="margin-top:10px" id="btnLinkUser">ربط</button>
            <div id="linkMsg" class="muted"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ✅ معلومات مشروعك (حسب ما رسلت)
  const SUPABASE_URL = "https://csaqawviitdrjzeasmne.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ";
  const FUNCTION_NAME = "admin-create-user";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // UI
  const el = (id) => document.getElementById(id);
  const show = (id, on=true) => el(id).classList.toggle("hide", !on);
  const setMsg = (id, msg, type="") => { el(id).className = "muted " + (type||""); el(id).innerText = msg || ""; };

  // State
  let me = null;            // auth user
  let profile = null;       // {id, role}
  let isAdmin = false;
  let isSuper = false;
  let currentUnitId = null;
  let unitsCache = {};      // id -> row

  // Tabs
  function activateTab(tabId){
    ["unitsTab","myUnitTab","accountsTab","logsTab"].forEach(t => show(t,false));
    show(tabId,true);
    document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add("active");
  }

  // Auth helpers
  async function loadSession(){
    const { data: { session } } = await supabase.auth.getSession();
    me = session?.user || null;
    return session;
  }

  async function loadProfile(){
    if (!me) return null;
    const { data, error } = await supabase
      .from("profiles")
      .select("id, role")
      .eq("id", me.id)
      .single();

    if (error) throw error;
    profile = data;
    isSuper = profile.role === "super";
    isAdmin = profile.role === "admin" || isSuper;
    return profile;
  }

  function renderWho(){
    if (!me){
      el("whoami").innerText = "غير مسجل دخول";
      return;
    }
    el("whoami").innerHTML = `داخل كـ <b>${me.email}</b> | user_id: <span class="kbd">${me.id}</span>`;
    el("rolePill").innerText = `role: ${profile?.role || "?"}`;
  }

  async function route(){
    await loadSession();
    if (!me){
      show("loginCard", true);
      show("app", false);
      renderWho();
      return;
    }
    try{
      await loadProfile();
    }catch(e){
      // إذا ماكو profile أو RLS غلط
      show("loginCard", true);
      show("app", false);
      renderWho();
      setMsg("loginMsg", "حسابك مسجل لكن ماكو role مضبوط بجدول profiles. راجع السوبر.", "err");
      return;
    }

    show("loginCard", false);
    show("app", true);
    renderWho();

    // tabs visibility
    show("accountsBtn", isSuper);
    show("logsBtn", isAdmin);
    show("myUnitBtn", !isAdmin); // user only

    // default tab
    if (isAdmin){
      activateTab("unitsTab");
      await loadUnits();
    } else {
      activateTab("myUnitTab");
      await loadMyUnit();
    }
  }

  // Login
  el("btnLogin").onclick = async () => {
    setMsg("loginMsg", "جاري الدخول...");
    const email = el("email").value.trim();
    const pass = el("pass").value.trim();
    if (!email || !pass) return setMsg("loginMsg", "اكتب الايميل والباسورد", "err");

    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) return setMsg("loginMsg", "فشل الدخول: " + error.message, "err");
    setMsg("loginMsg", "");
    await route();
  };

  el("btnReset").onclick = async () => {
    const email = el("email").value.trim();
    if (!email) return setMsg("loginMsg", "اكتب الايميل أولاً", "err");
    const { error } = await supabase.auth.resetPasswordForEmail(email);
    if (error) return setMsg("loginMsg", "خطأ: " + error.message, "err");
    setMsg("loginMsg", "تم إرسال رابط تغيير الباسورد للإيميل.");
  };

  el("btnLogout").onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };

  // Tabs clicks
  document.querySelectorAll(".tab").forEach(btn => {
    btn.onclick = async () => {
      const tabId = btn.dataset.tab;
      activateTab(tabId);

      if (tabId === "unitsTab") await loadUnits();
      if (tabId === "myUnitTab") await loadMyUnit();
      if (tabId === "logsTab") await loadLogs();
    };
  });

  // Units load (admin/super)
  async function loadUnits(){
    show("unitEditCard", false);
    show("unitsTab", true);
    const { data, error } = await supabase
      .from("units")
      .select("id, user_id, data");
    if (error) return alert("خطأ جلب الوحدات: " + error.message);

    unitsCache = {};
    (data || []).forEach(r => unitsCache[r.id] = r);

    renderUnitsGrid("");
  }

  function isSoldUnit(row){
    const name = row?.data?.info?.name || "";
    return String(name).trim().length > 0;
  }

  function hasPendingVisit(row){
    const visits = row?.data?.visits || [];
    return Array.isArray(visits) && visits.some(v => v?.status === "pending");
  }

  function renderUnitsGrid(filter){
    const g = el("unitsGrid");
    g.innerHTML = "";
    const keys = Object.keys(unitsCache).sort((a,b)=>a.localeCompare(b, 'en', {numeric:true}));

    keys.forEach(id => {
      if (filter && !id.toLowerCase().includes(filter.toLowerCase())) return;
      const row = unitsCache[id];
      const sold = isSoldUnit(row);
      const pending = hasPendingVisit(row);

      const div = document.createElement("div");
      div.className = "unit" + (sold ? " sold" : "");
      div.innerHTML = `<b>${id}</b><div class="muted" style="margin-top:6px">${sold ? (row.data?.info?.name || "مباع") : "متاح"} ${pending ? '<span class="dot" title="طلب زيارة"></span>' : ''}</div>`;
      div.onclick = () => openUnitEditor(id);
      g.appendChild(div);
    });
  }

  el("unitSearch").oninput = (e) => renderUnitsGrid(e.target.value);

  // Unit editor
  function openUnitEditor(id){
    currentUnitId = id;
    const row = unitsCache[id] || { id, user_id: null, data: {} };
    show("unitsTab", false);
    show("unitEditCard", true);

    el("unitIdLabel").innerText = id;
    el("info_name").value  = row.data?.info?.name  || "";
    el("info_phone").value = row.data?.info?.phone || "";
    el("info_total").value = row.data?.totalPrice  || 0;

    el("link_userid").value = row.user_id || "";
    setMsg("unitMsg", "");
    setMsg("linkMsg", "");
  }

  el("btnBackUnits").onclick = async () => {
    show("unitEditCard", false);
    activateTab("unitsTab");
    await loadUnits();
  };

  el("btnSaveUnit").onclick = async () => {
    if (!currentUnitId) return;
    setMsg("unitMsg", "جاري الحفظ...");
    const row = unitsCache[currentUnitId] || { id: currentUnitId, user_id: null, data: {} };
    const data = row.data || {};
    data.info = data.info || {};
    data.info.name = el("info_name").value;
    data.info.phone = el("info_phone").value;
    data.totalPrice = Number(el("info_total").value || 0);

    const { error } = await supabase.from("units").update({ data }).eq("id", currentUnitId);
    if (error) return setMsg("unitMsg", "خطأ: " + error.message, "err");
    setMsg("unitMsg", "تم الحفظ ✅", "ok");
  };

  el("btnClearUnit").onclick = async () => {
    if (!currentUnitId) return;
    if (!confirm("متأكد تريد تفريغ بيانات الوحدة؟")) return;
    const { error } = await supabase.from("units").update({ data: {} }).eq("id", currentUnitId);
    if (error) return setMsg("unitMsg", "خطأ: " + error.message, "err");
    setMsg("unitMsg", "تم التفريغ ✅", "ok");
  };

  el("btnLinkUser").onclick = async () => {
    if (!currentUnitId) return;
    const uid = el("link_userid").value.trim();
    if (!uid) return setMsg("linkMsg", "اكتب UUID", "err");
    setMsg("linkMsg", "جاري الربط...");
    const { error } = await supabase.from("units").update({ user_id: uid }).eq("id", currentUnitId);
    if (error) return setMsg("linkMsg", "خطأ: " + error.message, "err");
    setMsg("linkMsg", "تم الربط ✅", "ok");
  };

  // My Unit (user)
  async function loadMyUnit(){
    el("myUnitBox").innerText = "جاري...";
    const { data, error } = await supabase
      .from("units")
      .select("id, data")
      .eq("user_id", me.id)
      .maybeSingle();

    if (error) return el("myUnitBox").innerText = "خطأ: " + error.message;
    if (!data) return el("myUnitBox").innerText = "ماكو وحدة مربوطة بحسابك. راجع الإدارة.";

    const name  = data.data?.info?.name || "-";
    const phone = data.data?.info?.phone || "-";
    const total = data.data?.totalPrice || 0;

    el("myUnitBox").innerHTML = `
      <div class="card" style="margin:0">
        <b>Unit:</b> ${data.id}<br/>
        <b>الاسم:</b> ${name}<br/>
        <b>الهاتف:</b> ${phone}<br/>
        <b>السعر الكلي:</b> ${total}
      </div>
      <div class="muted" style="margin-top:10px">* إذا تريد نفتح تفاصيل أكثر للمستفيد، نضيفها بسهولة.</div>
    `;
  }

  // Create account (super via edge function)
  async function createAccount(email, password, role, unitId=null){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("Not logged in");

    const res = await fetch(`${SUPABASE_URL}/functions/v1/${FUNCTION_NAME}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${session.access_token}`
      },
      body: JSON.stringify({ email, password, role, unit_id: unitId })
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text);
    return JSON.parse(text);
  }

  el("btnCreateUser").onclick = async () => {
    setMsg("createMsg", "جاري الإنشاء...");
    try{
      const email = el("u_email").value.trim();
      const pass  = el("u_pass").value.trim();
      const unit  = el("u_unit").value.trim();
      const role  = el("u_role").value;

      if (!email || !pass) return setMsg("createMsg", "اكتب email و password", "err");
      if (role === "user" && !unit) return setMsg("createMsg", "للمستفيد لازم تكتب Unit ID مثل A1", "err");

      const out = await createAccount(email, pass, role, role === "user" ? unit : null);
      setMsg("createMsg", `تم ✅ user_id: ${out.user_id}`, "ok");

      // نظف
      el("u_email").value = "";
      el("u_pass").value = "";
      el("u_unit").value = "";
    }catch(e){
      setMsg("createMsg", "فشل: " + (e?.message || e), "err");
    }
  };

  el("btnQuickAdmin").onclick = async () => {
    el("u_role").value = "admin";
    el("u_unit").value = "";
    setMsg("createMsg", "اختارنا role=admin. هسه اكتب الإيميل والباسورد واضغط إنشاء.");
  };

  // Logs
  async function loadLogs(){
    setMsg("logsMsg", "جاري...");
    const { data, error } = await supabase
      .from("audit_logs")
      .select("id, actor_id, actor_role, action, table_name, record_id, changes, created_at")
      .order("id", { ascending:false })
      .limit(50);

    if (error) return setMsg("logsMsg", "خطأ: " + error.message, "err");

    const tb = el("logsBody");
    tb.innerHTML = "";
    (data || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.action || "-"}</td>
        <td>${r.table_name || "-"}</td>
        <td>${r.record_id || "-"}</td>
        <td><div class="kbd">${(r.actor_role||"-")}<br/>${(r.actor_id||"-")}</div></td>
        <td style="text-align:left; direction:ltr; max-width:360px; overflow:auto">
          <pre style="margin:0; white-space:pre-wrap; word-break:break-word">${JSON.stringify(r.changes || {}, null, 2)}</pre>
        </td>
      `;
      tb.appendChild(tr);
    });
    setMsg("logsMsg", `تم ✅ آخر ${data?.length || 0} سطر`);
  }

  el("btnRefreshLogs").onclick = loadLogs;

  // Live auth state
  supabase.auth.onAuthStateChange(() => route());

  // Start
  route();
</script>
</body>
</html>
