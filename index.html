<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø± - ERP System</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004d40">

    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --danger: #d32f2f; --warning: #ff9800; --info: #2196f3; --text: #2c3e50; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select, textarea { font-size: 16px; outline: none; font-family: inherit; }
        
        #loadingScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General UI */
        .btn-confirm { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-cancel { width: 100%; padding: 10px; border: none; background: #eee; color: #666; margin-top: 5px; border-radius: 8px; cursor: pointer; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 14px; border-radius: 20px; font-size: 14px; cursor: pointer; }

        /* Login */
        #loginScreen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 30px; background: linear-gradient(135deg, var(--primary), #00251a); color: white; text-align: center; }
        .login-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 10px; background: rgba(255,255,255,0.95); font-weight: bold; color: #333; }
        
        /* Dashboard */
        #adminDashboard { display: none; padding: 15px; padding-bottom: 80px; }
        .top-bar { margin-bottom: 20px; }
        .admin-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .adm-stat { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .adm-stat h3 { margin: 5px 0; color: var(--primary); font-size: 18px; }
        .adm-stat small { color: #7f8c8d; font-size: 11px; font-weight: bold; }
        .adm-stat.total { grid-column: span 2; background: linear-gradient(45deg, var(--primary), #00695c); color: white; }
        .adm-stat.total small { color: #b2dfdb; }
        .search-input { width: 100%; padding: 14px; border-radius: 50px; border: 1px solid #ddd; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 4px 15px rgba(0,191,165,0.2); }

        /* Units Grid */
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .unit-card { background: white; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; transition: transform 0.2s; }
        .unit-card:active { transform: scale(0.96); }
        .unit-card.sold { border-color: var(--accent); background: #e0f2f1; }
        .unit-card h3 { margin: 0; color: var(--primary); font-size: 17px; }
        .unit-card small { color: #7f8c8d; font-size: 11px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px; }
        
        .dots-container { position: absolute; top: 4px; right: 4px; display: flex; gap: 3px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid white; }
        .dot-red { background: var(--danger); }
        .dot-blue { background: var(--info); }
        .dot-orange { background: var(--warning);}

        /* Unit Interface */
        #unitInterface { display: none; padding-bottom: 80px; }
        .unit-header { background: var(--primary); color: white; padding: 20px 20px 30px; border-radius: 0 0 30px 30px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,77,64,0.3); }
        
        .stats-scroll { display: flex; overflow-x: auto; gap: 12px; padding: 0 20px 20px; scrollbar-width: none; }
        .stat-card { min-width: 140px; padding: 15px; border-radius: 15px; color: white; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-1 { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .bg-2 { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .bg-3 { background: linear-gradient(45deg, #4CAF50, #388E3C); }
        .bg-4 { background: linear-gradient(45deg, #607D8B, #455A64); }

        .tabs-nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 5px; border-bottom: 1px solid #eee; margin-bottom: 15px; scrollbar-width: none; }
        .tab-btn { padding: 10px 15px; background: none; border: none; white-space: nowrap; color: #7f8c8d; font-weight: 600; font-size: 14px; border-radius: 20px; transition: 0.3s; }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s; }

        /* Tables & Lists */
        .table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; background: white; }
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        th { background: #f8f9fa; color: #555; font-weight: bold; }
        
        /* Media */
        .media-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .media-item { background: #fff; border-radius: 12px; height: 150px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 1px solid #eee; }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Modal & Viewer */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; }
        #imageViewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        #fullImage { max-width: 95%; max-height: 80vh; border-radius: 8px; }

        /* Admin & Logs Specific Styles */
        .admin-header-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .adm-tab { flex: 1; padding: 10px; border: none; background: none; font-weight: bold; color: #999; cursor: pointer; border-radius: 8px; }
        .adm-tab.active { background: #e0f2f1; color: var(--primary); }
        
        .log-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-right: 4px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 13px; }
        .log-item.pay { border-color: var(--bg-3); } /* Ø¯ÙØ¹Ø§Øª */
        .log-item.edit { border-color: var(--info); } /* ØªØ¹Ø¯ÙŠÙ„ */
        .log-item.del { border-color: var(--danger); } /* Ø­Ø°Ù */
        .log-meta { display: flex; justify-content: space-between; color: #888; font-size: 11px; margin-bottom: 4px; }

        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
        .unit-interface:not(.show-admin) .editable { pointer-events: none; background: #eee; color: #777; }
        
        /* Utils */
        .fab-add { position: fixed; bottom: 25px; left: 25px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 4px 15px rgba(0,77,64,0.4); z-index: 100; display: none; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .fab-add:active { transform: scale(0.9); }

        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>
<body>

<div id="loadingScreen"><div class="loader"></div><p style="margin-top:20px;font-weight:bold;color:#555">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

<div id="imageViewer">
    <div style="position:absolute;top:20px;right:20px;color:white;font-size:30px;cursor:pointer" onclick="document.getElementById('imageViewer').style.display='none'">Ã—</div>
    <div style="position:absolute;top:20px;left:20px;color:white;font-size:30px;cursor:pointer" onclick="downloadCurrentImage()">â¬‡</div>
    <img id="fullImage" src="">
</div>

<div id="loginScreen">
    <div style="margin-bottom: 30px;">
        <h1 style="margin:0;font-size:2.5em">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h1>
        <p style="opacity:0.8; letter-spacing:1px">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„</p>
    </div>
    <div class="login-box">
        <input type="text" id="loginUser" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminDashboard">
    <div class="top-bar">
        <div class="admin-stats-grid">
            <div class="adm-stat total"><small>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</small><h3 id="statTotalMoney">0</h3></div>
            <div class="adm-stat"><small>Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª Ø§Ù„ÙŠÙˆÙ…</small><h3 id="statTodayMoney">0</h3></div>
            <div class="adm-stat"><small>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</small><h3 id="statTodaySales">0</h3></div>
        </div>
        <div style="display:flex; gap:10px">
            <input type="text" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterUnits(this.value)">
            <button class="super-admin-btn" id="btnManageAdmins" onclick="openAdminsManager()" style="background:#2c3e50;color:white;border:none;border-radius:12px;padding:0 15px;display:none;font-size:20px">ğŸ› ï¸</button>
        </div>
        <button class="back-btn" style="background:var(--danger);width:100%;margin-top:15px;border-radius:10px;padding:12px" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="units-grid" id="unitsGrid"></div>
</div>

<div id="adminsModal" class="modal-overlay">
    <div class="modal-sheet" style="height: 80vh;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <h2 style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <button onclick="closeAdminsManager()" style="background:none;border:none;font-size:24px">Ã—</button>
        </div>

        <div class="admin-header-tabs">
            <button class="adm-tab active" onclick="switchAdminTab('admins')">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</button>
            <button class="adm-tab" onclick="switchAdminTab('logs')">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ğŸ“‹</button>
        </div>

        <div id="tabAdminsContent">
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #eee">
                <h4 style="margin:0 0 10px 0;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h4>
                <input type="text" id="newAdminUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:5px">
                <input type="text" id="newAdminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-confirm" onclick="saveAdminUser()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
            </div>
            <h4 style="color:#666">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
            <div id="adminsListContainer"></div>
        </div>

        <div id="tabLogsContent" style="display:none">
            <div id="logsContainer">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</div>
        </div>
    </div>
</div>

<div id="unitInterface" class="unit-interface">
    <div class="unit-header">
        <div><h2 style="margin:0;" id="headerUnitTitle">...</h2><small id="headerOwner" style="opacity:0.9">...</small></div>
        <button class="back-btn" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-scroll">
        <div class="stat-card bg-1"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><h3 style="margin:5px 0" id="dispPaid">0</h3></div>
        <div class="stat-card bg-2"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><h3 style="margin:5px 0" id="dispRemain">0</h3></div>
        <div class="stat-card bg-3"><small>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 style="margin:5px 0" id="dispProg">0%</h3></div>
        <div class="stat-card bg-4"><small>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</small><h3 style="margin:5px 0; font-size:16px;" id="dispNextDue">-</h3></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('info')">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('payments')">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="tab-btn" onclick="showTab('docs')">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button> 
        <button class="tab-btn" onclick="showTab('works')">Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„</button>
        <button class="tab-btn" onclick="showTab('visits')">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('history')">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©</button>
        <button class="tab-btn" onclick="showTab('notifs')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
        <button class="tab-btn" onclick="showTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
        <button class="tab-btn admin-only" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="info" class="tab-content" style="display:block;">
        <label>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="ownerName" class="editable">
        <label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="ownerPhone" class="editable">
        <div class="admin-only" style="margin-top:20px;background:#e0f7fa;padding:15px;border-radius:10px;border:1px solid #b2dfdb">
            <label style="color:#00695c">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" id="totalPrice" onchange="saveData('price')">
        </div>
        <button class="btn-confirm admin-only" style="margin-top:20px" onclick="saveData('info')">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Ù…Ø¹ ÙˆØ§ØªØ³Ø§Ø¨)</button>
    </div>

    <div id="payments" class="tab-content"><div class="table-wrapper"><table id="payTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>ÙˆØµÙ„</th><th>Ù…Ø¨Ù„Øº</th><th>ØªÙØ§ØµÙŠÙ„</th><th></th></tr></thead><tbody></tbody></table></div></div>
    <div id="docs" class="tab-content"><div class="table-wrapper"><table id="docsTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ù…Ù„Ù</th><th></th></tr></thead><tbody></tbody></table></div></div>
    <div id="works" class="tab-content"><div class="table-wrapper"><table id="workTable"><thead><tr><th>Ù…Ø±Ø­Ù„Ø©</th><th>ØªØ§Ø±ÙŠØ®</th><th>%</th><th></th></tr></thead><tbody></tbody></table></div></div>
    <div id="visits" class="tab-content">
        <div style="background:white;padding:15px;border-radius:10px;border:1px solid #eee;margin-bottom:15px">
            <h4 style="margin:0;color:var(--primary)">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©</h4>
            <input type="date" id="reqVisitDate" style="margin-bottom:5px">
            <input type="text" id="reqVisitReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©">
            <button class="btn-confirm" onclick="submitVisitRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
        <div class="table-wrapper"><table id="visitTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø³Ø¨Ø¨</th><th>Ø­Ø§Ù„Ø©</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>
    <div id="history" class="tab-content"><div class="table-wrapper"><table id="histTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø¯Ø«</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead><tbody></tbody></table></div></div>
    <div id="notifs" class="tab-content"><div class="table-wrapper"><table id="notifTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø±Ø³Ø§Ù„Ø©</th><th></th></tr></thead><tbody></tbody></table></div></div>
    <div id="media" class="tab-content"><div class="media-grid" id="mediaGrid"></div></div>
    <div id="settings" class="tab-content">
        <label>ÙŠÙˆØ²Ø± Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="uUser"><label>Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="uPass">
        <button class="btn-confirm" onclick="saveData('settings')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>

    <button id="fabAdd" class="fab-add admin-only" onclick="openModal()">+</button>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal-sheet">
        <h3 id="modalTitle" style="margin-top:0; color:var(--primary)">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</h3>
        <div id="modalInputs"></div> 
        <div class="modal-btn-group"><button class="btn-confirm" onclick="confirmModal()">Ø­ÙØ¸</button><button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ğŸ”´ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
    const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    let db = {}, adminsDb = {}, currentUnit = null, isAdmin = false, isSuperAdmin = false, currentTab = 'info';
    let currentAdminName = 'system'; // Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡

    // --- Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
    function switchScreen(id) {
        ['loadingScreen','loginScreen','adminDashboard','unitInterface','adminsModal'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'unitInterface') {
            const ui = document.getElementById('unitInterface');
            if(isAdmin) ui.classList.add('show-admin'); else ui.classList.remove('show-admin');
        }
    }

    async function init() {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: u } = await supabase.from('units').select('*');
        if(u) u.forEach(r => db[r.id] = r.data);
        const { data: a } = await supabase.from('admins').select('*');
        if(a) a.forEach(r => adminsDb[r.username] = r);
        
        document.getElementById('loadingScreen').style.display = 'none';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸
        const savedUser = localStorage.getItem('loggedInUser');
        if (!savedUser) switchScreen('loginScreen');
        else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¨Ø³ÙŠØ·Ø©)
            if(adminsDb[savedUser.toLowerCase()]) {
                 document.getElementById('loginUser').value = savedUser;
                 // Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ùˆ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ù…Ø§Ù†ØŒ Ù‡Ù†Ø§ Ø³Ù†Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£ÙØ¶Ù„
                 switchScreen('loginScreen');
            } else {
                 // Ù„Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ù…Ù…ÙƒÙ† Ù†Ù…Ø´ÙŠÙ‡Ø§
                 switchScreen('loginScreen');
            }
        }
    }
    init();

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Logs System) ---
    async function logToSystem(action, target, details) {
        if(!isAdmin) return; // ÙÙ‚Ø· Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ³Ø¬Ù„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù„ÙˆØ¬
        const { error } = await supabase.from('logs').insert({
            admin_name: currentAdminName,
            action: action,
            target_unit: target || 'N/A',
            details: details
        });
        if(error) console.error("Log Error:", error);
    }

    window.fetchLogs = async function() {
        document.getElementById('logsContainer').innerHTML = '<div class="loader" style="width:20px;height:20px;border-width:2px;margin:20px auto"></div>';
        const { data, error } = await supabase.from('logs').select('*').order('created_at', { ascending: false }).limit(50);
        
        const container = document.getElementById('logsContainer');
        container.innerHTML = "";
        
        if(!data || data.length === 0) {
            container.innerHTML = "<p style='text-align:center;color:#999'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>";
            return;
        }

        data.forEach(log => {
            let borderClass = '';
            if(log.action.includes('Ø­Ø°Ù')) borderClass = 'del';
            else if(log.action.includes('Ù…Ø§Ù„ÙŠØ©') || log.action.includes('Ø¯ÙØ¹Ø©')) borderClass = 'pay';
            else borderClass = 'edit';

            const time = new Date(log.created_at).toLocaleString('ar-EG');
            
            container.innerHTML += `
            <div class="log-item ${borderClass}">
                <div class="log-meta">
                    <span>ğŸ‘¤ ${log.admin_name}</span>
                    <span>ğŸ•’ ${time}</span>
                </div>
                <div style="font-weight:bold;color:var(--primary)">${log.action} <span style="color:#666;font-weight:normal">(${log.target_unit})</span></div>
                <div style="margin-top:4px;color:#555">${log.details}</div>
            </div>`;
        });
    }

    window.switchAdminTab = function(tab) {
        document.querySelectorAll('.adm-tab').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tab === 'admins') {
            document.getElementById('tabAdminsContent').style.display = 'block';
            document.getElementById('tabLogsContent').style.display = 'none';
        } else {
            document.getElementById('tabAdminsContent').style.display = 'none';
            document.getElementById('tabLogsContent').style.display = 'block';
            fetchLogs();
        }
    }

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.handleLogin = function() {
        const uRaw = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        const uAdmin = uRaw.toLowerCase();
        const uUnit = uRaw.toUpperCase();

        if (adminsDb[uAdmin] && adminsDb[uAdmin].password === p) {
            isAdmin = true;
            isSuperAdmin = (adminsDb[uAdmin].role === 'super');
            currentAdminName = uAdmin; // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†
            localStorage.setItem('loggedInUser', uAdmin);
            
            currentUnit = null;
            document.getElementById('btnManageAdmins').style.display = isSuperAdmin ? 'block' : 'none';
            calcGlobalStats();
            switchScreen('adminDashboard');
            renderUnitsGrid("");
        } else if (db[uUnit]) {
            if (db[uUnit].settings && db[uUnit].settings.pass === p) {
                isAdmin = false; isSuperAdmin = false;
                currentAdminName = 'User';
                openUnit(uUnit);
            } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£");
        } else alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }

    // --- Dashboard & Grid ---
    function calcGlobalStats() {
        let totalMoney = 0;
        let todayMoney = 0;
        let todaySales = 0;
        const todayStr = new Date().toISOString().split('T')[0];

        Object.values(db).forEach(unit => {
            if(unit.payments) {
                unit.payments.forEach(p => {
                    let amount = parseFloat(String(p[2]).replace(/,/g,'')) || 0;
                    totalMoney += amount;
                    if(p[0] === todayStr) todayMoney += amount;
                });
            }
            if(unit.saleDate === todayStr) todaySales++;
        });

        document.getElementById('statTotalMoney').innerText = totalMoney.toLocaleString();
        document.getElementById('statTodayMoney').innerText = todayMoney.toLocaleString();
        document.getElementById('statTodaySales').innerText = todaySales;
    }

    window.renderUnitsGrid = function(filter) {
        if(currentUnit !== null) return;
        const grid = document.getElementById('unitsGrid'); grid.innerHTML = "";
        
        ['A','B','C'].forEach(cat => {
            for(let i=1; i<=50; i++) {
                let id = cat + i;
                if(filter && !id.toLowerCase().includes(filter.toLowerCase())) continue;
                
                let d = db[id];
                let isSold = d && d.info.name;
                
                let dotsHTML = '<div class="dots-container">';
                if(isSold) {
                    if(d.visits && d.visits.some(v => v.status === 'pending')) dotsHTML += '<div class="dot dot-red"></div>';
                    
                    let lastPayDate = null;
                    if(d.payments && d.payments.length > 0) lastPayDate = new Date(d.payments[d.payments.length-1][0]);
                    else if (d.saleDate) lastPayDate = new Date(d.saleDate);

                    if(lastPayDate) {
                        let dueDate = new Date(lastPayDate);
                        dueDate.setDate(dueDate.getDate() + 60); 
                        let today = new Date();
                        let diffTime = dueDate - today;
                        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays < 0) dotsHTML += '<div class="dot dot-blue"></div>';
                        else if (diffDays <= 10) dotsHTML += '<div class="dot dot-orange"></div>';
                    }
                }
                dotsHTML += '</div>';

                grid.innerHTML += `<div class="unit-card ${isSold?'sold':''}" onclick="openUnit('${id}')">
                    ${dotsHTML}
                    <h3>${id}</h3><small>${isSold ? d.info.name : 'Ù…ØªØ§Ø­'}</small>
                </div>`;
            }
        });
    }
    window.filterUnits = (v) => renderUnitsGrid(v);

    // --- Unit Logic ---
    window.openUnit = function(id) {
        switchScreen('unitInterface');
        currentUnit = id;
        if(!db[id]) db[id] = { info:{name:"",phone:""}, settings:{user:id, pass:"123"}, totalPrice:0, payments:[], works:[], history:[], notifs:[], media:[], visits:[], docs:[] };
        ['docs','media','history','notifs','visits','payments','works'].forEach(k => { if(!db[id][k]) db[id][k] = []; });
        loadUnitData();
        showTab('info');
    }

    window.loadUnitData = function() {
        const d = db[currentUnit];
        document.getElementById('headerUnitTitle').innerText = currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "Ù…ØªØ§Ø­";
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = formatNumber(d.totalPrice);
        document.getElementById('uUser').value = d.settings.user;
        document.getElementById('uPass').value = d.settings.pass;
        document.getElementById('ownerName').readOnly = !isAdmin;
        document.getElementById('ownerPhone').readOnly = !isAdmin;
        
        renderTable('payTable', d.payments);
        renderTable('workTable', d.works);
        renderTable('histTable', d.history);
        renderTable('notifTable', d.notifs);
        renderVisitsTable(d.visits);
        renderMediaGrid(d.media);
        renderDocsTable(d.docs);
        calcStats();
    }

    function calcStats() {
        const d = db[currentUnit];
        let total = parseFloat(String(d.totalPrice).replace(/,/g,'')) || 0;
        let paid = (d.payments||[]).reduce((a,c) => a + (parseFloat(String(c[2]).replace(/,/g,''))||0), 0);
        document.getElementById('dispPaid').innerText = formatNumber(paid);
        document.getElementById('dispRemain').innerText = formatNumber(total - paid);
        document.getElementById('dispProg').innerText = d.works.length ? d.works[d.works.length-1][2] : "0%";

        let nextDateStr = "-";
        if (d.payments && d.payments.length > 0) {
            let lastDate = new Date(d.payments[d.payments.length-1][0]);
            lastDate.setDate(lastDate.getDate() + 60);
            nextDateStr = lastDate.toLocaleDateString('en-GB');
        } else if (d.saleDate) { 
            let saleD = new Date(d.saleDate);
            saleD.setDate(saleD.getDate() + 60);
            nextDateStr = saleD.toLocaleDateString('en-GB');
        }
        document.getElementById('dispNextDue').innerText = nextDateStr;
    }

    // --- Renderers ---
    function renderTable(id, rows) {
        const tb = document.getElementById(id).querySelector('tbody'); tb.innerHTML = "";
        rows.forEach((r, i) => {
            let tr = `<tr>${r.map(c=>`<td>${c}</td>`).join('')}${isAdmin ? `<td><button onclick="delRow('${id}',${i})" style="color:red;border:none;background:none">ğŸ—‘</button></td>` : ''}</tr>`;
            tb.innerHTML += tr;
        });
    }

    function renderDocsTable(docs) {
        const tb = document.getElementById('docsTable').querySelector('tbody'); tb.innerHTML = "";
        docs.forEach((d, i) => {
            let link = `<button onclick="viewImage('${d.url}')" style="background:none;color:blue;border:none;text-decoration:underline;cursor:pointer">Ø¹Ø±Ø¶</button>`;
            tb.innerHTML += `<tr><td>${d.date}</td><td>${d.type}</td><td>${d.note}</td><td>${link}</td>${isAdmin ? `<td><button onclick="delRow('docsTable',${i})" style="color:red;border:none">ğŸ—‘</button></td>` : ''}</tr>`;
        });
    }
    
    function renderVisitsTable(visits) {
        const tb = document.getElementById('visitTable').querySelector('tbody'); tb.innerHTML = "";
        visits.forEach((v, i) => {
            let act = isAdmin ? (v.status==='pending' ? `<button onclick="setVisit(${i},'approved')">âœ”</button><button onclick="setVisit(${i},'rejected')">âœ–</button>` : `<button onclick="delRow('visitTable',${i})" style="color:red;border:none">ğŸ—‘</button>`) : '-';
            tb.innerHTML += `<tr><td>${v.date}</td><td>${v.reason}</td><td>${v.status}</td><td>${act}</td></tr>`;
        });
    }

    function renderMediaGrid(media) {
        const g = document.getElementById('mediaGrid'); g.innerHTML = "";
        media.forEach((m, i) => {
            let content = m.type === 'video' ? `<a href="${m.url}" target="_blank" style="font-size:40px">ğŸ¬</a>` : `<img src="${m.url}" onclick="viewImage('${m.url}')">`;
            g.innerHTML += `<div class="media-item">${content}${isAdmin?`<button onclick="delRow('mediaGrid',${i})" style="position:absolute;top:5px;left:5px;background:red;color:white;border:none;width:25px;height:25px;border-radius:50%;cursor:pointer">Ã—</button>`:''}</div>`;
        });
    }

    // --- Actions & Saves ---
    window.saveData = async function(context) {
        if(!currentUnit) return;
        const d = db[currentUnit];
        
        if(isAdmin && document.getElementById('ownerName')) {
            d.info.name = document.getElementById('ownerName').value;
            d.info.phone = document.getElementById('ownerPhone').value;
            d.totalPrice = document.getElementById('totalPrice').value.replace(/,/g,'');
            d.settings.user = document.getElementById('uUser').value;
            d.settings.pass = document.getElementById('uPass').value;
            
            if(!d.saleDate && d.info.name) d.saleDate = new Date().toISOString().split('T')[0];
        }
        
        const { error } = await supabase.from('units').upsert({ id: currentUnit, data: d });
        if(error) alert(error.message);
        else {
            loadUnitData();
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬
            if(context === 'info') logToSystem('ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', currentUnit, 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±');
            else if(context === 'settings') logToSystem('ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨', currentUnit, 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªÙÙŠØ¯');

            // ÙˆØ§ØªØ³Ø§Ø¨
            if(isAdmin && d.info.phone && context === 'info') {
                if(confirm("ØªÙ… Ø§Ù„Ø­ÙØ¸. Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ØŸ")) {
                    let phone = d.info.phone.replace(/[^0-9]/g, '');
                    if (phone.startsWith('0')) phone = '964' + phone.substring(1);
                    else if (!phone.startsWith('964')) phone = '964' + phone;
                    let msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${d.info.name}ØŒ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯ØªÙƒ (${currentUnit}).`;
                    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }
        }
    }

    window.confirmModal = async () => {
        const d = db[currentUnit];
        const date = document.getElementById('mDate').value;
        const note = document.getElementById('mNote') ? document.getElementById('mNote').value : '';
        let logActionType = "";
        let logDetails = "";
        
        if(currentTab === 'media' || currentTab === 'docs') {
            const file = document.getElementById('mFile').files[0];
            if(!file) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù');
            document.getElementById('upSt').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            const name = Date.now() + '_' + file.name.replace(/[^a-z0-9.]/gi, '');
            const { error } = await supabase.storage.from('media').upload(name, file);
            if(error) return alert(error.message);
            const { data } = supabase.storage.from('media').getPublicUrl(name);
            
            if(currentTab === 'media') {
                d.media.push({type:file.type.includes('video')?'video':'image', desc:document.getElementById('mDesc').value, url:data.publicUrl, date});
                logActionType = "Ø±ÙØ¹ ÙˆØ³Ø§Ø¦Ø·"; logDetails = "ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ";
            }
            else {
                d.docs.push({type:document.getElementById('mType').value, note, url:data.publicUrl, date});
                logActionType = "Ø±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø©"; logDetails = "ØªÙ… Ø±ÙØ¹ " + document.getElementById('mType').value;
            }
        }
        else if(currentTab === 'payments') {
            const amt = formatNumber(document.getElementById('mAmt').value);
            d.payments.push([date, document.getElementById('mRcpt').value, amt, note]);
            logActionType = "Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©"; logDetails = `Ù…Ø¨Ù„Øº: ${amt}ØŒ ÙˆØµÙ„: ${document.getElementById('mRcpt').value}`;
        }
        else if(currentTab === 'works') {
            const stg = document.getElementById('mStage').value;
            const prc = document.getElementById('mPerc').value;
            d.works.push([stg, date, prc+'%']);
            logActionType = "ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„"; logDetails = `Ù…Ø±Ø­Ù„Ø©: ${stg} (${prc}%)`;
        }
        else if(currentTab === 'notifs') {
            d.notifs.push([date, document.getElementById('mMsg').value]);
            logActionType = "Ø¥Ø±Ø³Ø§Ù„ ØªØ¨Ù„ÙŠØº"; logDetails = document.getElementById('mMsg').value;
        }

        const { error } = await supabase.from('units').upsert({ id: currentUnit, data: d });
        if(!error) {
            logToSystem(logActionType, currentUnit, logDetails);
            loadUnitData();
            document.getElementById('actionModal').style.display = 'none';
        } else alert(error.message);
    }

    // --- Management Functions ---
    window.delRow = async (id, i) => { 
        if(confirm('Ø­Ø°ÙØŸ')) { 
            const m={'payTable':'payments','workTable':'works','notifTable':'notifs','mediaGrid':'media','docsTable':'docs','visitTable':'visits'}; 
            const section = m[id];
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø°Ù Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„)
            const item = db[currentUnit][section][i];
            let details = "ØªÙ… Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† " + section;
            if(section === 'payments') details = `Ø­Ø°Ù Ø¯ÙØ¹Ø© Ù…Ø¨Ù„Øº: ${item[2]}`;
            
            db[currentUnit][section].splice(i,1); 
            
            const { error } = await supabase.from('units').upsert({ id: currentUnit, data: db[currentUnit] });
            if(!error) {
                logToSystem('Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª', currentUnit, details);
                loadUnitData();
            }
        }
    };

    window.setVisit = async (i, s) => { 
        db[currentUnit].visits[i].status = s; 
        const { error } = await supabase.from('units').upsert({ id: currentUnit, data: db[currentUnit] });
        if(!error) {
            logToSystem(s==='approved'?'Ù…ÙˆØ§ÙÙ‚Ø© Ø²ÙŠØ§Ø±Ø©':'Ø±ÙØ¶ Ø²ÙŠØ§Ø±Ø©', currentUnit, `Ø§Ù„Ø³Ø¨Ø¨: ${db[currentUnit].visits[i].reason}`);
            loadUnitData();
        }
    };

    window.submitVisitRequest = () => { 
        const date = document.getElementById('reqVisitDate').value;
        const reason = document.getElementById('reqVisitReason').value;
        if(!date || !reason) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø¨Ø¨');
        
        db[currentUnit].visits.push({date, reason, status:'pending'}); 
        saveData(); // Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø³Ø¬Ù„ Ù„ÙˆØ¬ Ù„Ù„Ø£Ø¯Ù…Ù† Ù„Ø£Ù† Ù‡Ø°Ø§ Ø¹Ø§Ø¯Ø© ÙŠÙØ¹Ù„Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        document.getElementById('reqVisitReason').value = "";
    };

    // --- UI Helpers ---
    window.showTab = (t) => {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        event.target.classList.add('active');
        document.getElementById('fabAdd').style.display = (isAdmin && ['payments','docs','works','media','notifs'].includes(t)) ? 'flex' : 'none';
    }

    window.openModal = () => {
        const c = document.getElementById('modalInputs');
        const t = new Date().toISOString().split('T')[0];
        document.getElementById('actionModal').style.display = 'flex';
        
        if(currentTab === 'media') c.innerHTML = `<input type="file" id="mFile"><input type="text" id="mDesc" placeholder="ÙˆØµÙ"><input type="date" id="mDate" value="${t}"><p id="upSt"></p>`;
        else if(currentTab === 'docs') c.innerHTML = `<select id="mType"><option>Ø¥Ù†Ø°Ø§Ø±</option><option>ØªØ£Ø¬ÙŠÙ„</option><option>ØªØ¹Ù‡Ø¯</option></select><input type="text" id="mNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©"><input type="file" id="mFile"><input type="date" id="mDate" value="${t}"><p id="upSt"></p>`;
        else if(currentTab === 'payments') c.innerHTML = `<input type="text" id="mRcpt" placeholder="Ø§Ù„ÙˆØµÙ„"><input type="number" id="mAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><input type="text" id="mNote" placeholder="ØªÙØ§ØµÙŠÙ„"><input type="date" id="mDate" value="${t}">`;
        else if(currentTab === 'works') {
            let ops = ""; for(let i=5;i<=100;i+=5) ops+=`<option value="${i}">${i}%</option>`;
            c.innerHTML = `<input type="text" id="mStage" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø©"><select id="mPerc">${ops}</select><input type="date" id="mDate" value="${t}">`;
        }
        else if(currentTab === 'notifs') c.innerHTML = `<input type="text" id="mMsg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©"><input type="date" id="mDate" value="${t}">`;
    }
    
    window.closeModal = () => document.getElementById('actionModal').style.display = 'none';
    window.viewImage = (u) => { document.getElementById('fullImage').src = u; document.getElementById('imageViewer').style.display = 'flex'; };
    window.downloadCurrentImage = async () => { try { const r = await fetch(document.getElementById('fullImage').src); const b = await r.blob(); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='img.jpg'; a.click(); } catch(e){ window.open(document.getElementById('fullImage').src); } };
    window.goBack = () => isAdmin ? (switchScreen('adminDashboard'), renderUnitsGrid("")) : location.reload();
    
    // --- Admin Management ---
    window.openAdminsManager = () => { if(isSuperAdmin) { switchScreen('adminsModal'); switchAdminTab('admins'); renderAdminsList(); } else alert('ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø±ÙÙˆØ¶Ø©'); };
    window.closeAdminsManager = () => switchScreen('adminDashboard');
    window.renderAdminsList = () => { 
        const c = document.getElementById('adminsListContainer'); c.innerHTML=''; 
        Object.keys(adminsDb).forEach(u => {
            const roleBadge = adminsDb[u].role === 'super' ? 'ğŸ‘‘' : 'ğŸ‘¤';
            const delBtn = adminsDb[u].role === 'super' ? '' : `<button onclick="deleteAdmin('${u}')" style="color:white;background:var(--danger);border:none;padding:5px 10px;border-radius:5px;cursor:pointer">Ø­Ø°Ù</button>`;
            c.innerHTML += `<div style="display:flex;justify-content:space-between;background:white;padding:10px;border-bottom:1px solid #eee;align-items:center"><div>${roleBadge} <b>${u}</b> <small>(${adminsDb[u].password})</small></div>${delBtn}</div>`;
        }); 
    };
    window.saveAdminUser = async () => { 
        const u = document.getElementById('newAdminUser').value.toLowerCase(); const p = document.getElementById('newAdminPass').value; 
        if(!u || !p) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        await supabase.from('admins').upsert({username:u, password:p, role:'editor'}); 
        adminsDb[u]={username:u,password:p,role:'editor'}; 
        logToSystem('Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù†', 'Ø§Ù„Ù†Ø¸Ø§Ù…', `ØªÙ… Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† ${u}`);
        renderAdminsList(); 
        alert('ØªÙ…'); 
    };
    window.deleteAdmin = async (u) => { 
        if(confirm('Ø­Ø°ÙØŸ')) { 
            await supabase.from('admins').delete().eq('username',u); 
            delete adminsDb[u]; 
            logToSystem('Ø­Ø°Ù Ø£Ø¯Ù…Ù†', 'Ø§Ù„Ù†Ø¸Ø§Ù…', `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù† ${u}`);
            renderAdminsList(); 
        } 
    };
    
    function formatNumber(n) { return n ? Number(String(n).replace(/,/g,'')).toLocaleString('en-US') : "0"; }

    // --- Enter Key ---
    document.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            if (document.getElementById('loginScreen').style.display !== 'none') handleLogin();
            else if (document.getElementById('actionModal').style.display === 'flex') confirmModal();
            else if (document.getElementById('adminsModal').style.display === 'flex' && document.getElementById('tabAdminsContent').style.display !== 'none') saveAdminUser();
        }
    });
</script>
</body>
</html>