<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>نظام إدارة الوحدات السكنية</title>

<style>
body{
  margin:0;
  font-family:Tahoma, Arial, sans-serif;
  background:#f5f5f5;
}
.hide{display:none}
header{
  background:#2e7d32;
  color:#fff;
  padding:12px;
  font-size:18px;
}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:8px 12px;
  cursor:pointer;
}
input,textarea{
  width:100%;
  padding:6px;
  margin-top:4px;
}
.card{
  background:#fff;
  margin:10px;
  padding:12px;
  border:1px solid #ddd;
}
.units{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:8px;
  padding:10px;
}
.unit{
  background:#fff;
  border:1px solid #ccc;
  padding:10px;
  text-align:center;
  cursor:pointer;
}
.unit.sold{
  background:#e8f5e9;
  border-color:#2e7d32;
}
.tabs{
  display:flex;
  gap:6px;
  margin:10px;
}
.tab{
  padding:6px 10px;
  border:1px solid #ccc;
  cursor:pointer;
}
.tab.active{
  background:#2e7d32;
  color:#fff;
}
</style>
</head>

<body>

<header>إدارة الوحدات السكنية</header>

<div id="login" class="card">
  <input id="email" placeholder="الايميل">
  <input id="password" type="password" placeholder="كلمة المرور">
  <button onclick="login()">دخول</button>
</div>

<div id="main" class="hide">

  <div id="unitsView">
    <div class="units" id="unitsGrid"></div>
  </div>

  <div id="unitView" class="hide">

    <div class="tabs">
      <div class="tab active" data-tab="info">المعلومات</div>
      <div class="tab" data-tab="finance">المالية</div>
      <div class="tab" data-tab="media">الوسائط</div>
    </div>

    <div id="info" class="card tabContent"></div>
    <div id="finance" class="card tabContent hide"></div>
    <div id="media" class="card tabContent hide"></div>

    <button onclick="back()">رجوع</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://csaqawviitdrjzeasmne.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ"
);

let currentUnit=null;

window.login = async ()=>{
  const {error}=await supabase.auth.signInWithPassword({
    email:email.value,
    password:password.value
  });
  if(error) alert(error.message);
  else init();
};

async function init(){
  login.classList.add("hide");
  main.classList.remove("hide");
  loadUnits();
}

function isSold(u){
  return u?.data?.info?.name && u.data.info.name.trim()!=="";
}

async function loadUnits(){
  const {data}=await supabase.from("units").select("id,data");
  unitsGrid.innerHTML="";
  data.forEach(u=>{
    const d=document.createElement("div");
    d.className="unit"+(isSold(u)?" sold":"");
    d.innerText=u.id;
    d.onclick=()=>openUnit(u);
    unitsGrid.appendChild(d);
  });
}

function openUnit(u){
  currentUnit=u;
  unitsView.classList.add("hide");
  unitView.classList.remove("hide");

  info.innerHTML=`
    <b>اسم المستفيد</b>
    <input id="name" value="${u.data?.info?.name||""}">
    <button onclick="save()">حفظ</button>
  `;

  finance.innerHTML="<pre>"+JSON.stringify(u.data?.finance||{},null,2)+"</pre>";
  media.innerHTML="قسم الوسائط";
}

window.save = async ()=>{
  const data=currentUnit.data||{};
  data.info={name:name.value};
  await supabase.from("units").update({data}).eq("id",currentUnit.id);
  alert("تم الحفظ");
};

window.back = ()=>{
  unitView.classList.add("hide");
  unitsView.classList.remove("hide");
};

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tabContent").forEach(c=>c.classList.add("hide"));
    t.classList.add("active");
    document.getElementById(t.dataset.tab).classList.remove("hide");
  };
});

</script>
</body>
</html>
