<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004d40">

    <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† --- */
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --danger: #d32f2f; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select { font-size: 16px; outline: none; font-family: inherit; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingScreen { position: fixed; inset:0; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙƒØ¨Ø± (Ø§Ù„Ø¬Ø¯ÙŠØ¯) */
        #imageViewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        #fullImage { max-width: 95%; max-height: 80vh; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.1); object-fit: contain; }
        .close-viewer { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10001; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 30px; background: linear-gradient(135deg, var(--primary), #00251a); color: white; text-align: center; }
        .login-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.9); font-weight: bold; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: var(--primary); font-weight: 900; border: none; border-radius: 12px; margin-top: 10px; cursor: pointer; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #adminDashboard, #unitInterface { display: none; padding-bottom: 80px; }
        #adminDashboard { padding: 20px; }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª */
        .search-input { width: 100%; padding: 15px; border-radius: 50px; border: 1px solid #ddd; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .unit-card { background: white; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; }
        .unit-card.sold { border-color: var(--accent); background: #e0f2f1; }
        .unit-card h3 { margin: 0; color: var(--primary); }
        .unit-card small { color: #888; font-size: 11px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆØ­Ø¯Ø© */
        .unit-header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; }
        
        /* Ø§Ù„ØªØ§Ø¨Ø§Øª */
        .tabs-nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; scrollbar-width: none; }
        .tab-btn { padding: 10px 15px; background: none; border: none; white-space: nowrap; color: #666; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--accent); }
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
        .media-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .media-item { 
            background: #fff; border-radius: 10px; height: 160px; /* Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ */
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden; border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .media-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: 0.3s; }
        .media-item img:active { transform: scale(0.95); }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 0 20px 20px; scrollbar-width: none; }
        .stat-card { min-width: 150px; padding: 15px; border-radius: 15px; color: white; flex-shrink: 0; }
        .bg-1 { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .bg-2 { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .bg-3 { background: linear-gradient(45deg, #4CAF50, #388E3C); }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .fab-add { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none; align-items: center; justify-content: center; cursor: pointer; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; }
        .modal-sheet { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
        .btn-confirm { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-cancel { width: 100%; padding: 10px; border: none; background: #eee; color: #666; margin-top: 5px; border-radius: 10px; cursor: pointer; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
        label { font-size: 13px; color: #666; font-weight: bold; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }

        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
    </style>
</head>
<body>

<div id="loadingScreen"><div class="loader"></div></div>

<div id="imageViewer">
    <div class="close-viewer" onclick="document.getElementById('imageViewer').style.display='none'">Ã—</div>
    <img id="fullImage" src="">
</div>

<div id="loginScreen">
    <div style="margin-bottom: 30px;">
        <h1 style="margin:0;">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h1>
        <p style="opacity:0.8;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
    </div>
    <div class="login-box">
        <input type="text" id="loginUser" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminDashboard">
    <div style="position: sticky; top:0; background:var(--bg); z-index:10; padding:10px 0;">
        <input type="text" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..." onkeyup="filterUnits(this.value)">
    </div>
    <div class="units-grid" id="unitsGrid"></div>
</div>

<div id="unitInterface">
    <div class="unit-header">
        <div><h2 style="margin:0;" id="headerUnitTitle">...</h2><small id="headerOwner">...</small></div>
        <button class="back-btn" onclick="location.reload()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-scroll">
        <div class="stat-card bg-1"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><h3 style="margin:5px 0" id="dispPaid">0</h3></div>
        <div class="stat-card bg-2"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><h3 style="margin:5px 0" id="dispRemain">0</h3></div>
        <div class="stat-card bg-3"><small>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 style="margin:5px 0" id="dispProg">0%</h3></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('info')">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('payments')">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="tab-btn" onclick="showTab('docs')">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button> 
        <button class="tab-btn" onclick="showTab('works')">Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„</button>
        <button class="tab-btn" onclick="showTab('visits')">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
        <button class="tab-btn" onclick="showTab('notifs')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
        <button class="tab-btn admin-only" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="info" class="tab-content">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="ownerName" readonly>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="ownerPhone" readonly>
        <div class="admin-only">
            <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" id="totalPrice">
            <button class="login-btn" style="margin-top:10px" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="payments" class="tab-content">
        <div class="table-wrapper"><table id="payTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>ÙˆØµÙ„</th><th>Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="docs" class="tab-content">
        <div class="table-wrapper"><table id="docsTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ù…Ù„Ù</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="works" class="tab-content">
        <div class="table-wrapper"><table id="workTable"><thead><tr><th>Ù…Ø±Ø­Ù„Ø©</th><th>ØªØ§Ø±ÙŠØ®</th><th>%</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="visits" class="tab-content">
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px;">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©</h4>
            <input type="date" id="reqVisitDate"><input type="text" id="reqVisitReason" placeholder="Ø§Ù„Ø³Ø¨Ø¨">
            <button class="login-btn" onclick="submitVisitRequest()" style="margin-top:10px">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
        <div class="table-wrapper"><table id="visitTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø§Ù„Ø©</th><th></th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="media" class="tab-content"><div class="media-grid" id="mediaGrid"></div></div>
    <div id="notifs" class="tab-content"><div class="table-wrapper"><table id="notifTable"><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø±Ø³Ø§Ù„Ø©</th><th></th></tr></thead><tbody></tbody></table></div></div>
    
    <div id="settings" class="tab-content">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="uUser"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="text" id="uPass">
        <button class="login-btn" onclick="saveData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>

    <button id="fabAdd" class="fab-add admin-only" onclick="openModal()">+</button>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal-sheet">
        <h3 id="modalTitle" style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</h3>
        <div id="modalInputs"></div> 
        <button class="btn-confirm" onclick="confirmModal()">Ø­ÙØ¸</button>
        <button class="btn-cancel" onclick="document.getElementById('actionModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ğŸ”´ğŸ”´ğŸ”´ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¨Ø· (ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§) ğŸ”´ğŸ”´ğŸ”´
    const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    let db = {}, adminsDb = {}, currentUnit = null, isAdmin = false, currentTab = 'info';

    // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    async function init() {
        // Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        const { data: u } = await supabase.from('units').select('*');
        if(u) u.forEach(r => db[r.id] = r.data);
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†ÙŠØ©
        const { data: a } = await supabase.from('admins').select('*');
        if(a) a.forEach(r => adminsDb[r.username] = r);

        document.getElementById('loadingScreen').style.display = 'none';
    }
    init();

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.handleLogin = function() {
        const u = document.getElementById('loginUser').value.toLowerCase().trim();
        const p = document.getElementById('loginPass').value.trim();
        if(adminsDb[u] && adminsDb[u].password === p) {
            isAdmin = true;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderUnitsGrid();
        } else if(db[u] && db[u].settings.pass === p) {
            isAdmin = false;
            openUnit(u);
        } else alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    }

    // --- Ø¹Ø±Ø¶ Ø´Ø¨ÙƒØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª ---
    window.renderUnitsGrid = function(filter = "") {
        const grid = document.getElementById('unitsGrid'); grid.innerHTML = "";
        ['A','B','C'].forEach(c => {
            for(let i=1; i<=50; i++) {
                let id = c+i;
                if(filter && !id.toLowerCase().includes(filter.toLowerCase())) continue;
                let d = db[id];
                let sold = d && d.info.name;
                grid.innerHTML += `<div class="unit-card ${sold?'sold':''}" onclick="openUnit('${id}')">
                    <h3>${id}</h3><small>${sold ? d.info.name : 'Ù…ØªØ§Ø­'}</small>
                </div>`;
            }
        });
    }

    // --- ÙØªØ­ ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ---
    window.openUnit = function(id) {
        currentUnit = id;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('unitInterface').style.display = 'block';
        document.getElementById('unitInterface').className = isAdmin ? 'show-admin' : '';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±Øº Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if(!db[id]) db[id] = { info:{name:"",phone:""}, settings:{user:id, pass:"123"}, totalPrice:0, payments:[], works:[], history:[], notifs:[], media:[], visits:[], docs:[] };
        ['docs', 'media', 'history', 'notifs', 'visits', 'payments', 'works'].forEach(k => { if(!db[id][k]) db[id][k] = []; });
        
        loadUnitData();
        showTab('info');
    }

    // --- Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ---
    window.loadUnitData = function() {
        const d = db[currentUnit];
        document.getElementById('headerUnitTitle').innerText = currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "";
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = d.totalPrice;
        document.getElementById('uUser').value = d.settings.user;
        document.getElementById('uPass').value = d.settings.pass;
        if(!isAdmin) {
             document.getElementById('ownerName').readOnly = true;
             document.getElementById('ownerPhone').readOnly = true;
        }
        
        renderTable('payTable', d.payments);
        renderTable('workTable', d.works);
        renderTable('notifTable', d.notifs);
        renderDocsTable(d.docs); 
        renderMediaGrid(d.media);
        renderVisitTable(d.visits);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        let paid = (d.payments||[]).reduce((a,c)=>a+(Number(String(c[2]).replace(/,/g,''))||0),0);
        document.getElementById('dispPaid').innerText = paid.toLocaleString();
        document.getElementById('dispRemain').innerText = ((Number(String(d.totalPrice).replace(/,/g,''))||0) - paid).toLocaleString();
        document.getElementById('dispProg').innerText = d.works.length ? d.works[d.works.length-1][2] : "0%";
    }

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶ ---
    function renderTable(id, rows) {
        const tb = document.getElementById(id).querySelector('tbody'); tb.innerHTML = "";
        rows.forEach((r, i) => {
            let tr = `<tr>${r.map(c=>`<td>${c}</td>`).join('')}${isAdmin ? `<td><button onclick="delRow('${id}',${i})" style="color:red;border:none;background:none">Ã—</button></td>` : ''}</tr>`;
            tb.innerHTML += tr;
        });
    }

    function renderDocsTable(docs) {
        const tb = document.getElementById('docsTable').querySelector('tbody'); tb.innerHTML = "";
        docs.forEach((d, i) => {
            let link = `<button onclick="viewImage('${d.url}')" style="background:none;border:none;color:blue;text-decoration:underline;cursor:pointer;font-weight:bold;">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</button>`;
            tb.innerHTML += `<tr><td>${d.date}</td><td>${d.type}</td><td>${d.note}</td><td>${link}</td>${isAdmin ? `<td><button onclick="delRow('docsTable',${i})" style="color:red;border:none;background:none">Ã—</button></td>` : ''}</tr>`;
        });
    }

    function renderMediaGrid(media) {
        const g = document.getElementById('mediaGrid'); g.innerHTML = "";
        media.forEach((m, i) => {
            let content = '';
            if (m.type === 'video') {
                content = `<a href="${m.url}" target="_blank" style="font-size:40px;text-decoration:none;">ğŸ¬</a>`;
            } else {
                content = `<img src="${m.url}" onclick="viewImage('${m.url}')">`;
            }
            
            g.innerHTML += `
            <div class="media-item">
                ${content}
                ${isAdmin ? `<button onclick="delRow('mediaGrid',${i})" style="position:absolute;top:5px;left:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;">Ã—</button>` : ''}
            </div>`;
        });
    }

    function renderVisitTable(visits) {
        const tb = document.getElementById('visitTable').querySelector('tbody'); tb.innerHTML = "";
        visits.forEach((v, i) => {
            tb.innerHTML += `<tr><td>${v.date}</td><td>${v.status}</td>${isAdmin ? `<td><button onclick="delRow('visitTable',${i})" style="color:red;border:none">Ã—</button></td>` : ''}</tr>`;
        });
    }

    // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ¨Ø±Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
    window.viewImage = function(url) {
        if(!url) return;
        document.getElementById('fullImage').src = url;
        document.getElementById('imageViewer').style.display = 'flex';
    }

    // --- Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
    window.showTab = (t) => {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        event.target.classList.add('active');
        document.getElementById('fabAdd').style.display = (isAdmin && ['payments','docs','works','media','notifs'].includes(t)) ? 'flex' : 'none';
    }

    // --- ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---
    window.openModal = () => {
        const inputs = document.getElementById('modalInputs');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('actionModal').style.display = 'flex';
        
        if(currentTab === 'media') {
            inputs.innerHTML = `<label>ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ</label><input type="file" id="mFile"><input type="text" id="mDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><input type="date" id="mDate" value="${today}"><p id="uploadStat" style="color:blue"></p>`;
        } else if(currentTab === 'docs') { 
            inputs.innerHTML = `<label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label><select id="mType"><option>Ø¥Ù†Ø°Ø§Ø±</option><option>ØªØ£Ø¬ÙŠÙ„</option><option>ØªØ¹Ù‡Ø¯</option><option>Ø£Ø®Ø±Ù‰</option></select><input type="text" id="mNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"><label>ØµÙˆØ±Ø© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label><input type="file" id="mFile"><input type="date" id="mDate" value="${today}"><p id="uploadStat" style="color:blue"></p>`;
        } else if(currentTab === 'payments') {
            inputs.innerHTML = `<input type="text" id="mRcpt" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„"><input type="number" id="mAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><input type="text" id="mNote" placeholder="ØªÙØ§ØµÙŠÙ„"><input type="date" id="mDate" value="${today}">`;
        } else if(currentTab === 'works') {
             inputs.innerHTML = `<input type="text" id="mStage" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ù…Ø«Ù„Ø§Ù‹: ØµØ¨ Ø§Ù„Ø³Ù‚Ù)"><input type="number" id="mPerc" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² %"><input type="date" id="mDate" value="${today}">`;
        } else if(currentTab === 'notifs') {
             inputs.innerHTML = `<input type="text" id="mMsg" placeholder="Ù†Øµ Ø§Ù„ØªØ¨Ù„ÙŠØº"><input type="date" id="mDate" value="${today}">`;
        }
    }

    // --- ØªÙ†ÙÙŠØ° Ø§Ù„Ø­ÙØ¸ (ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª) ---
    window.confirmModal = async () => {
        const d = db[currentUnit];
        const date = document.getElementById('mDate').value;
        
        if(currentTab === 'media' || currentTab === 'docs') {
            const file = document.getElementById('mFile').files[0];
            if(!file) return alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù!');
            document.getElementById('uploadStat').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...';
            
            const name = Date.now() + '_' + file.name.replace(/[^a-z0-9.]/gi, '');
            const { error: upErr } = await supabase.storage.from('media').upload(name, file);
            if(upErr) {
                alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + upErr.message);
                document.getElementById('uploadStat').innerText = '';
                return;
            }
            
            const { data: { publicUrl } } = supabase.storage.from('media').getPublicUrl(name);
            
            if(currentTab === 'media') {
                d.media.push({ type: file.type.includes('video')?'video':'image', url: publicUrl, date: date });
            } else {
                d.docs.push({ type: document.getElementById('mType').value, note: document.getElementById('mNote').value, url: publicUrl, date: date });
            }
        } 
        else if(currentTab === 'payments') {
            d.payments.push([date, document.getElementById('mRcpt').value, Number(document.getElementById('mAmt').value).toLocaleString(), document.getElementById('mNote').value]);
        }
        else if(currentTab === 'works') d.works.push([document.getElementById('mStage').value, date, document.getElementById('mPerc').value+'%']);
        else if(currentTab === 'notifs') d.notifs.push([date, document.getElementById('mMsg').value]);

        saveData();
        document.getElementById('actionModal').style.display = 'none';
    }

    // --- Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase ---
    window.saveData = async () => {
        if(!currentUnit) return;
        const d = db[currentUnit];
        if(document.getElementById('ownerName')) {
             d.info.name = document.getElementById('ownerName').value;
             d.info.phone = document.getElementById('ownerPhone').value;
             d.totalPrice = document.getElementById('totalPrice').value;
        }
        
        const { error } = await supabase.from('units').upsert({ id: currentUnit, data: d });
        if(error) alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸! ØªØ£ÙƒØ¯ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ jsonb ÙÙŠ Supabase");
        else {
            if(document.getElementById('uploadStat')) document.getElementById('uploadStat').innerText = 'ØªÙ… Ø§Ù„Ø­ÙØ¸!';
            loadUnitData(); 
        }
    }

    // --- Ø­Ø°Ù ØµÙ ---
    window.delRow = (table, i) => {
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
        const map = {'payTable':'payments','workTable':'works','notifTable':'notifs','mediaGrid':'media','docsTable':'docs','visitTable':'visits'};
        db[currentUnit][map[table]].splice(i, 1);
        saveData();
    }
    
    // --- Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© ---
    window.submitVisitRequest = () => {
        db[currentUnit].visits.push({date:document.getElementById('reqVisitDate').value, status:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'});
        saveData();
        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
    }
</script>
</body>
</html>