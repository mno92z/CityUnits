<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyCR6JSg3nHpicIgY0140H2f4j_9ip1ArYo",
      authDomain: "azhar-city.firebaseapp.com",
      projectId: "azhar-city",
      storageBucket: "azhar-city.firebasestorage.app",
      messagingSenderId: "348703246018",
      appId: "1:348703246018:web:941d64ca991a72bb825d5b"
    };

    const app = initializeApp(firebaseConfig);
    const dbRealtime = getDatabase(app);
    const storage = getStorage(app);
    
    let db = {}; 
    let currentUnit = null;
    let isAdmin = false;
    let currentTab = 'info';

    // --- Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ---
    function switchScreen(screenId) {
        // Ù‚Ø§Ø¦Ù…Ø© Ø¨ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
        const screens = ['loadingScreen', 'loginScreen', 'adminDashboard', 'unitInterface'];
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ù…ÙŠØ¹
        screens.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·
        const target = document.getElementById(screenId);
        if(target) target.style.display = 'block';
        
        // Ø§Ù„ØµØ¹ÙˆØ¯ Ù„Ù„Ø£Ø¹Ù„Ù‰
        window.scrollTo(0, 0);
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dbRef = ref(dbRealtime, 'units_db_v1');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        db = data || {};
        
        // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù†Ø®ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (document.getElementById('loadingScreen').style.display !== 'none') {
             switchScreen('loginScreen');
        }
        
        if(currentUnit) loadUnitData();
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¨ÙƒØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø¯Ù…Ù†
        if(document.getElementById('adminDashboard').style.display === 'block') {
            renderUnitsGrid(document.querySelector('.search-input').value);
        }
    });

    window.saveData = function() {
        if(!currentUnit) return;
        const d = db[currentUnit];
        d.info.name = document.getElementById('ownerName').value;
        d.info.phone = document.getElementById('ownerPhone').value;
        d.totalPrice = document.getElementById('totalPrice').value.replace(/,/g,'');
        d.settings.user = document.getElementById('uUser').value;
        d.settings.pass = document.getElementById('uPass').value;
        set(ref(dbRealtime, 'units_db_v1/' + currentUnit), d);
    }
    
    window.handleLogin = function() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        
        if (u === "admin" && p === "admin123") {
            isAdmin = true; 
            initAdminDashboard();
        } else {
            if (db[u] && db[u].settings && db[u].settings.pass === p) {
                isAdmin = false; 
                openUnit(u);
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©");
            }
        }
    }

    function initAdminDashboard() {
        switchScreen('adminDashboard'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        renderUnitsGrid("");
    }

    window.renderUnitsGrid = function(filter) {
        const grid = document.getElementById('unitsGrid'); grid.innerHTML = "";
        ['A', 'B', 'C'].forEach(cat => {
            for(let i=1; i<=50; i++) {
                let id = cat + i;
                if (filter && !id.toLowerCase().includes(filter.toLowerCase())) continue;
                let d = db[id];
                let isSold = d && d.info.name && d.info.name.trim().length > 0;
                let hasPending = d && d.visits && d.visits.some(v => v.status === 'pending');

                let div = document.createElement('div');
                div.className = `unit-card ${isSold ? 'sold' : ''} ${hasPending ? 'has-request' : ''}`;
                div.onclick = () => openUnit(id);
                div.innerHTML = `<div class="notify-dot"></div><h3>${id}</h3><small>${isSold ? d.info.name : 'Ù…ØªØ§Ø­'}</small>`;
                grid.appendChild(div);
            }
        });
    }
    window.filterUnits = (val) => renderUnitsGrid(val);

    window.openUnit = function(id) {
        currentUnit = id;
        if (!db[id]) {
            db[id] = { info: {name:"",phone:""}, settings: {user:id, pass:"123"}, totalPrice:0, payments:[], works:[], history:[], notifs:[], media:[], visits:[] };
        }
        ['history', 'notifs', 'media', 'visits', 'payments', 'works'].forEach(k => { if(!db[id][k]) db[id][k] = []; });

        switchScreen('unitInterface'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„
        document.getElementById('unitInterface').className = isAdmin ? 'show-admin' : '';
        
        loadUnitData();
        showTab('info');
    }

    window.loadUnitData = function() {
        if(!db[currentUnit]) return;
        const d = db[currentUnit];
        document.getElementById('headerUnitTitle').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø© " + currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = formatNumber(d.totalPrice);
        document.getElementById('uUser').value = d.settings.user;
        document.getElementById('uPass').value = d.settings.pass;
        document.getElementById('ownerName').readOnly = !isAdmin;
        document.getElementById('ownerPhone').readOnly = !isAdmin;

        renderTable('payTable', d.payments);
        renderTable('workTable', d.works);
        renderTable('histTable', d.history);
        renderTable('notifTable', d.notifs);
        renderVisitsTable(d.visits);
        renderMediaGrid();
        calcStats();
    }

    function renderTable(id, rows) {
        if(!rows) rows = [];
        const tb = document.getElementById(id).querySelector('tbody'); tb.innerHTML = "";
        rows.forEach((r, i) => {
            let tr = tb.insertRow();
            r.forEach(c => tr.insertCell().innerText = c);
            if(isAdmin) tr.insertCell().innerHTML = `<button onclick="delRow('${id}',${i})" style="color:red;border:none;background:none;font-size:18px">&times;</button>`;
        });
    }

    function renderVisitsTable(visits) {
        if(!visits) visits = [];
        const tb = document.getElementById('visitTable').querySelector('tbody'); tb.innerHTML = "";
        visits.forEach((v, i) => {
            let tr = tb.insertRow();
            tr.insertCell().innerText = v.date;
            tr.insertCell().innerText = v.reason;
            let statusText = v.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : (v.status === 'approved' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ù…Ø±ÙÙˆØ¶');
            let statusClass = v.status === 'pending' ? 'st-pending' : (v.status === 'approved' ? 'st-approved' : 'st-rejected');
            tr.insertCell().innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
            
            let actionTd = tr.insertCell();
            if(isAdmin) {
                if(v.status === 'pending') {
                    actionTd.innerHTML = `
                        <button class="visit-action-btn btn-approve" onclick="setVisitStatus(${i}, 'approved')">âœ”</button>
                        <button class="visit-action-btn btn-reject" onclick="setVisitStatus(${i}, 'rejected')">âœ–</button>
                    `;
                } else {
                    actionTd.innerHTML = `<button onclick="delRow('visitTable',${i})" style="color:red;border:none;background:none;">Ø­Ø°Ù</button>`;
                }
            } else actionTd.innerText = "-";
        });
    }

    window.submitVisitRequest = function() {
        const date = document.getElementById('reqVisitDate').value;
        const reason = document.getElementById('reqVisitReason').value;
        if(!date || !reason) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        
        if(!db[currentUnit].visits) db[currentUnit].visits = [];
        db[currentUnit].visits.push({ date: date, reason: reason, status: 'pending' });
        saveData();
        
        document.getElementById('reqVisitDate').value = "";
        document.getElementById('reqVisitReason').value = "";
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    }

    window.setVisitStatus = function(index, status) {
        db[currentUnit].visits[index].status = status;
        saveData();
    }

    function renderMediaGrid() {
        const g = document.getElementById('mediaGrid'); g.innerHTML = "";
        let media = db[currentUnit].media || [];
        media.forEach((m, i) => {
            let d = document.createElement('div'); d.className = 'media-item';
            
            let contentHTML = '';
            if (m.url) {
                if (m.type === 'video') {
                     contentHTML = `<a href="${m.url}" target="_blank" style="text-decoration:none; font-size:40px;">ğŸ¬</a>`;
                } else {
                     contentHTML = `<img src="${m.url}" style="width:100%; height:80px; object-fit:cover; border-radius:5px;">`;
                }
            } else {
                contentHTML = `<div class="media-icon">${m.type==='video'?'ğŸ¥':'ğŸ“·'}</div>`;
            }

            d.innerHTML = `${contentHTML}<div class="media-label">${m.desc}</div>`;
            if(isAdmin) {
                let b = document.createElement('button'); b.innerHTML='&times;';
                b.style.cssText="position:absolute;top:5px;left:5px;background:red;color:white;border:none;border-radius:50%;width:20px;height:20px;line-height:20px;padding:0;cursor:pointer;";
                b.onclick = () => { db[currentUnit].media.splice(i, 1); saveData(); };
                d.appendChild(b);
            }
            g.appendChild(d);
        });
    }

    function calcStats() {
        const d = db[currentUnit];
        let total = parseFloat(String(d.totalPrice).replace(/,/g,'')) || 0;
        let payments = d.payments || [];
        let paid = payments.reduce((a,c) => a + (parseFloat(String(c[2]).replace(/,/g,''))||0), 0);
        
        document.getElementById('dispPaid').innerText = formatNumber(paid);
        document.getElementById('dispRemain').innerText = formatNumber(total - paid);
        let works = d.works || [];
        document.getElementById('dispProg').innerText = works.length > 0 ? works[works.length-1][2] : "0%";
    }

    window.showTab = function(t) {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        
        const map = {'info':0, 'payments':1, 'works':2, 'visits':3, 'history':4, 'notifs':5, 'media':6, 'settings':7};
        if(document.querySelectorAll('.tab-btn')[map[t]]) document.querySelectorAll('.tab-btn')[map[t]].classList.add('active');

        const fab = document.getElementById('fabAdd');
        fab.style.display = (isAdmin && ['payments','works','history','notifs','media'].includes(t)) ? 'flex' : 'none';
    }

    window.openModal = function() {
        const title = document.getElementById('modalTitle');
        const content = document.getElementById('modalInputs');
        const today = new Date().toLocaleDateString('en-GB');

        if (currentTab === 'payments') {
            title.innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„ÙŠØ©";
            content.innerHTML = `<label>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</label><input type="text" id="mReceipt"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="mAmount"><label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><input type="text" id="mNote"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'works') {
            title.innerText = "ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„";
            let ops=""; for(let i=5;i<=100;i+=5) ops+=`<option value="${i}">${i}%</option>`;
            content.innerHTML = `<label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="mStage"><label>Ø§Ù„Ù†Ø³Ø¨Ø©</label><select id="mPerc" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px">${ops}</select><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'history') {
             title.innerText = "Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«";
             content.innerHTML = `<label>Ø§Ù„Ø­Ø¯Ø«</label><select id="mEvent" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px"><option>ØªÙ†Ø§Ø²Ù„</option><option>Ø¨ÙŠØ¹</option><option>Ø§Ù†Ø³Ø­Ø§Ø¨</option></select><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="mNote"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'notifs') {
            title.innerText = "ØªØ¨Ù„ÙŠØº";
            content.innerHTML = `<label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label><input type="text" id="mMsg"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'media') {
             title.innerText = "Ø±ÙØ¹ ÙˆØ³Ø§Ø¦Ø·";
             content.innerHTML = `
                <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                <input type="file" id="mFile" accept="image/*,video/*">
                <label>Ø§Ù„ÙˆØµÙ</label>
                <input type="text" id="mDesc">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="text" id="mDate" value="${today}">
                <p id="uploadStatus" style="color:blue; font-size:12px; margin-top:5px;"></p>
             `;
        }
        document.getElementById('actionModal').style.display = 'flex';
    }

    window.confirmModal = function() {
        const date = document.getElementById('mDate').value;
        const d = db[currentUnit];
        
        if (currentTab === 'media') {
            const fileInput = document.getElementById('mFile');
            const file = fileInput.files[0];
            const desc = document.getElementById('mDesc').value;
            const statusText = document.getElementById('uploadStatus');

            if (!file) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
            
            const fileName = Date.now() + '_' + file.name;
            const storageRef = sRef(storage, 'units_media/' + currentUnit + '/' + fileName);

            uploadBytes(storageRef, file).then((snapshot) => {
                getDownloadURL(snapshot.ref).then((downloadURL) => {
                    const type = file.type.startsWith('video') ? 'video' : 'image';
                    d.media.push({type: type, desc: desc, date: date, url: downloadURL});
                    saveData();
                    statusText.innerText = "";
                    closeModal();
                });
            }).catch((error) => {
                console.error("Upload failed", error);
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + error.message);
                statusText.innerText = "";
            });

            return;
        }

        if (currentTab === 'payments') {
            const r = document.getElementById('mReceipt').value;
            const a = document.getElementById('mAmount').value;
            const n = document.getElementById('mNote').value;
            if(!a) return; d.payments.push([date, r||"-", formatNumber(a), n]);
        } else if (currentTab === 'works') {
            const s = document.getElementById('mStage').value;
            const p = document.getElementById('mPerc').value;
            if(!s) return; d.works.push([s, date, p+"%"]);
        } else if (currentTab === 'history') {
             d.history.push([date, document.getElementById('mEvent').value, document.getElementById('mNote').value]);
        } else if (currentTab === 'notifs') {
             d.notifs.push([date, document.getElementById('mMsg').value]);
        }

        saveData();
        closeModal();
    }

    window.closeModal = () => document.getElementById('actionModal').style.display = 'none';
    
    window.delRow = function(id, i) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        if(id==='visitTable') db[currentUnit].visits.splice(i,1);
        else { const map={'payTable':'payments','workTable':'works','histTable':'history','notifTable':'notifs'}; db[currentUnit][map[id]].splice(i,1); }
        saveData();
    }

    window.goBack = function() {
        if(isAdmin) {
            initAdminDashboard();
        } else location.reload();
    }
    
    function formatNumber(n) { return n ? Number(String(n).replace(/,/g,'')).toLocaleString('en-US') : "0"; }
    
    document.addEventListener("keyup", function(event) {
        if (event.key === "Enter" && document.getElementById('loginScreen').style.display !== 'none') handleLogin();
    });
</script>