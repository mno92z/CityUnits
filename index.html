<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004d40">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --white: #ffffff; --sold-bg: #e0f2f1; --sold-border: #00bfa5; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select, textarea { font-size: 16px; outline: none; font-family: inherit; }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 99999; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: opacity 0.5s, bottom 0.5s; opacity: 0; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; transition: opacity 0.5s; }
        .loader { border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
        #imageViewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        #fullImage { max-width: 100%; max-height: 80vh; object-fit: contain; }
        .viewer-controls { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; }
        .viewer-btn { color: white; background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 20px; backdrop-filter: blur(5px); }

        /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--primary), #00251a); text-align: center; color: white; }
        .login-box { background: rgba(255,255,255,0.15); padding: 30px 20px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.95); color: #333; font-weight: 600; text-align: center; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: white; font-weight: 800; border: none; border-radius: 12px; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,191,165,0.3); transition: transform 0.2s; }
        .login-btn:active { transform: scale(0.98); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminDashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .top-bar { position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 10px 0; display: flex; flex-direction: column; gap: 10px; }
        .search-container { display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #ddd; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .icon-btn { width: 50px; background: #333; color: white; border-radius: 12px; border: none; cursor: pointer; font-size: 20px; }
        
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; padding-bottom: 80px; margin-top: 15px; }
        .unit-card { background: white; padding: 15px 10px; border-radius: 16px; text-align: center; cursor: pointer; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: transform 0.2s; border: 2px solid transparent; }
        .unit-card:active { transform: scale(0.96); }
        .unit-card.sold { border-color: var(--sold-border); background: var(--sold-bg); }
        .unit-card h3 { margin: 0 0 5px 0; color: var(--primary); font-size: 18px; }
        .unit-card small { color: #666; font-size: 11px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .notify-dot { position: absolute; top: 8px; right: 8px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: none; }
        .has-request .notify-dot { display: block; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆØ­Ø¯Ø© */
        #unitInterface { display: none; background: #fff; min-height: 100vh; padding-bottom: 90px; }
        .unit-header { background: var(--primary); color: white; padding: 25px 20px 35px; border-radius: 0 0 30px 30px; display: flex; justify-content: space-between; align-items: flex-start; box-shadow: 0 4px 20px rgba(0,77,64,0.3); }
        .back-btn-small { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; backdrop-filter: blur(5px); }

        .stats-container { margin-top: -25px; padding: 0 20px; display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 15px; }
        .stat-card { min-width: 140px; padding: 15px; border-radius: 16px; color: white; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-1 { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .bg-2 { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .bg-3 { background: linear-gradient(135deg, #4CAF50, #388E3C); }

        .tabs-nav { display: flex; overflow-x: auto; padding: 10px 20px; gap: 15px; border-bottom: 1px solid #f0f0f0; margin-bottom: 15px; scrollbar-width: none; }
        .tab-btn { padding: 8px 0; background: none; border: none; color: #888; font-weight: 600; font-size: 15px; white-space: nowrap; position: relative; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -11px; left: 0; width: 100%; height: 3px; background: var(--accent); border-radius: 3px 3px 0 0; }
        
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.4s; }
        .table-responsive { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th { background: #f8f9fa; color: #555; font-weight: 600; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        tr:last-child td { border-bottom: none; }

        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .st-pending { background: #fff8e1; color: #f57f17; }
        .st-approved { background: #e8f5e9; color: #2e7d32; }
        .st-rejected { background: #ffebee; color: #c62828; }

        .media-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .media-item { aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative; background: #eee; border: 1px solid #eee; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Floating Action Button */
        .fab-add { position: fixed; bottom: 25px; left: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 6px 20px rgba(0,77,64,0.4); display: none; align-items: center; justify-content: center; z-index: 90; transition: transform 0.2s; }
        .fab-add:active { transform: scale(0.9); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: flex-end; backdrop-filter: blur(3px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 25px 25px 0 0; padding: 30px 25px; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--primary); }
        
        label { font-size: 13px; color: #666; font-weight: bold; margin-top: 15px; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; background: #fff; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: var(--primary); }

        .btn-confirm { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; }
        .btn-cancel { width: 100%; padding: 15px; background: #f5f5f5; color: #666; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; }

        /* Helpers */
        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
        .unit-interface:not(.show-admin) .editable { pointer-events: none; background: #f9f9f9; color: #555; border: none; padding-right: 0; font-weight: bold; }

        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>
<body>

<div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</div>

<div id="loadingScreen">
    <div class="loader"></div>
    <p style="margin-top:20px; color:#666; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
</div>

<div id="imageViewer">
    <div class="viewer-controls">
        <button class="viewer-btn" onclick="downloadCurrentImage()">â¬‡</button>
        <button class="viewer-btn" onclick="document.getElementById('imageViewer').style.display='none'">âœ•</button>
    </div>
    <img id="fullImage" src="">
</div>

<div id="loginScreen" style="display:none;">
    <div style="margin-bottom: 40px;">
        <h1 style="margin:0; font-size: 32px;">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h1>
        <p style="opacity:0.8; margin-top: 5px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</p>
    </div>
    <div class="login-box">
        <input type="text" id="loginUser" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminDashboard">
    <div class="top-bar">
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© (Ù…Ø«Ø§Ù„: A1)" onkeyup="filterUnits(this.value)">
            <button class="icon-btn admin-only" id="btnManageAdmins" onclick="openAdminsManager()" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†">âš™ï¸</button>
        </div>
        <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:12px; border-radius:12px; width:100%; font-weight:bold;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
    
    <div class="units-grid" id="unitsGrid"></div>
</div>

<div id="unitInterface" class="unit-interface">
    <div class="unit-header">
        <div>
            <h2 style="margin:0; font-size: 24px;" id="headerUnitTitle">...</h2>
            <small style="opacity:0.9; font-size: 14px;" id="headerOwner">...</small>
        </div>
        <button class="back-btn-small" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-container">
        <div class="stat-card bg-1"><small>Ø§Ù„ÙˆØ§ØµÙ„ (Ù…Ø¯ÙÙˆØ¹)</small><h3 style="margin:5px 0" id="dispPaid">0</h3></div>
        <div class="stat-card bg-2"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø£Ù‚Ø³Ø§Ø·)</small><h3 style="margin:5px 0" id="dispRemain">0</h3></div>
        <div class="stat-card bg-3"><small>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 style="margin:5px 0" id="dispProg">0%</h3></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('info')">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('payments')">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="tab-btn" onclick="showTab('works')">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</button>
        <button class="tab-btn" onclick="showTab('docs')">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button> 
        <button class="tab-btn" onclick="showTab('visits')">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('history')">Ø§Ù„Ø³Ø¬Ù„</button>
        <button class="tab-btn" onclick="showTab('notifs')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
        <button class="tab-btn" onclick="showTab('media')">Ø§Ù„ØµÙˆØ±</button>
        <button class="tab-btn admin-only" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="info" class="tab-content" style="display:block;">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label>
        <input type="text" id="ownerName" class="editable">
        
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="tel" id="ownerPhone" class="editable" dir="ltr" style="text-align:right">
        
        <div class="admin-only" style="margin-top:25px; background:#e0f2f1; padding:20px; border-radius:15px; border:1px solid #b2dfdb;">
            <label style="color:#00695c; margin-top:0;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ÙˆØ­Ø¯Ø©</label>
            <input type="text" id="totalPrice" onchange="formatInput(this)" style="font-weight:bold; color:#00695c;">
            <button class="btn-confirm" style="margin-top:15px; background:#00796b;" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="payments" class="tab-content">
        <div class="table-responsive">
            <table id="payTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="admin-only"></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="docs" class="tab-content">
        <div class="table-responsive">
            <table id="docsTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ù…Ø¹Ø§ÙŠÙ†Ø©</th><th class="admin-only"></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="works" class="tab-content">
        <div class="table-responsive">
            <table id="workTable">
                <thead><tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th class="admin-only"></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="visits" class="tab-content">
        <div style="background:white; padding:20px; border-radius:15px; border:1px solid #eee; margin-bottom:25px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h3 style="margin-top:0; color:var(--primary);">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø²ÙŠØ§Ø±Ø©</h3>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
            <input type="date" id="reqVisitDate">
            <label>Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <input type="text" id="reqVisitReason" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
            <button class="btn-confirm" style="margin-top:15px;" onclick="submitVisitRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
        <h3 style="margin-bottom:15px;">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
        <div class="table-responsive">
            <table id="visitTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div class="table-responsive">
            <table id="histTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>ØªÙØ§ØµÙŠÙ„</th><th class="admin-only"></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="notifs" class="tab-content">
        <div class="table-responsive">
            <table id="notifTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù†Øµ Ø§Ù„ØªØ¨Ù„ÙŠØº</th><th class="admin-only"></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="media" class="tab-content">
        <div class="media-grid" id="mediaGrid"></div>
    </div>

    <div id="settings" class="tab-content">
        <div style="background:#fff3e0; padding:20px; border-radius:15px; border:1px solid #ffe0b2;">
            <h3 style="margin-top:0; color:#e65100;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)</h3>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="uUser">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="text" id="uPass">
            <button class="btn-confirm" style="background:#ef6c00;" onclick="saveData()">ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <button id="fabAdd" class="fab-add admin-only" onclick="openModal()">+</button>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
        <div id="modalInputs"></div> 
        <button class="btn-confirm" onclick="confirmModal()">Ø­ÙØ¸</button>
        <button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="adminsModal" class="modal-overlay" style="align-items: center; justify-content: center;">
    <div class="modal-sheet" style="max-height: 80vh; border-radius: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 class="modal-title" style="margin:0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</h2>
            <button onclick="document.getElementById('adminsModal').style.display='none'" style="background:none; border:none; font-size:24px;">&times;</button>
        </div>
        
        <div style="background:#f5f5f5; padding:15px; border-radius:12px; margin-bottom:20px;">
            <h4 style="margin:0 0 10px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="newAdminUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:10px;">
            <input type="text" id="newAdminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-confirm" style="padding:10px; margin-top:10px;" onclick="saveAdminUser()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        
        <div id="adminsListContainer" style="border-top:1px solid #eee; padding-top:10px;"></div>
    </div>
</div>

<script>
    // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ---
    // ğŸ”´ğŸ”´ğŸ”´ Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­ Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ğŸ”´ğŸ”´ğŸ”´
    const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
    let db = {}; 
    let adminsDb = {};
    let currentUnit = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let currentTab = 'info';

    // --- 2. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© ---
    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function formatNumber(num) {
        if (!num) return "0";
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø«Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        const cleanNum = String(num).replace(/,/g, '');
        return Number(cleanNum).toLocaleString('en-US');
    }

    function formatInput(input) {
        input.value = formatNumber(input.value);
    }

    function switchScreen(screenId) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        ['loadingScreen', 'loginScreen', 'adminDashboard', 'unitInterface', 'adminsModal'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const target = document.getElementById(screenId);
        if(target) {
            target.style.display = (screenId === 'actionModal' || screenId === 'adminsModal' || screenId === 'imageViewer') ? 'flex' : 'block';
        }
        
        window.scrollTo(0, 0);
    }

    // --- 3. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    async function initApp() {
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
            const { data: uData, error: uErr } = await supabase.from('units').select('*');
            if(uErr) throw uErr;
            if(uData) uData.forEach(r => db[r.id] = r.data);
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù† (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ØŒ ÙŠÙØ¶Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©)
            const { data: aData, error: aErr } = await supabase.from('admins').select('*');
            if(aData) aData.forEach(r => adminsDb[r.username.toLowerCase()] = r);

            document.getElementById('loadingScreen').style.display = 'none';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
            const savedUser = localStorage.getItem('azhar_user');
            const savedPass = localStorage.getItem('azhar_pass');
            if(savedUser && savedPass) {
                document.getElementById('loginUser').value = savedUser;
                document.getElementById('loginPass').value = savedPass;
                handleLogin(true); // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØµØ§Ù…Øª
            } else {
                switchScreen('loginScreen');
            }

        } catch (error) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message);
            document.getElementById('loadingScreen').innerHTML = `<p style="color:red">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p><button onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>`;
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    initApp();

    // --- 4. Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.handleLogin = async function(isSilent = false) {
        const rawUser = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        
        if(!rawUser || !pass) {
            if(!isSilent) showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            return;
        }

        const adminKey = rawUser.toLowerCase();
        const unitKey = rawUser.toUpperCase();

        // 1. Ù‡Ù„ Ù‡Ùˆ Ø£Ø¯Ù…Ù†ØŸ
        if (adminsDb[adminKey] && adminsDb[adminKey].password === pass) {
            isAdmin = true;
            isSuperAdmin = (adminsDb[adminKey].role === 'super');
            currentUnit = null;
            
            localStorage.setItem('azhar_user', rawUser);
            localStorage.setItem('azhar_pass', pass);
            
            const adminBtn = document.getElementById('btnManageAdmins');
            if(adminBtn) adminBtn.style.display = isSuperAdmin ? 'block' : 'none';
            
            initAdminDashboard();
        } 
        // 2. Ù‡Ù„ Ù‡Ùˆ Ù…Ø³ØªÙÙŠØ¯ (ÙˆØ­Ø¯Ø©)ØŸ
        else if (db[unitKey]) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Settings
            const unitSettings = db[unitKey].settings || {};
            if (unitSettings.pass === pass) { // Ù‡Ù†Ø§ ÙŠÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
                isAdmin = false; 
                isSuperAdmin = false;
                
                localStorage.setItem('azhar_user', rawUser);
                localStorage.setItem('azhar_pass', pass);
                
                openUnit(unitKey);
            } else {
                if(!isSilent) alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                else switchScreen('loginScreen');
            }
        } 
        // 3. Ø®Ø·Ø£
        else {
            if(!isSilent) alert("Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            else switchScreen('loginScreen');
        }
    }

    window.logout = function() {
        localStorage.removeItem('azhar_user');
        localStorage.removeItem('azhar_pass');
        location.reload();
    }

    // --- 5. Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
    function initAdminDashboard() {
        currentUnit = null; 
        switchScreen('adminDashboard');
        renderUnitsGrid("");
    }

    window.filterUnits = function(val) {
        renderUnitsGrid(val);
    }

    function renderUnitsGrid(filter) {
        const grid = document.getElementById('unitsGrid'); 
        grid.innerHTML = "";
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: A1..A50, B1..B50, C1..C50
        const categories = ['A', 'B', 'C'];
        
        categories.forEach(cat => {
            for(let i=1; i<=50; i++) {
                let id = cat + i;
                if (filter && !id.toLowerCase().includes(filter.toLowerCase())) continue;
                
                let d = db[id];
                let isSold = d && d.info && d.info.name && d.info.name.trim().length > 0;
                let hasPending = d && d.visits && d.visits.some(v => v.status === 'pending');
                
                let div = document.createElement('div');
                div.className = `unit-card ${isSold ? 'sold' : ''} ${hasPending ? 'has-request' : ''}`;
                div.onclick = () => openUnit(id);
                
                div.innerHTML = `
                    <div class="notify-dot"></div>
                    <h3>${id}</h3>
                    <small>${isSold ? d.info.name : 'Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹'}</small>
                `;
                grid.appendChild(div);
            }
        });
    }

    // --- 6. Ù…Ù†Ø·Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆØ­Ø¯Ø© ---
    window.openUnit = function(id) {
        currentUnit = id;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡ÙŠÙƒÙ„ÙŠØªÙ‡Ø§
        if (!db[id]) {
            // Ù‡ÙŠÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¬Ø¯ÙŠØ¯
            db[id] = { 
                info: {name:"", phone:""}, 
                settings: {user:id, pass:"123456"}, 
                totalPrice: 0, 
                payments:[], works:[], history:[], notifs:[], media:[], visits:[], docs:[] 
            };
        }
        
        // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ Ù†Ù‚ØµØª Ù…ØµÙÙˆÙØ§Øª
        ['docs', 'media', 'history', 'notifs', 'visits', 'payments', 'works'].forEach(k => { 
            if(!db[id][k]) db[id][k] = []; 
        });
        if(!db[id].info) db[id].info = {name:"", phone:""};
        if(!db[id].settings) db[id].settings = {user:id, pass:"123456"};

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø¯Ù…Ù†
        const ui = document.getElementById('unitInterface');
        if(isAdmin) ui.classList.add('show-admin');
        else ui.classList.remove('show-admin');
        
        switchScreen('unitInterface'); 
        loadUnitData();
        showTab('info');
    }

    window.loadUnitData = function() {
        if(!db[currentUnit]) return;
        const d = db[currentUnit];
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        document.getElementById('headerUnitTitle').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø© " + currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²Ø©";
        
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = formatNumber(d.totalPrice);
        
        document.getElementById('uUser').value = d.settings.user || currentUnit;
        document.getElementById('uPass').value = d.settings.pass || "";
        
        // Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        document.getElementById('ownerName').readOnly = !isAdmin;
        document.getElementById('ownerPhone').readOnly = !isAdmin;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        renderPaymentTable(d.payments);
        renderWorkTable(d.works);
        renderDocsTable(d.docs);
        renderVisitsTable(d.visits);
        renderHistoryTable(d.history);
        renderNotifTable(d.notifs);
        renderMediaGrid(d.media);
        
        calcStats();
    }

    function calcStats() {
        const d = db[currentUnit];
        let total = parseFloat(String(d.totalPrice).replace(/,/g,'')) || 0;
        
        let payments = d.payments || [];
        let paid = payments.reduce((acc, curr) => acc + (parseFloat(String(curr[2]).replace(/,/g,''))||0), 0);
        
        document.getElementById('dispPaid').innerText = formatNumber(paid);
        document.getElementById('dispRemain').innerText = formatNumber(total - paid);
        
        let works = d.works || [];
        // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„ ÙŠÙ…Ø«Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('dispProg').innerText = works.length > 0 ? works[works.length-1][2] : "0%";
    }

    // Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Rendering)
    function renderPaymentTable(data) {
        const tbody = document.getElementById('payTable').querySelector('tbody'); 
        tbody.innerHTML = "";
        data.forEach((row, index) => {
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td style="font-weight:bold; color:var(--primary)">${row[2]}</td>
                <td>${row[3] || '-'}</td>
                ${isAdmin ? `<td><button onclick="deleteItem('payments', ${index})" style="color:red;border:none;background:none;font-weight:bold;cursor:pointer">Ã—</button></td>` : '<td style="display:none"></td>'}
            `;
        });
        if(data.length === 0) tbody.innerHTML = `<tr><td colspan="5" style="color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
    }

    function renderWorkTable(data) {
        const tbody = document.getElementById('workTable').querySelector('tbody');
        tbody.innerHTML = "";
        data.forEach((row, index) => {
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td><span style="background:#e3f2fd; color:#1565c0; padding:2px 8px; border-radius:10px; font-weight:bold">${row[2]}</span></td>
                ${isAdmin ? `<td><button onclick="deleteItem('works', ${index})" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></td>` : '<td style="display:none"></td>'}
            `;
        });
    }

    function renderDocsTable(data) {
        const tbody = document.getElementById('docsTable').querySelector('tbody');
        tbody.innerHTML = "";
        data.forEach((row, index) => {
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.type}</td>
                <td>${row.note}</td>
                <td><button onclick="viewImage('${row.url}')" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø¹Ø±Ø¶</button></td>
                ${isAdmin ? `<td><button onclick="deleteItem('docs', ${index})" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></td>` : '<td style="display:none"></td>'}
            `;
        });
    }

    function renderVisitsTable(data) {
        const tbody = document.getElementById('visitTable').querySelector('tbody');
        tbody.innerHTML = "";
        data.forEach((v, i) => {
            let statusText = v.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : (v.status === 'approved' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ù…Ø±ÙÙˆØ¶');
            let statusClass = v.status === 'pending' ? 'st-pending' : (v.status === 'approved' ? 'st-approved' : 'st-rejected');
            
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${v.date}</td>
                <td style="white-space:normal; max-width:150px;">${v.reason}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${getVisitActionHTML(v, i)}</td>
            `;
        });
        if(data.length === 0) tbody.innerHTML = `<tr><td colspan="4" style="color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</td></tr>`;
    }

    function getVisitActionHTML(visit, index) {
        if(!isAdmin) {
             return visit.status === 'pending' ? '<span style="color:#f57f17">Ø§Ù†ØªØ¸Ø§Ø±...</span>' : '-';
        }
        if(visit.status === 'pending') {
            return `
                <button onclick="updateVisit(${index}, 'approved')" style="background:#4caf50; color:white; border:none; border-radius:4px; margin:2px; cursor:pointer;">âœ”</button>
                <button onclick="updateVisit(${index}, 'rejected')" style="background:#f44336; color:white; border:none; border-radius:4px; margin:2px; cursor:pointer;">âœ–</button>
            `;
        } else {
            return `<button onclick="deleteItem('visits', ${index})" style="color:red;border:none;background:none;cursor:pointer;">Ø­Ø°Ù</button>`;
        }
    }

    function renderHistoryTable(data) {
        const tbody = document.getElementById('histTable').querySelector('tbody');
        tbody.innerHTML = "";
        data.forEach((row, index) => {
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td style="white-space:normal">${row[2]}</td>
                ${isAdmin ? `<td><button onclick="deleteItem('history', ${index})" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></td>` : '<td style="display:none"></td>'}
            `;
        });
    }

    function renderNotifTable(data) {
        const tbody = document.getElementById('notifTable').querySelector('tbody');
        tbody.innerHTML = "";
        data.forEach((row, index) => {
            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td style="white-space:normal">${row[1]}</td>
                ${isAdmin ? `<td><button onclick="deleteItem('notifs', ${index})" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></td>` : '<td style="display:none"></td>'}
            `;
        });
    }

    function renderMediaGrid(data) {
        const grid = document.getElementById('mediaGrid');
        grid.innerHTML = "";
        data.forEach((m, i) => {
            let content = m.type === 'video' 
                ? `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:40px;">ğŸ¬</div>`
                : `<img src="${m.url}" loading="lazy">`;
            
            let div = document.createElement('div');
            div.className = 'media-item';
            div.innerHTML = `
                <div onclick="viewImage('${m.url}')" style="width:100%;height:100%;cursor:pointer;">${content}</div>
                ${isAdmin ? `<button onclick="deleteItem('media', ${i})" style="position:absolute;top:5px;right:5px;background:rgba(255,0,0,0.8);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;">Ã—</button>` : ''}
                ${m.desc ? `<div style="position:absolute;bottom:0;width:100%;background:rgba(0,0,0,0.5);color:white;font-size:10px;padding:2px;text-align:center;">${m.desc}</div>` : ''}
            `;
            grid.appendChild(div);
        });
        if(data.length === 0) grid.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:20px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø·</div>`;
    }

    // --- 7. Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ---
    
    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    window.saveData = async function() {
        if(!currentUnit) return;
        const d = db[currentUnit];
        
        if(isAdmin) {
             if(document.getElementById('ownerName')) d.info.name = document.getElementById('ownerName').value;
             if(document.getElementById('ownerPhone')) d.info.phone = document.getElementById('ownerPhone').value;
             if(document.getElementById('totalPrice')) d.totalPrice = document.getElementById('totalPrice').value.replace(/,/g,'');
             if(document.getElementById('uUser')) d.settings.user = document.getElementById('uUser').value;
             if(document.getElementById('uPass')) d.settings.pass = document.getElementById('uPass').value;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ù…ÙŠÙ„
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
        
        const { error } = await supabase.from('units').upsert({ id: currentUnit, data: d });
        
        if (error) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message);
        } else {
             showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
             loadUnitData(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        }
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
    window.submitVisitRequest = function() {
        const date = document.getElementById('reqVisitDate').value;
        const reason = document.getElementById('reqVisitReason').value;
        
        if(!date || !reason) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø¨Ø¨");
        
        if(!db[currentUnit].visits) db[currentUnit].visits = [];
        db[currentUnit].visits.push({ date: date, reason: reason, status: 'pending' });
        
        saveData();
        
        document.getElementById('reqVisitDate').value = "";
        document.getElementById('reqVisitReason').value = "";
    }

    window.updateVisit = function(index, status) {
        db[currentUnit].visits[index].status = status;
        saveData();
    }

    // Ø­Ø°Ù Ø¹Ù†ØµØ±
    window.deleteItem = function(arrayName, index) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
        db[currentUnit][arrayName].splice(index, 1);
        saveData();
    }

    // --- 8. Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ---
    window.showTab = function(t) {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
        const buttons = document.querySelectorAll('.tab-btn');
        const tabsOrder = ['info', 'payments', 'works', 'docs', 'visits', 'history', 'notifs', 'media', 'settings'];
        const index = tabsOrder.indexOf(t);
        if(buttons[index]) buttons[index].classList.add('active');

        // Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø¥Ø¶Ø§ÙØ©
        const fab = document.getElementById('fabAdd');
        const allowedTabs = ['payments','docs','works','history','notifs','media'];
        fab.style.display = (isAdmin && allowedTabs.includes(t)) ? 'flex' : 'none';
    }

    window.openModal = function() {
        const inputsDiv = document.getElementById('modalInputs');
        const titleDiv = document.getElementById('modalTitle');
        const today = new Date().toISOString().split('T')[0];
        
        let html = '';
        
        switch(currentTab) {
            case 'payments':
                titleDiv.innerText = "Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©";
                html = `
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label><input type="date" id="mDate" value="${today}">
                    <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</label><input type="text" id="mRcpt">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" id="mAmt" placeholder="0">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="mNote">
                `;
                break;
            case 'works':
                titleDiv.innerText = "ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„";
                let opts = ""; for(let i=0; i<=100; i+=5) opts += `<option value="${i}">${i}%</option>`;
                html = `
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mDate" value="${today}">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="mStage" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµØ¨ Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ø«Ø§Ù†ÙŠ">
                    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</label><select id="mPerc">${opts}</select>
                `;
                break;
            case 'notifs':
                titleDiv.innerText = "Ø¥Ø±Ø³Ø§Ù„ ØªØ¨Ù„ÙŠØº";
                html = `
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mDate" value="${today}">
                    <label>Ù†Øµ Ø§Ù„ØªØ¨Ù„ÙŠØº</label><textarea id="mMsg" style="width:100%;border:1px solid #ddd;border-radius:10px;padding:10px;height:100px;"></textarea>
                `;
                break;
            case 'history':
                titleDiv.innerText = "Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„Ø³Ø¬Ù„";
                html = `
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mDate" value="${today}">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</label>
                    <select id="mEvent">
                        <option>ØªØºÙŠÙŠØ± Ù…Ù„ÙƒÙŠØ©</option>
                        <option>ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯</option>
                        <option>Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø­Ù‚</option>
                        <option>Ø£Ø®Ø±Ù‰</option>
                    </select>
                    <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><input type="text" id="mNote">
                `;
                break;
            case 'media':
                titleDiv.innerText = "Ø±ÙØ¹ ØµÙˆØ±Ø©";
                html = `
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mDate" value="${today}">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label><input type="file" id="mFile" accept="image/*,video/*">
                    <label>ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="text" id="mDesc">
                    <p id="uploadStatus" style="color:var(--primary); font-size:12px; margin-top:5px;"></p>
                `;
                break;
            case 'docs':
                titleDiv.innerText = "Ø±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø©";
                html = `
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mDate" value="${today}">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
                    <select id="mType">
                        <option>Ø¹Ù‚Ø¯</option>
                        <option>ÙˆØµÙ„ Ø£Ù…Ø§Ù†Ø©</option>
                        <option>ØªØ¹Ù‡Ø¯ Ø®Ø·ÙŠ</option>
                        <option>Ø¥Ù†Ø°Ø§Ø±</option>
                        <option>Ø£Ø®Ø±Ù‰</option>
                    </select>
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label><input type="file" id="mFile" accept="image/*,.pdf">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="mNote">
                    <p id="uploadStatus" style="color:var(--primary); font-size:12px; margin-top:5px;"></p>
                `;
                break;
        }
        
        inputsDiv.innerHTML = html;
        document.getElementById('actionModal').style.display = 'flex';
    }

    window.closeModal = function() {
        document.getElementById('actionModal').style.display = 'none';
    }

    window.confirmModal = async function() {
        const date = document.getElementById('mDate').value;
        const d = db[currentUnit];
        
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±ÙØ¹ (Upload Logic)
        if (currentTab === 'media' || currentTab === 'docs') {
            const fileInput = document.getElementById('mFile');
            const file = fileInput.files[0];
            
            if(!file) return alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹");
            
            document.getElementById('uploadStatus').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³";
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;
            const bucketName = 'media'; // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Bucket Ø¨Ø§Ø³Ù… 'media' ÙÙŠ Supabase ÙˆØ¬Ø¹Ù„Ù‡ Public
            
            const { data, error } = await supabase.storage.from(bucketName).upload(fileName, file);
            
            if(error) {
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + error.message);
                document.getElementById('uploadStatus').innerText = "";
                return;
            }
            
            const { data: { publicUrl } } = supabase.storage.from(bucketName).getPublicUrl(fileName);
            
            if (currentTab === 'media') {
                const desc = document.getElementById('mDesc').value;
                const type = file.type.startsWith('video') ? 'video' : 'image';
                d.media.push({type, desc, date, url: publicUrl});
            } else {
                const type = document.getElementById('mType').value;
                const note = document.getElementById('mNote').value;
                d.docs.push({type, note, date, url: publicUrl});
            }
            
        } else if (currentTab === 'payments') {
            const rcpt = document.getElementById('mRcpt').value;
            const amt = document.getElementById('mAmt').value;
            const note = document.getElementById('mNote').value;
            if(!amt) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
            d.payments.push([date, rcpt || "-", formatNumber(amt), note]);
            
        } else if (currentTab === 'works') {
            const stage = document.getElementById('mStage').value;
            const perc = document.getElementById('mPerc').value;
            if(!stage) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø©");
            d.works.push([stage, date, perc + "%"]);
            
        } else if (currentTab === 'notifs') {
            const msg = document.getElementById('mMsg').value;
            if(!msg) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ");
            d.notifs.push([date, msg]);
            
        } else if (currentTab === 'history') {
            const evt = document.getElementById('mEvent').value;
            const note = document.getElementById('mNote').value;
            d.history.push([date, evt, note]);
        }

        await saveData(); // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        closeModal();
    }

    // --- 9. Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± ---
    window.viewImage = function(url) {
        if(!url) return;
        document.getElementById('fullImage').src = url;
        document.getElementById('imageViewer').style.display = 'flex';
    }

    window.downloadCurrentImage = async function() {
        const url = document.getElementById('fullImage').src;
        if(!url) return;
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.download = 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    window.goBack = function() {
        if(isAdmin) {
            initAdminDashboard();
        } else {
            // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠØ¹Ù†ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                logout();
            }
        }
    }

    // --- 10. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† (Super Admin) ---
    window.openAdminsManager = function() {
        if(!isSuperAdmin) return alert("Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·");
        document.getElementById('adminsModal').style.display = 'flex';
        renderAdminsList();
    }

    window.renderAdminsList = function() {
        const container = document.getElementById('adminsListContainer');
        container.innerHTML = "";
        
        Object.values(adminsDb).forEach(admin => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #ddd; background:white; margin-bottom:5px; border-radius:8px;";
            div.innerHTML = `
                <div>
                    <strong>${admin.username}</strong>
                    <br><span style="font-size:11px; color:#888;">${admin.role === 'super' ? 'Ù…Ø´Ø±Ù Ø±Ø¦ÙŠØ³ÙŠ' : 'Ù…Ø­Ø±Ø±'}</span>
                </div>
                ${admin.role !== 'super' ? `<button onclick="deleteAdmin('${admin.username}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button>` : ''}
            `;
            container.appendChild(div);
        });
    }

    window.saveAdminUser = async function() {
        const u = document.getElementById('newAdminUser').value.trim().toLowerCase();
        const p = document.getElementById('newAdminPass').value.trim();
        if(!u || !p) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        const { error } = await supabase.from('admins').upsert({ username: u, password: p, role: 'editor' });
        
        if(!error) {
            adminsDb[u] = { username: u, password: p, role: 'editor' };
            renderAdminsList();
            document.getElementById('newAdminUser').value="";
            document.getElementById('newAdminPass').value="";
            showToast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„");
        } else {
            alert("Ø®Ø·Ø£: " + error.message);
        }
    }

    window.deleteAdmin = async function(username) {
        if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ØŸ")) return;
        const { error } = await supabase.from('admins').delete().eq('username', username);
        if(!error) {
            delete adminsDb[username];
            renderAdminsList();
        } else {
            alert("Ø®Ø·Ø£: " + error.message);
        }
    }

</script>
</body>
</html>