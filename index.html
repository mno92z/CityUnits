<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</title>
    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #f5f7fa; --white: #ffffff; --sold-bg: #e0f2f1; --sold-border: #00bfa5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        button, input, select, textarea { font-size: 16px; outline: none; font-family: inherit; }
        .container { max-width: 100%; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Loading Overlay */
        #loadingScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; transition: opacity 0.5s; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login */
        #loginScreen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 30px; background: linear-gradient(135deg, var(--primary), #00251a); color: white; text-align: center; }
        .login-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.9); color: #333; font-weight: bold; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: var(--primary); font-weight: 900; border: none; border-radius: 12px; margin-top: 10px; cursor: pointer; }

        /* Admin Dashboard */
        #adminDashboard { display: none; padding: 20px; }
        .search-bar { position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 10px 0; }
        .search-input { width: 100%; padding: 15px; border-radius: 50px; border: 1px solid #ddd; font-size: 16px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding-bottom: 80px; }
        .unit-card { background: white; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; position: relative; }
        .unit-card.sold { border-color: var(--sold-border); background: var(--sold-bg); }
        .unit-card h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .unit-card small { color: #888; font-size: 11px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notify-dot { position: absolute; top: -5px; right: -5px; width: 15px; height: 15px; background: red; border-radius: 50%; border: 2px solid white; display: none; }
        .has-request .notify-dot { display: block; }

        /* Unit Interface */
        #unitInterface { display: none; background: white; min-height: 100vh; padding-bottom: 80px; }
        .unit-header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        .stats-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 0 20px 20px; scrollbar-width: none; }
        .stat-card { min-width: 150px; padding: 15px; border-radius: 15px; color: white; flex-shrink: 0; }
        .bg-1 { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .bg-2 { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .bg-3 { background: linear-gradient(45deg, #4CAF50, #388E3C); }

        .tabs-nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; scrollbar-width: none; }
        .tab-btn { padding: 10px 15px; background: none; border: none; white-space: nowrap; color: #666; font-weight: bold; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--accent); }
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s; }
        
        .table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; }

        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .st-pending { background: #fff3cd; color: #856404; }
        .st-approved { background: #d4edda; color: #155724; }
        .st-rejected { background: #f8d7da; color: #721c24; }
        .visit-action-btn { border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin: 0 2px; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }

        .media-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .media-item { background: #eee; border-radius: 10px; height: 120px; display: flex; align-items: center; justify-content: center; position: relative; flex-direction: column; }
        
        .fab-add { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none; align-items: center; justify-content: center; }
        
        label { font-size: 13px; color: #666; font-weight: bold; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-sheet { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { flex: 2; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; }
        .btn-cancel { flex: 1; padding: 12px; background: #eee; color: #333; border: none; border-radius: 10px; font-weight: bold; }

        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        .admin-only { display: none !important; }
        .show-admin .admin-only { display: block !important; }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="loader"></div>
    <p style="margin-top:20px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<div id="loginScreen" style="display:none;">
    <div style="margin-bottom: 30px;">
        <h1 style="margin:0;">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h1>
        <p style="opacity:0.8;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
    </div>
    <div class="login-box">
        <input type="text" id="loginUser" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ admin">
        <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminDashboard">
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..." onkeyup="filterUnits(this.value)">
    </div>
    <div class="units-grid" id="unitsGrid"></div>
    <button class="back-btn" style="background:#d32f2f; width:100%; margin-top:20px;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div id="unitInterface">
    <div class="unit-header">
        <div>
            <h2 style="margin:0;" id="headerUnitTitle">...</h2>
            <small style="opacity:0.9;" id="headerOwner">...</small>
        </div>
        <button class="back-btn" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="stats-scroll">
        <div class="stat-card bg-1"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><h3 style="margin:5px 0" id="dispPaid">0</h3></div>
        <div class="stat-card bg-2"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><h3 style="margin:5px 0" id="dispRemain">0</h3></div>
        <div class="stat-card bg-3"><small>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small><h3 style="margin:5px 0" id="dispProg">0%</h3></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('info')">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('payments')">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="tab-btn" onclick="showTab('works')">Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„</button>
        <button class="tab-btn" onclick="showTab('visits')">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="tab-btn" onclick="showTab('history')">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©</button>
        <button class="tab-btn" onclick="showTab('notifs')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
        <button class="tab-btn" onclick="showTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
        <button class="tab-btn admin-only" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="info" class="tab-content" style="display:block;">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="ownerName" class="editable" readonly>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="ownerPhone" class="editable" readonly>
        <div class="admin-only" style="margin-top:20px; background:#e0f7fa; padding:15px; border-radius:10px;">
            <label style="color:#006064;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" id="totalPrice" onchange="saveData()">
        </div>
        <button class="login-btn admin-only" style="margin-top:20px;" onclick="saveData()">Ø­ÙØ¸</button>
    </div>

    <div id="payments" class="tab-content">
        <div class="table-wrapper"><table id="payTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="works" class="tab-content">
        <div class="table-wrapper"><table id="workTable"><thead><tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>%</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="visits" class="tab-content">
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:20px;">
            <h3 style="margin-top:0; color:var(--primary);">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©</h3>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="reqVisitDate">
            <label>Ø§Ù„Ø³Ø¨Ø¨</label><input type="text" id="reqVisitReason" placeholder="...">
            <button class="login-btn" style="margin-top:10px;" onclick="submitVisitRequest()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
        <h3 style="margin-bottom:10px;">Ø§Ù„Ø³Ø¬Ù„</h3>
        <div class="table-wrapper"><table id="visitTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table></div>
        <div style="height:60px;"></div>
    </div>

    <div id="history" class="tab-content"><div class="table-wrapper"><table id="histTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div><div style="height:60px;"></div></div>
    <div id="notifs" class="tab-content"><div class="table-wrapper"><table id="notifTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØ¨Ù„ÙŠØº</th><th class="admin-only"></th></tr></thead><tbody></tbody></table></div><div style="height:60px;"></div></div>
    <div id="media" class="tab-content"><div class="media-grid" id="mediaGrid"></div><div style="height:60px;"></div></div>

    <div id="settings" class="tab-content">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="uUser"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="text" id="uPass">
        <button class="login-btn" onclick="saveData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>

    <button id="fabAdd" class="fab-add admin-only" onclick="openModal()">+</button>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
        <div id="modalInputs"></div> 
        <div class="modal-btn-group"><button class="btn-confirm" onclick="confirmModal()">Ø­ÙØ¸</button><button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyCR6JSg3nHpicIgY0140H2f4j_9ip1ArYo",
      authDomain: "azhar-city.firebaseapp.com",
      projectId: "azhar-city",
      storageBucket: "azhar-city.firebasestorage.app",
      messagingSenderId: "348703246018",
      appId: "1:348703246018:web:941d64ca991a72bb825d5b"
    };

    const app = initializeApp(firebaseConfig);
    const dbRealtime = getDatabase(app);
    let db = {}; 
    let currentUnit = null;
    let isAdmin = false;
    let currentTab = 'info';

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
    const dbRef = ref(dbRealtime, 'units_db_v1');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        db = data || {};
        document.getElementById('loadingScreen').style.opacity = '0';
        setTimeout(()=> document.getElementById('loadingScreen').style.display='none', 500);
        document.getElementById('loginScreen').style.display = 'flex';
        
        if(currentUnit) loadUnitData();
        if(document.getElementById('adminDashboard').style.display === 'block') renderUnitsGrid(document.querySelector('.search-input').value);
    });

    window.saveData = function() {
        if(!currentUnit) return;
        const d = db[currentUnit];
        d.info.name = document.getElementById('ownerName').value;
        d.info.phone = document.getElementById('ownerPhone').value;
        d.totalPrice = document.getElementById('totalPrice').value.replace(/,/g,'');
        d.settings.user = document.getElementById('uUser').value;
        d.settings.pass = document.getElementById('uPass').value;
        set(ref(dbRealtime, 'units_db_v1/' + currentUnit), d);
    }
    
    window.handleLogin = function() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        
        if (u === "admin" && p === "admin123") {
            isAdmin = true; initAdminDashboard();
        } else {
            if (db[u] && db[u].settings && db[u].settings.pass === p) {
                isAdmin = false; openUnit(u);
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©");
            }
        }
    }

    function initAdminDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        renderUnitsGrid("");
    }

    window.renderUnitsGrid = function(filter) {
        const grid = document.getElementById('unitsGrid'); grid.innerHTML = "";
        ['A', 'B', 'C'].forEach(cat => {
            for(let i=1; i<=50; i++) {
                let id = cat + i;
                if (filter && !id.toLowerCase().includes(filter.toLowerCase())) continue;
                let d = db[id];
                let isSold = d && d.info.name && d.info.name.trim().length > 0;
                let hasPending = d && d.visits && d.visits.some(v => v.status === 'pending');

                let div = document.createElement('div');
                div.className = `unit-card ${isSold ? 'sold' : ''} ${hasPending ? 'has-request' : ''}`;
                div.onclick = () => openUnit(id);
                div.innerHTML = `<div class="notify-dot"></div><h3>${id}</h3><small>${isSold ? d.info.name : 'Ù…ØªØ§Ø­'}</small>`;
                grid.appendChild(div);
            }
        });
    }
    window.filterUnits = (val) => renderUnitsGrid(val);

    window.openUnit = function(id) {
        currentUnit = id;
        if (!db[id]) {
            db[id] = { info: {name:"",phone:""}, settings: {user:id, pass:"123"}, totalPrice:0, payments:[], works:[], history:[], notifs:[], media:[], visits:[] };
        }
        ['history', 'notifs', 'media', 'visits', 'payments', 'works'].forEach(k => { if(!db[id][k]) db[id][k] = []; });

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('unitInterface').style.display = 'block';
        document.getElementById('unitInterface').className = isAdmin ? 'show-admin' : '';
        
        loadUnitData();
        showTab('info');
    }

    window.loadUnitData = function() {
        if(!db[currentUnit]) return;
        const d = db[currentUnit];
        document.getElementById('headerUnitTitle').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø© " + currentUnit;
        document.getElementById('headerOwner').innerText = d.info.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        document.getElementById('ownerName').value = d.info.name || "";
        document.getElementById('ownerPhone').value = d.info.phone || "";
        document.getElementById('totalPrice').value = formatNumber(d.totalPrice);
        document.getElementById('uUser').value = d.settings.user;
        document.getElementById('uPass').value = d.settings.pass;
        document.getElementById('ownerName').readOnly = !isAdmin;
        document.getElementById('ownerPhone').readOnly = !isAdmin;

        renderTable('payTable', d.payments);
        renderTable('workTable', d.works);
        renderTable('histTable', d.history);
        renderTable('notifTable', d.notifs);
        renderVisitsTable(d.visits);
        renderMediaGrid();
        calcStats();
    }

    function renderTable(id, rows) {
        if(!rows) rows = [];
        const tb = document.getElementById(id).querySelector('tbody'); tb.innerHTML = "";
        rows.forEach((r, i) => {
            let tr = tb.insertRow();
            r.forEach(c => tr.insertCell().innerText = c);
            if(isAdmin) tr.insertCell().innerHTML = `<button onclick="delRow('${id}',${i})" style="color:red;border:none;background:none;font-size:18px">&times;</button>`;
        });
    }

    function renderVisitsTable(visits) {
        if(!visits) visits = [];
        const tb = document.getElementById('visitTable').querySelector('tbody'); tb.innerHTML = "";
        visits.forEach((v, i) => {
            let tr = tb.insertRow();
            tr.insertCell().innerText = v.date;
            tr.insertCell().innerText = v.reason;
            let statusText = v.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : (v.status === 'approved' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ù…Ø±ÙÙˆØ¶');
            let statusClass = v.status === 'pending' ? 'st-pending' : (v.status === 'approved' ? 'st-approved' : 'st-rejected');
            tr.insertCell().innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
            
            let actionTd = tr.insertCell();
            if(isAdmin) {
                if(v.status === 'pending') {
                    actionTd.innerHTML = `
                        <button class="visit-action-btn btn-approve" onclick="setVisitStatus(${i}, 'approved')">âœ”</button>
                        <button class="visit-action-btn btn-reject" onclick="setVisitStatus(${i}, 'rejected')">âœ–</button>
                    `;
                } else {
                    actionTd.innerHTML = `<button onclick="delRow('visitTable',${i})" style="color:red;border:none;background:none;">Ø­Ø°Ù</button>`;
                }
            } else actionTd.innerText = "-";
        });
    }

    window.submitVisitRequest = function() {
        const date = document.getElementById('reqVisitDate').value;
        const reason = document.getElementById('reqVisitReason').value;
        if(!date || !reason) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        
        if(!db[currentUnit].visits) db[currentUnit].visits = [];
        db[currentUnit].visits.push({ date: date, reason: reason, status: 'pending' });
        saveData();
        
        document.getElementById('reqVisitDate').value = "";
        document.getElementById('reqVisitReason').value = "";
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    }

    window.setVisitStatus = function(index, status) {
        db[currentUnit].visits[index].status = status;
        saveData();
    }

    function renderMediaGrid() {
        const g = document.getElementById('mediaGrid'); g.innerHTML = "";
        let media = db[currentUnit].media || [];
        media.forEach((m, i) => {
            let d = document.createElement('div'); d.className = 'media-item';
            d.innerHTML = `<div class="media-icon">${m.type==='video'?'ğŸ¥':'ğŸ“·'}</div><div class="media-label">${m.desc}</div>`;
            if(isAdmin) {
                let b = document.createElement('button'); b.innerHTML='&times;';
                b.style.cssText="position:absolute;top:5px;left:5px;background:red;color:white;border:none;border-radius:50%;width:20px;height:20px;line-height:20px;padding:0";
                b.onclick = () => { db[currentUnit].media.splice(i, 1); saveData(); };
                d.appendChild(b);
            }
            g.appendChild(d);
        });
    }

    function calcStats() {
        const d = db[currentUnit];
        let total = parseFloat(String(d.totalPrice).replace(/,/g,'')) || 0;
        let payments = d.payments || [];
        let paid = payments.reduce((a,c) => a + (parseFloat(String(c[2]).replace(/,/g,''))||0), 0);
        
        document.getElementById('dispPaid').innerText = formatNumber(paid);
        document.getElementById('dispRemain').innerText = formatNumber(total - paid);
        let works = d.works || [];
        document.getElementById('dispProg').innerText = works.length > 0 ? works[works.length-1][2] : "0%";
    }

    window.showTab = function(t) {
        currentTab = t;
        document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).style.display = 'block';
        
        const map = {'info':0, 'payments':1, 'works':2, 'visits':3, 'history':4, 'notifs':5, 'media':6, 'settings':7};
        if(document.querySelectorAll('.tab-btn')[map[t]]) document.querySelectorAll('.tab-btn')[map[t]].classList.add('active');

        const fab = document.getElementById('fabAdd');
        fab.style.display = (isAdmin && ['payments','works','history','notifs','media'].includes(t)) ? 'flex' : 'none';
    }

    window.openModal = function() {
        const title = document.getElementById('modalTitle');
        const content = document.getElementById('modalInputs');
        const today = new Date().toLocaleDateString('en-GB');

        if (currentTab === 'payments') {
            title.innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„ÙŠØ©";
            content.innerHTML = `<label>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</label><input type="text" id="mReceipt"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="mAmount"><label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><input type="text" id="mNote"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'works') {
            title.innerText = "ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„";
            let ops=""; for(let i=5;i<=100;i+=5) ops+=`<option value="${i}">${i}%</option>`;
            content.innerHTML = `<label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="mStage"><label>Ø§Ù„Ù†Ø³Ø¨Ø©</label><select id="mPerc" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px">${ops}</select><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'history') {
             title.innerText = "Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«";
             content.innerHTML = `<label>Ø§Ù„Ø­Ø¯Ø«</label><select id="mEvent" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px"><option>ØªÙ†Ø§Ø²Ù„</option><option>Ø¨ÙŠØ¹</option><option>Ø§Ù†Ø³Ø­Ø§Ø¨</option></select><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="mNote"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'notifs') {
            title.innerText = "ØªØ¨Ù„ÙŠØº";
            content.innerHTML = `<label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label><input type="text" id="mMsg"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        } else if (currentTab === 'media') {
             title.innerText = "ÙˆØ³Ø§Ø¦Ø·";
             content.innerHTML = `<label>Ø§Ù„Ù†ÙˆØ¹</label><select id="mType" style="width:100%;margin-top:5px;border:1px solid #ddd;padding:10px;border-radius:8px"><option value="image">ØµÙˆØ±Ø©</option><option value="video">ÙÙŠØ¯ÙŠÙˆ</option></select><label>Ø§Ù„ÙˆØµÙ</label><input type="text" id="mDesc"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="mDate" value="${today}">`;
        }
        document.getElementById('actionModal').style.display = 'flex';
    }

    window.confirmModal = function() {
        const date = document.getElementById('mDate').value;
        const d = db[currentUnit];
        if (currentTab === 'payments') {
            const r = document.getElementById('mReceipt').value;
            const a = document.getElementById('mAmount').value;
            const n = document.getElementById('mNote').value;
            if(!a) return; d.payments.push([date, r||"-", formatNumber(a), n]);
        } else if (currentTab === 'works') {
            const s = document.getElementById('mStage').value;
            const p = document.getElementById('mPerc').value;
            if(!s) return; d.works.push([s, date, p+"%"]);
        } else if (currentTab === 'history') {
             d.history.push([date, document.getElementById('mEvent').value, document.getElementById('mNote').value]);
        } else if (currentTab === 'notifs') {
             d.notifs.push([date, document.getElementById('mMsg').value]);
        } else if (currentTab === 'media') {
             d.media.push({type:document.getElementById('mType').value, desc:document.getElementById('mDesc').value, date:date});
        }
        saveData();
        closeModal();
    }

    window.closeModal = () => document.getElementById('actionModal').style.display = 'none';
    
    window.delRow = function(id, i) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        if(id==='visitTable') db[currentUnit].visits.splice(i,1);
        else { const map={'payTable':'payments','workTable':'works','histTable':'history','notifTable':'notifs'}; db[currentUnit][map[id]].splice(i,1); }
        saveData();
    }

    window.goBack = function() {
        if(isAdmin) {
            document.getElementById('unitInterface').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderUnitsGrid(document.querySelector('.search-input').value);
        } else location.reload();
    }
    
    function formatNumber(n) { return n ? Number(String(n).replace(/,/g,'')).toLocaleString('en-US') : "0"; }
    
    document.addEventListener("keyup", function(event) {
        if (event.key === "Enter" && document.getElementById('loginScreen').style.display !== 'none') handleLogin();
    });
</script>
</body>
</html>