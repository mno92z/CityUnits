<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00695c; --accent: #4db6ac; --bg: #f4f6f8; --text: #37474f; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        * { box-sizing: border-box; outline: none; }
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ù„ÙˆØ¯Ø± */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary), #004d40); color: white; padding: 20px; text-align: center; }
        .login-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 400px; border: 1px solid rgba(255,255,255,0.2); }
        .inp-login { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; background: rgba(255,255,255,0.95); font-size: 16px; text-align: center; }
        .btn-login { width: 100%; padding: 15px; background: var(--accent); color: #00251a; font-weight: bold; border-radius: 10px; border: none; font-size: 18px; cursor: pointer; margin-top: 20px; }

        /* Ø§Ù„Ø´Ø¨ÙƒØ© */
        .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; padding: 15px; padding-bottom: 80px; }
        .unit-card { background: white; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative; border: 2px solid transparent; }
        .unit-card.sold { background: #e0f2f1; border-color: #80cbc4; }
        .unit-card h3 { margin: 0 0 5px 0; color: var(--primary); }

        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© */
        .unit-hero { background: var(--primary); color: white; padding: 30px 20px 40px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        .tabs-nav { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .tab-link { padding: 10px 15px; background: #eee; border-radius: 20px; border: none; cursor: pointer; white-space: nowrap; }
        .tab-link.active { background: var(--primary); color: white; }
        .tab-pane { display: none; padding: 0 20px 40px; }
        .tab-pane.show { display: block; }

        label { display: block; font-size: 13px; font-weight: bold; color: #607d8b; margin: 15px 0 5px; }
        input[readonly] { background: #f5f5f5; color: #90a4ae; }
        input { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
        td, th { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        
        .admin-only { display: none; }
        .floating-add { position: fixed; bottom: 25px; left: 25px; width: 55px; height: 55px; background: var(--accent); color: #004d40; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p style="margin-top:10px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

    <div id="loginScreen" class="screen active">
        <div class="login-card">
            <h2>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø£Ø²Ù‡Ø±</h2>
            <p style="opacity:0.8; margin-bottom:20px">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            
            <input type="text" id="userInp" class="inp-login" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©) Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©">
            <input type="password" id="passInp" class="inp-login" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="handleLogin()" class="btn-login">Ø¯Ø®ÙˆÙ„</button>
            <p id="errorMsg" style="color:#ffccbc; font-size:14px; margin-top:10px"></p>
        </div>
    </div>

    <div id="gridScreen" class="screen">
        <div class="header">
            <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
            <button onclick="logout()" style="background:#ffcdd2; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; color:#c62828">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div style="padding:15px"><input type="text" onkeyup="filterGrid(this.value)" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø©..."></div>
        <div id="unitsContainer" class="grid"></div>
    </div>

    <div id="detailScreen" class="screen">
        <div class="unit-hero">
            <div style="display:flex; justify-content:space-between;">
                <h1 style="margin:0" id="dId">...</h1>
                <button onclick="showScreen('gridScreen')" style="background:rgba(255,255,255,0.2); color:white; border:none; padding:5px 15px; border-radius:20px">Ø±Ø¬ÙˆØ¹</button>
            </div>
            <p id="dOwner" style="opacity:0.9">...</p>
        </div>

        <div class="tabs-nav">
            <button class="tab-link active" onclick="openTab('info')">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
            <button class="tab-link" onclick="openTab('finance')">Ù…Ø§Ù„ÙŠØ©</button>
            <button class="tab-link" onclick="openTab('work')">Ø¥Ù†Ø¬Ø§Ø²</button>
            <button class="tab-link admin-only" onclick="openTab('settings')">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <div id="tab-info" class="tab-pane show">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input type="text" id="infName" readonly>
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="infPhone" readonly>
            <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" id="infPrice" readonly>
            <button onclick="saveInfo()" class="btn-login admin-only" style="margin-top:20px">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>

        <div id="tab-finance" class="tab-pane">
            <h3 style="text-align:center">Ø§Ù„ÙˆØ§ØµÙ„: <span id="totalPaid">0</span></h3>
            <table><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="tblFinance"></tbody></table>
            <button onclick="addPayment()" class="floating-add admin-only">+</button>
        </div>

        <div id="tab-work" class="tab-pane">
            <table><thead><tr><th>Ù…Ø±Ø­Ù„Ø©</th><th>%</th></tr></thead><tbody id="tblWork"></tbody></table>
            <button onclick="addWork()" class="floating-add admin-only">+</button>
        </div>

        <div id="tab-settings" class="tab-pane">
            <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)</label><input type="text" id="setPass">
            <button onclick="savePass()" class="btn-login" style="margin-top:20px">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://csaqawviitdrjzeasmne.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYXFhd3ZpaXRkcmp6ZWFzbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzI0MzIsImV4cCI6MjA4MzMwODQzMn0.68PktNhQbi264YF-5uaWMr2zm5_44X7sAFXoA_wqnNQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isAdmin = false;
        let curUnit = null;
        let allUnits = [];

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        const $ = (id) => document.getElementById(id);
        const showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $(id).classList.add('active');
        };

        // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø°ÙƒÙŠ) ---
        async function handleLogin() {
            const u = $('userInp').value.trim();
            const p = $('passInp').value.trim();
            const err = $('errorMsg');
            err.innerText = '';
            
            if(!u || !p) return err.innerText = 'Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„';
            $('loader').style.display = 'flex';

            try {
                // 1. Ù‡Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„ØŸ (ÙŠØ­ØªÙˆÙŠ @) -> Ø¥Ø°Ù† Ù‡Ùˆ Ø£Ø¯Ù…Ù†
                if (u.includes('@')) {
                    const { data, error } = await supabase.auth.signInWithPassword({ email: u, password: p });
                    if (error) throw error;
                    
                    isAdmin = true;
                    await loadUnits(); // ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                } 
                // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¥ÙŠÙ…ÙŠÙ„ -> Ø¥Ø°Ù† Ù‡Ùˆ ÙˆØ­Ø¯Ø© (A1, B5...)
                else {
                    const unitId = u.toUpperCase();
                    // Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ data->settings
                    const { data: unit, error } = await supabase.from('units').select('*').eq('id', unitId).single();
                    
                    if (!unit || error) throw new Error('Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    
                    const savedPass = unit.data.settings?.pass || '123456'; // Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    if (savedPass !== p) throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£');

                    isAdmin = false;
                    openUnit(unit); // ÙØªØ­ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                    $('loader').style.display = 'none';
                }

            } catch (e) {
                err.innerText = 'Ø®Ø·Ø£: ' + (e.message || 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                $('loader').style.display = 'none';
            }
        }

        // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
        async function loadUnits() {
            const { data } = await supabase.from('units').select('*');
            allUnits = data || [];
            
            // Ø±Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©
            const c = $('unitsContainer'); c.innerHTML = '';
            // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…
            allUnits.sort((a,b) => a.id.localeCompare(b.id, undefined, {numeric:true}));
            
            allUnits.forEach(u => {
                const sold = u.data.info?.name;
                const div = document.createElement('div');
                div.className = `unit-card ${sold ? 'sold' : ''}`;
                div.innerHTML = `<h3>${u.id}</h3><small>${sold || 'Ù…ØªØ§Ø­'}</small>`;
                div.onclick = () => openUnit(u);
                c.appendChild(div);
            });

            // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø¯Ù…Ù†
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = isAdmin ? 'block' : 'none');
            
            showScreen('gridScreen');
            $('loader').style.display = 'none';
        }

        function filterGrid(txt) {
            const t = txt.toLowerCase();
            document.querySelectorAll('.unit-card').forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(t) ? 'block' : 'none';
            });
        }

        // --- Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ---
        function openUnit(u) {
            curUnit = u;
            const d = u.data;

            $('dId').innerText = u.id;
            $('dOwner').innerText = d.info?.name || 'ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²';

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            $('infName').value = d.info?.name || '';
            $('infPhone').value = d.info?.phone || '';
            $('infPrice').value = d.info?.price || '';
            $('setPass').value = d.settings?.pass || '';

            // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            renderTable('tblFinance', d.finance?.payments || []);
            renderTable('tblWork', d.work || []);

            // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
            let total = (d.finance?.payments || []).reduce((a, b) => a + Number(b.amount || 0), 0);
            $('totalPaid').innerText = total.toLocaleString();

            // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªÙÙŠØ¯)
            const fields = ['infName', 'infPhone', 'infPrice'];
            fields.forEach(f => $(f).readOnly = !isAdmin);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = isAdmin ? (e.tagName === 'BUTTON' ? 'flex' : 'block') : 'none');

            showScreen('detailScreen');
        }

        function renderTable(id, list) {
            const b = $(id); b.innerHTML = '';
            list.forEach(item => {
                // Ù‚Ø¯ ÙŠÙƒÙˆÙ† item Ù…ØµÙÙˆÙØ© Ø£Ùˆ ÙƒØ§Ø¦Ù†ØŒ Ù†Ø¹Ø§Ù„Ø¬Ù‡
                let c1 = item.date || item.stage || item[0];
                let c2 = item.amount || item.percent || item[1];
                b.innerHTML += `<tr><td>${c1}</td><td>${c2}</td></tr>`;
            });
        }

        // --- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© ---
        async function saveDB() {
            $('loader').style.display = 'flex';
            const { error } = await supabase.from('units').upsert({ id: curUnit.id, data: curUnit.data });
            $('loader').style.display = 'none';
            
            if (error) alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            else {
                alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
                if (isAdmin) loadUnits(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            }
        }

        function saveInfo() {
            if (!curUnit.data.info) curUnit.data.info = {};
            curUnit.data.info.name = $('infName').value;
            curUnit.data.info.phone = $('infPhone').value;
            curUnit.data.info.price = $('infPrice').value;
            saveDB();
        }

        function savePass() {
            if (!curUnit.data.settings) curUnit.data.settings = {};
            curUnit.data.settings.pass = $('setPass').value;
            saveDB();
        }

        function addPayment() {
            const amt = prompt('Ø§Ù„Ù…Ø¨Ù„Øº:');
            if(!amt) return;
            const date = new Date().toISOString().split('T')[0];
            
            if (!curUnit.data.finance) curUnit.data.finance = { payments: [] };
            curUnit.data.finance.payments.push({ date, amount: amt });
            saveDB();
            openUnit(curUnit); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        }

        function addWork() {
            const stage = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©:');
            const perc = prompt('Ø§Ù„Ù†Ø³Ø¨Ø© %:');
            if(!stage) return;
            
            if (!curUnit.data.work) curUnit.data.work = [];
            curUnit.data.work.push({ stage, percent: perc + '%' });
            saveDB();
            openUnit(curUnit);
        }

        function openTab(t) {
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show'));
            event.target.classList.add('active');
            $('tab-' + t).classList.add('show');
        }

        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }
    </script>
</body>
</html>